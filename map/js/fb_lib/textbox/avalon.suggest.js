define(["../avalon.getModel","text!./avalon.suggest.html","css!../chameleon/oniui-common.css","css!./avalon.suggest.css"],function(avalon,sourceHTML){function findParent(element,findElement){return element?element==findElement?!0:findParent(element.parentNode,findElement):!1}function keyDownOperation(vmodel,event,limit){switch(event.which){case 9:if(!vmodel.toggle)return;vmodel.toggle=!1;break;case 27:if(!vmodel.toggle)return;vmodel.toggle=!1;break;case 13:event.preventDefault();if(!vmodel.toggle)return;vmodel.toggle=!1;vmodel.inputElement.blur();setTimeout(function(){vmodel.onChangeCallback(vmodel.list[vmodel.selectedIndex].value,vmodel.inputElement,event,vmodel.list[vmodel.selectedIndex])},0);break;case 38:if(!vmodel.toggle)return;--vmodel.selectedIndex;limit&&vmodel.suggestCtr.moveUp(vmodel.selectedIndex);-1===vmodel.selectedIndex&&(vmodel.selectedIndex=vmodel.list.length-1);vmodel.onChangeCallback(vmodel.list[vmodel.selectedIndex].value,vmodel.inputElement,event,vmodel.list[vmodel.selectedIndex]);event.preventDefault();break;case 40:if(!vmodel.toggle)return;++vmodel.selectedIndex;limit&&vmodel.suggestCtr.moveDown(vmodel.selectedIndex);vmodel.selectedIndex===vmodel.list.length&&(vmodel.selectedIndex=0);vmodel.onChangeCallback(vmodel.list[vmodel.selectedIndex].value,vmodel.inputElement,event,vmodel.list[vmodel.selectedIndex]);event.preventDefault();break;default:var keyupFn=avalon.bind(vmodel.inputElement,"keyup",function(){vmodel.searchText=this.value||String.fromCharCode(event.which);avalon.unbind(vmodel.inputElement,"keyup",keyupFn)})}}function updateSource(value,vmodel,limit,disableLetter){if(1!=vmodel.loading){var s=avalon.ui.suggest.strategies[vmodel.strategy];if(s){vmodel.loading=!0;if(disableLetter&&disableLetter&&/[a-z]/.test(value)){vmodel.list.clear();vmodel.loading=!1}else s(value,function(array){vmodel.selectedIndex=0;vmodel.list.removeAll();avalon.each(array,function(idx,val){"string"==typeof val?vmodel.list.push({text:val,value:val}):vmodel.list.push(val)});vmodel.loading=!1;0==array.length?vmodel.toggle=!1:vmodel.toggle=!0;limit&&vmodel.suggestCtr.reset()},vmodel.inputElement)}}}function escapeRegExp(str){return str.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var widget=avalon.ui.suggest=function(element,data,vmodels){var $element=avalon(element),options=data.suggestOptions,template=options.getTemplate(sourceHTML),suggestHtml=avalon.parseHTML(template).firstChild,dataValue=data.value.split(","),suggestOptions=dataValue[2]?avalon.getModel(dataValue[2],vmodels)||0:0,styleReg=/^(\d+).*$/;suggestOptions=options.notpuresuggest?suggestOptions[1][suggestOptions[0]]:0;suggestOptions&&avalon.mix(options,suggestOptions);options.inputElement=options.notpuresuggest?options.inputElement:document.getElementById(options.inputElement);options.textboxContainer=""==options.textboxContainer?options.inputElement:options.textboxContainer;var suggest,limit=options.limit,disableLetter=options.disableLetter,suggestCtr=options.suggestCtr||{_minIndex:0,_maxIndex:limit-1,_items:"",moveUp:function(index){if(index<this._minIndex)if(0==this._minIndex){this._minIndex=vmodel.list.length-limit;this._maxIndex=vmodel.list.length-1;this._update();this.scroll.set(this._getHeight(0,this._minIndex-1))}else{this._minIndex--;this._maxIndex--;this._update();this.scroll.pre()}else this.scroll.isScolled&&this.scroll.recover()},moveDown:function(index){if(index>this._maxIndex)if(this._maxIndex==vmodel.list.length-1){this._minIndex=0;this._maxIndex=limit-1;this._update();this.scroll.set(0)}else{this._minIndex++;this._maxIndex++;this._update();this.scroll.next()}else this.scroll.isScolled&&this.scroll.recover()},reset:function(){this._minIndex=0;this._maxIndex=limit-1;suggest.scrollTop=0;this._items=suggest.getElementsByTagName("li");this._update()},scroll:{isScolled:!1,set:function(val){suggest.scrollTop=val;this.isScolled=!1},pre:function(){this.isScolled?this.recover():suggest.scrollTop-=suggestCtr._items[suggestCtr._minIndex].offsetHeight},next:function(){this.isScolled?this.recover():suggest.scrollTop+=suggestCtr._items[suggestCtr._minIndex-1].offsetHeight},recover:function(){this.set(suggestCtr._getHeight(0,suggestCtr._minIndex-1))}},_update:function(){if(vmodel.list.length>limit){suggest.style.overflowY="scroll";suggest.style.height=this._getHeight(this._minIndex,this._maxIndex)+"px"}else{suggest.style.overflowY="auto";suggest.style.height="auto"}},_getHeight:function(fromIndex,toIndex){for(var _height=0,_items=this._items,i=fromIndex;toIndex>=i;i++)_height+=_items[i].offsetHeight;return _height}},vmodel=avalon.define(data.suggestId,function(vm){avalon.mix(vm,options);vm.$skipArray=["widgetElement","puresuggest","limit","suggestCtr"];vm.widgetElement=element;vm.list=[];vm.searchText="";vm.toggle=!1;vm.loading=!1;vm.selectedIndex=0;vm.suggestCtr=suggestCtr;vm._renderItem=function(item){return item?vmodel.renderItem(item,vmodel):void 0};vm.$watch("toggle",function(v){function getOffset(el){for(var _x=0,_y=0;el&&!isNaN(el.offsetLeft)&&!isNaN(el.offsetTop);){_x+=el.offsetLeft-el.scrollLeft;_y+=el.offsetTop-el.scrollTop;el=el.offsetParent}return{top:_y,left:_x}}var inputElement=options.inputElement,textboxContainer=options.textboxContainer,$inputElement=avalon(inputElement),$textboxContainer=avalon(textboxContainer);if(v){if(textboxContainer===inputElement){var offset=$element.offset(),suggestHtmlWidth=$inputElement.width()+"px";element.style.cssText="position: absolute; left:"+offset.left+"px;top:"+offset.top+"px;";suggestHtml.style.cssText="margin:0;left:0;top:0;width:"+suggestHtmlWidth;return}suggestHtml.style.width=$textboxContainer.outerWidth()-2-avalon(suggestHtml).css("paddingLeft").replace(styleReg,"$1")-avalon(suggestHtml).css("paddingRight").replace(styleReg,"$1")+"px";var listHeight=avalon(suggestHtml).height(),offsetTop=getOffset(textboxContainer).top,inputHeight=avalon(textboxContainer).height(),windowHeihgt=avalon(window).height(),offsetBottom=windowHeihgt-offsetTop-inputHeight,exceedBottom=listHeight>offsetBottom;exceedBottom&&avalon(suggestHtml).css({top:"initial",bottom:inputHeight+3+"px"})}});vm.$watch("searchText",function(v){vmodel.updateSource(v,vmodel,limit,disableLetter)});vm.clickcallback=function(idx,event){var selectObj=vmodel.list[idx],selectValue=selectObj.value;vmodel.onChangeCallback(selectValue,vmodel.inputElement,event,selectObj);"function"==typeof vmodel.onSelectItem&&vmodel.onSelectItem.call(null,selectValue,vmodel.inputElement,event,selectObj);vmodel.toggle=!1};vm.hidepromptinfo=function(event){if(!vmodel.toggle)return!1;findParent(event.target,options.textboxContainer)||(vmodel.toggle=!1)};vm.$init=function(){avalon.bind(options.inputElement,"keydown",function(event){vmodel.keyDownOperation(vmodel,event,limit)});avalon.bind(document,"click",vm.hidepromptinfo);avalon.nextTick(function(){element.appendChild(suggestHtml);avalon.scan(element,[vmodel].concat(vmodels));suggestCtr.suggest=suggest=element.getElementsByTagName("ul")[0];avalon.bind(suggest,"scroll",function(){suggestCtr.scroll.isScolled=!0});"function"==typeof options.onInit&&options.onInit.call(element,vmodel,options,vmodels)})};vm.$remove=function(){element.innerHTML=""}});options.focus&&avalon.bind(options.inputElement,"focus",function(event){var v=this.value;vmodel.searchText==v?vmodel.updateSource(v,vmodel,limit):vmodel.searchText=v});if(options.onChange){var arr=avalon.getModel(options.onChange,vmodels),_onchange=vmodel.onChangeCallback;vmodel.onChangeCallback=function(){_onchange.apply(null,arguments);arr[1][arr[0]].apply(arr[1],arguments)}}return vmodel};widget.defaults={inputElement:"",strategy:"__getVal",textboxContainer:"",focus:!1,changed:!1,onSelectItem:"",emphasize:!0,getTemplate:function(tmp){return tmp},keyDownOperation:keyDownOperation,onChangeCallback:function(val,input){input.value=val},updateSource:updateSource,renderItem:function(item,vmodel){if(!vmodel.emphasize)return item.text;item=item.text;var query=escapeRegExp(vmodel.searchText);return item.replace(new RegExp("("+query+")","ig"),function($1,match){match.charCodeAt(0)<32&&(match=""+match.slice(1));return"<b style='color:#f55'>"+match+"</b>"})}};avalon.ui.suggest.strategies={__getVal:function(value,done){done(value?[value+"1",value+"2",value+"3",value+"4",value+"5",value+"6",value+"7",value+"8",value+"9"]:[])}};return avalon});