define(["avalon","text!./avalon.pager.html","css!../chameleon/oniui-common.css","css!./avalon.pager.css"],function(avalon,template){function efficientChangePages(aaa,bbb){for(var obj={},i=0,an=aaa.length;an>i;i++){var el=aaa[i];obj[el]={action:"del",el:el}}for(var i=0,bn=bbb.length;bn>i;i++){var el=bbb[i];obj[el]?obj[el]={action:"retain",el:el}:obj[el]={action:"add",el:el}}var scripts=[];for(var i in obj)scripts.push({action:obj[i].action,el:obj[i].el});scripts.sort(function(a,b){return a.el-b.el});scripts.forEach(function(el,index){el.index=index});for(var el,reverse=[],i=0;el=scripts[i++];)switch(el.action){case"add":aaa.splice(el.index,0,el.el);break;case"del":reverse.unshift(el)}for(var el,i=0;el=reverse[i++];)aaa.splice(el.index,1)}function getPages(vm){var c=vm.currentPage,max=Math.ceil(vm.totalItems/vm.perPages),pages=[],s=vm.showPages,left=c,right=c;vm.totalPages=max;if(s>=max)for(var i=1;max>=i;i++)pages.push(i);else{pages.push(c);for(;;){if(pages.length>=s)break;left>1&&pages.unshift(--left);if(pages.length>=s)break;max>right&&pages.push(++right)}}vm.firstPage=pages[0]||1;vm.lastPage=pages[pages.length-1]||1;vm.showFirstOmit=vm.firstPage>2;vm.showLastOmit=vm.lastPage<max-1;return pages}avalon.ui.pagerStruct={};var widget=avalon.ui.pager=function(element,data,vmodels){var options=data.pagerOptions;avalon.ui.pagerStruct=options;var pageOptions=options.options;Array.isArray(pageOptions)?options.options=pageOptions.map(function(el){var obj={};switch(typeof el){case"number":case"string":obj.value=el;obj.text=el;return obj;case"object":return el}}):options.options=[];vmodels.cb&&(template=template.replace(/ms-title/g,"ms-attr-title"));options.template=options.getTemplate(template,options);options._currentPage=options.currentPage;var vmodel=avalon.define(data.pagerId,function(vm){avalon.mix(vm,options,{regional:widget.defaultRegional});vm.widgetElement=element;vm.rootElement={};vm.$skipArray=["showPages","rootElement","widgetElement","template","ellipseText","alwaysShowPrev","alwaysShowNext"];vm.$init=function(continueScan){var pageHTML=options.template;element.style.display="none";setTimeout(function(){element.innerHTML=pageHTML;vm.rootElement=element.getElementsByTagName("*")[0];element.style.display="block";if(continueScan)continueScan();else{avalon.log("avalon请尽快升到1.3.7+");avalon.scan(element,[vmodel].concat(vmodels));"function"==typeof options.onInit&&options.onInit.call(element,vmodel,options,vmodels)}},100)};vm.$remove=function(){element.innerHTML=element.textContent=""};vm.jumpPage=function(event,page){vm.startIndex=0;event.preventDefault();var enabled=-1===this.className.indexOf("state-disabled");if(enabled&&page!==vm.currentPage){switch(page){case"first":vm.currentPage=1;break;case"last":vm.currentPage=vm.totalPages;break;case"next":vm.currentPage++;vm.currentPage>vm.totalPages&&(vm.currentPage=vm.totalPages);break;case"prev":vm.currentPage--;vm.currentPage<1&&(vm.currentPage=1);break;default:vm.currentPage=page}vm.onJump.call(element,event,vm);efficientChangePages(vm.pages,getPages(vm));if(options.useInnerRequest&&"$"!==options.parentVMId&&options.parentInterface){options.argFormat&&"function"==typeof options.argFormat&&(options.parentInterface.data=options.argFormat.call(element,options.parentInterface.data||{},vmodel.currentPage||0,vmodel.perPages||options.perPages));avalon.vmodels[options.parentVMId].changePage(options.parentInterface)}}},vm.$watch("totalItems",function(){efficientChangePages(vm.pages,getPages(vm))});vm.$watch("perPages",function(a){vm.currentPage=1;efficientChangePages(vm.pages,getPages(vm));if(options.useInnerRequest&&"$"!==options.parentVMId&&options.parentInterface){options.argFormat&&"function"==typeof options.argFormat&&(options.parentInterface.data=options.argFormat.call(element,options.parentInterface.data||{},vmodel.currentPage||0,vmodel.perPages||options.perPages));avalon.vmodels[options.parentVMId].changePage(options.parentInterface)}});vm.$watch("currentPage",function(a){vmodel._currentPage=a;efficientChangePages(vm.pages,getPages(vm))});vm.isShowPrev=function(){var a=vm.alwaysShowPrev,b=vm.firstPage;return a||1!==b};vm.isShowNext=function(){var a=vm.alwaysShowNext,b=vm.lastPage,c=vm.totalPages;return a||b!==c};vm.changeCurrentPage=function(e,value){if("keyup"===e.type){value=this.value;if(13!==e.keyCode)return}else value=vmodel._currentPage;value=parseInt(value,10)||1;if(!(value>vmodel.totalPages||1>value)){vmodel.currentPage=value;vmodel.pages=getPages(vmodel);vmodel.onJump.call(element,e,vm)}};vm.pages=[];vm.getPages=getPages;vm.setRegional=function(regional){vmodel.regional=regional};vm._getTotalPages=function(totalPages){var regional=vmodel.regional,html=[regional.totalText,totalPages];totalPages>1?html.push(regional.pagesText):html.push(regional.pageText);html=html.concat([" ",regional.jumpToText,regional.numberText]);return html.join("")};vm.getTitle=function(a,currentPage,totalPages){var regional=vmodel.regional;switch(a){case"first":return 1==currentPage?regional.currentText:regional.jumpToText+" "+regional.firstText;case"prev":return regional.jumpToText+" "+regional.prevText;case"next":return regional.jumpToText+" "+regional.nextText;case"last":return currentPage==totalPages?regional.currentText:regional.jumpToText+" "+regional.lastText;default:return a===currentPage?regional.currentText:regional.jumpToText+regional.numberText+" "+a+regional.pageText}}});vmodel.pages=getPages(vmodel);return vmodel};widget.regional=[];widget.regional["zh-CN"]={prevText:"上一页",nextText:"下一页",confirmText:"确定",totalText:"共",pagesText:"页",pageText:"页",toText:"到",jumpToText:"跳转到",currentText:"当前页",firstText:"第一页",lastText:"最后一页",numberText:"第"};widget.defaultRegional=widget.regional["zh-CN"];widget.defaults=avalon.mix({parentVMId:"$",useInnerRequest:!1,parentInterface:null,argFormat:null,perPages:10,showPages:10,currentPage:1,_currentPage:1,totalItems:200,totalPages:0,pages:[],nextText:">",prevText:"<",ellipseText:"…",firstPage:1,lastPage:0,alwaysShowNext:!1,alwaysShowPrev:!1,showFirstOmit:!1,showLastOmit:!1,showJumper:!1,getTemplate:function(tmpl,opts){return tmpl},options:[],onJump:function(e,vm){}},avalon.ui.pagerStruct);return avalon});