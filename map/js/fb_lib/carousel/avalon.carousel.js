define(["avalon","text!./avalon.carousel.html","css!./avalon.carousel.css","css!../chameleon/oniui-common.css","../avalon.fb"],function(avalon,template){var widget=avalon.ui.carousel=function(element,data,vmodels){var options=data.carouselOptions;options.template=options.getTemplate(template,options);var vmodel=avalon.define(data.carouselId,function(vm){function handleWindowResizeWidth(cantainer){cantainer.style.width=vmodel.containerWidth="100%";vmodel.pictureWidth=element.offsetWidth;addResizeEvent(function(){vmodel.pictureWidth=avalon.css(element,"width");vm.animated?vm.resizingWindow=!0:"undefined"!=typeof vm.lastIndex?vmodel.panelOffsetX=-((vm.lastIndex||0)+1)*vmodel.pictureWidth:vmodel.panelOffsetX=-(vm.lastIndex||0)*vmodel.pictureWidth})}function handleWindowResizeHeight(container){vmodel.pictureHeight=vmodel.containerHeight=container.style.height="100%";addResizeEvent(function(){vmodel.pictureHeight=avalon.css(element,"height")})}function addResizeEvent(func){window.addEventListener?window.addEventListener("resize",func,!1):window.attachEvent("onresize",func)}function Tween(eatingType,curTime,startPos,distance,duration){switch(eatingType){case"linear":return distance*curTime/duration+startPos;case"easeIn":return distance*(curTime/=duration)*curTime+startPos;case"easeOut":return-distance*(curTime/=duration)*(curTime-2)+startPos;case"easeInOut":return(curTime/=duration/2)<1?distance/2*curTime*curTime+startPos:-distance/2*(--curTime*(curTime-2)-1)+startPos}}function fixPngs(){function fixPng(src,imgObj){imgObj.src="http://7xkm02.com1.z0.glb.clouddn.com/Transparent.gif";imgObj.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled='true', src='"+src+"', sizingMethod='fixed')"}function getIEVersion(){var rv=-1;if("Microsoft Internet Explorer"==navigator.appName){var ua=navigator.userAgent,re=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");null!=re.exec(ua)&&(rv=parseFloat(RegExp.$1))}vm.ieVer=rv}"undefined"==typeof vm.ieVer&&getIEVersion();if(6===vm.ieVer)for(var i=0;i<document.images.length;i++){var s=document.images[i].src;s.indexOf(".png")>0&&fixPng(s,document.images[i])}}avalon.mix(vm,options);vm.widgetElement=element;-1!==String(vm.pictureWidth).indexOf("px")&&(vm.pictureWidth=parseInt(vm.pictureWidth,10));-1!==String(vm.pictureHeight).indexOf("px")&&(vm.pictureHeight=parseInt(vm.pictureHeight,10));vm.containerWidth=vm.pictureWidth;vm.containerHeight=vm.pictureHeight;vm.panelOffsetX=0;vm.itemPosition="relative";vm.panelPosition="absolute";vm.componentVisible=!1;vm.selections=avalon.range(vm.pictures.length);vm.currentIndex=0;vm.selectionWrapOffset=20*-vm.pictures.length/2;vm.arrowLeftSrc=vm.arrowLeftNormalSrc;vm.arrowRightSrc=vm.arrowRightNormalSrc;vm.arrowVisible=!1;vm.ieVer=void 0;vm.$skipArray=["widgetElement","template","selectionWrapOffset","animated","lastIndex","resizingWindow"];var inited;vm.$dataAjax=null;vm.setPictures=function(pictures){for(var links=[],i=0,len=pictures.length;len>i;i++){var picture=pictures[i];"undefined"!=typeof picture.href&&(links[i]={href:picture.href,title:picture.title})}vm.links=links;vm.pictures=picture;vm.pictures.push(pictures[0]);"undefined"!=typeof vm.links[0]&&vm.links.push(vm.links[0])};vm.$init=function(continueScan){if(!inited){inited=!0;var pageHTML=options.template,operationFunction=function(){element.style.display="none";element.innerHTML=pageHTML;element.style.display="block";if(options.allowSwipe){avalon.bind(element,"swipeleft",function(){vm.animate(1)});avalon.bind(element,"swiperight",function(){vm.animate(-1)})}(vm.adaptiveWidth||"100%"===vm.pictureWidth)&&handleWindowResizeWidth(element);(vm.adaptiveHeight||"100%"===vm.pictureHeight)&&handleWindowResizeHeight(element);for(var icons=[vm.arrowLeftNormalSrc,vm.arrowLeftHoverSrc,vm.arrowRightNormalSrc,vm.arrowRightHoverSrc],i=0,len=icons.length;len>i;i++)(new Image).src=icons[i];vm.setPictures(vm.pictures);for(var children=element.children,oniCarousel=null,i=0,len=children.length;len>i;i++)if("oni-carousel"===children[i].getAttribute("class")){oniCarousel=children[i];oniCarousel.style.display="block"}if("slide"!==vm.effect){vm.itemPosition="absolute";vm.panelPosition="relative"}if(continueScan)continueScan();else{avalon.log("请尽快升到avalon1.3.7+");avalon.scan(element,_vmodels);"function"==typeof options.onInit&&options.onInit.call(element,vmodel,options,vmodels)}};options["interface"]?vm.$dataAjax=fb.requestJson(avalon.mix({},options["interface"],{success:function(interfaceData){null!=options.dataFormat?vm.pictures=options.dataFormat(interfaceData):vm.pictures=interfaceData;vm.selections=avalon.range(vm.pictures.length);operationFunction();options["interface"].success&&options["interface"].success(interfaceData)}})):operationFunction()}};vm.$remove=function(){element.innerHTML=element.textContent="";vm.$dataAjax&&vm.$dataAjax.abort()};vm.mouseEnter=function(){fixPngs();vm.arrowVisible=vm.alwaysShowArrow?!0:!1;if(vm.hoverStop&&vm.autoSlide){clearTimeout(vm.timer);vm.timer=null}};vm.mouseLeave=function(target){"oni-carousel"===target.className&&(vm.arrowVisible=!1);vm.autoPlay()};vm.imgOnload=function(target,index){avalon.css(target,"display","inline");0===index&&vm.autoPlay()};vm.fadein=1;vm.fadeout=0;vm.animated=!1;vm.lastIndex=void 0;vm.resizingWindow=!1;vm.animate=function(direct,distance){function requestAnimationFrame(callback){return window.requestAnimationFrame?window.requestAnimationFrame(callback):window.setTimeout(callback,10)}var duringTime=vm.duration/10;if(!vm.animated){var picNum=vm.pictures.length-1;distance=distance||1;if("slide"===vm.effect){1===direct&&vm.panelOffsetX===-vm.pictureWidth*picNum?vm.panelOffsetX=0:-1===direct&&0===vm.panelOffsetX&&(vm.panelOffsetX=-vm.pictureWidth*picNum);var currentTime=0,startpos=vm.panelOffsetX,duringDistance=vm.pictureWidth*-direct*distance,go=function(){vm.animated=!1;if(vm.panelOffsetX<=-vm.pictureWidth*(vm.pictures.length-1)&&direct>0)vm.panelOffsetX=0;else if(vm.panelOffsetX>=0&&0>direct)vm.panelOffsetX=-vm.pictureWidth*picNum;else{if(vm.resizingWindow){startpos=-vm.lastIndex*vm.pictureWidth;duringDistance=vm.pictureWidth*-direct*distance}vm.panelOffsetX=Tween(vm.easing,currentTime,startpos,duringDistance,duringTime);if(duringTime>currentTime){currentTime+=1;requestAnimationFrame(go);vm.animated=!0}}}}else if("fade"===vm.effect)var currentTime=0,go=function(){vm.animated=!1;vm.fadein=Tween(vm.easing,currentTime,0,1,duringTime);vm.fadeout=Tween(vm.easing,currentTime,1,-1,duringTime);if(duringTime>currentTime){currentTime+=1;requestAnimationFrame(go);vm.animated=!0}};else var go=function(){vm.fadein=1;vm.fadeout=0};go();vm.lastIndex=vm.currentIndex;vm.currentIndex+=1*direct*distance;vm.currentIndex>vm.selections.length-1?vm.currentIndex=0:vm.currentIndex<0&&(vm.currentIndex=vm.selections.length-1)}};vm.getOpacity=function(index){if("slide"!==vm.effect){vm.fadein+vm.fadeout;return index===vm.currentIndex?vm.fadein:index===vm.lastIndex?vm.fadeout:0}return 1};vm.hoverIndex=0;vm.selectPic=function(index,e){vm.hoverIndex=index;if(e.type===vm.eventType||"both"===vm.eventType){var distance=vm.currentIndex-index,direct=distance>0?-1:1;"mouseenter"===e.type?setTimeout(function(){vm.animate(direct,Math.abs(distance))},300):vm.animate(direct,Math.abs(distance));if(vm.autoSlide){clearTimeout(vm.timer);vm.timer=null}if("click"!==vm.eventType)var fixIndex=setInterval(function(){if(vm.currentIndex!==vm.hoverIndex){var distance=vm.currentIndex-vm.hoverIndex,direct=distance>0?-1:1;vm.animate(direct,Math.abs(distance))}else clearInterval(fixIndex)},800)}};vm.arrowHover=function(direction){"left"===direction?vm.arrowLeftSrc=vm.arrowLeftHoverSrc:vm.arrowRightSrc=vm.arrowRightHoverSrc;fixPngs()};vm.arrowBlur=function(direction){"left"===direction?vm.arrowLeftSrc=vm.arrowLeftNormalSrc:vm.arrowRightSrc=vm.arrowRightNormalSrc;fixPngs()};vm.timer=null;vm.autoPlay=function(){function play(){vm.timer=setTimeout(function(){vm.animate(1);play()},vm.timeout)}vm.componentVisible=!0;null===vm.timer&&vm.autoSlide&&play()}});return vmodel};widget.vertion="0.0.2";widget.defaults={"interface":null,dataFormat:null,pictures:[],links:[],pictureWidth:500,pictureHeight:200,effect:"slide",easing:"easeInOut",timeout:2500,duration:300,showDescription:!1,alwaysShowArrow:!0,alwaysShowSelection:!0,autoSlide:!0,hoverStop:!0,adaptiveWidth:!1,adaptiveHeight:!1,eventType:"click",arrowLeftNormalSrc:"http://source.qunarzz.com/general/oniui/carousel/arrows-left-icon.png",arrowRightNormalSrc:"http://source.qunarzz.com/general/oniui/carousel/arrows-right-icon.png",arrowLeftHoverSrc:"http://source.qunarzz.com/general/oniui/carousel/arrows-left-hover-icon.png",arrowRightHoverSrc:"http://source.qunarzz.com/general/oniui/carousel/arrows-right-hover-icon.png",lazyload:!0,lazyloadImg:"http://t.cn/RLXSMrg",onInit:avalon.noop,getTemplate:function(tmpl,opts,tplName){return tmpl},$author:"heiwu805@hotmail.com",allowSwipe:!1}});