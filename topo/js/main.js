function mouseWheel(e){var nodes=topologic.TopologicalNode.pool,symbol=e.wheelDelta>0?1:-1;viewPoint.toZ+=80*symbol;if(nodes&&(exportRoot.smallerAble||symbol>0))for(var i=0;i<nodes.length;i++){nodes[i].nodeState="resize";nodes[i].toX=.1*symbol*(nodes[i].x-e.clientX)+nodes[i].x;nodes[i].toY=.1*symbol*(nodes[i].y-e.clientY)+nodes[i].y;nodes[i].SLT.x=(.1*symbol*(nodes[i].x-e.clientX)+nodes[i].x)/10;nodes[i].SLT.y=(.1*symbol*(nodes[i].y-e.clientY)+nodes[i].y)/10}}function mouseDown(e,elem){elem.className="grabbing";var cursor=window.getComputedStyle?window.getComputedStyle(document.getElementById("canvas"),null).cursor:document.getElementById("canvas").currentStyle.cursor;if("pointer"!==cursor&&"move"!==cursor){exportRoot.offsetX=e.clientX;exportRoot.offsetY=e.clientY}}function mouseMove(e){var canvas=e.currentTarget;if(exportRoot){if(exportRoot.offsetX&&exportRoot.offsetY){exportRoot.toX=exportRoot.toX+(e.clientX-exportRoot.offsetX);exportRoot.toY=exportRoot.toY+(e.clientY-exportRoot.offsetY);exportRoot.offsetX=e.clientX;exportRoot.offsetY=e.clientY}else exportRoot.offsetScreenX=-1*(e.clientX-canvas.width/2)*260/canvas.width;var distance=Math.sqrt((e.clientX-rotateCenter.x)*(e.clientX-rotateCenter.x)+(e.clientY-rotateCenter.y)*(e.clientY-rotateCenter.y)+stage.canvas.width*stage.canvas.width/4);viewPoint.toX=stage.canvas.width/2+(e.clientX-stage.canvas.width/2)*stage.canvas.width/2/distance;viewPoint.toY=stage.canvas.height/2+(e.clientY-stage.canvas.height/2)*stage.canvas.width/2/distance;viewPoint.toZ=stage.canvas.width/2-stage.canvas.width/2*stage.canvas.width/2/distance}}function mouseUp(e,elem){elem.className="grab";delete exportRoot.offsetX;delete exportRoot.offsetY}function switchBar(){showBar=!showBar;targetBarTop=showBar?100:document.documentElement.clientHeight}require.config({baseUrl:"js",paths:{avalon:"fb_lib/avalon.shim",echarts:"fb_lib/echarts",domReady:"fb_lib/domReady",LoadQueue:"lib/preloadjs-0.6.2.min"},map:{"*":{css:"fb_lib/require.css",text:"fb_lib/require.text"}},shim:{avalon:{exports:"avalon"},echarts:{exports:"echarts"},LoadQueue:{exports:createjs.LoadQueue}}});var canvas,stage,exportRoot,myChart,oldHeight=window.screen.height-100,oldWidth=window.screen.width,position=new Array,showBar=!1,targetBarTop=document.documentElement.clientHeight,oldBarDataJSON,oldTopologicDataJSON;require(["project.core","LoadQueue","echarts/echarts","topologicalDiagram"],function(fb,LoadQueue,echarts){function drawSky(starg,stars){starg.clear();starg.beginFill("rgba(255,255,255,0.6)");for(var plant={x:rotateCenter.x-viewPoint.x,y:rotateCenter.y-viewPoint.y,z:rotateCenter.z-viewPoint.z,n:-viewPoint.x*(rotateCenter.x-viewPoint.x)-viewPoint.y*(rotateCenter.y-viewPoint.y)-viewPoint.z*(rotateCenter.z-viewPoint.z)},i=0;i<stars.length;i++){var star=stars[i];reflectX=star.x-plant.x*(plant.x*star.x+plant.y*star.y+plant.z*star.z+plant.n)/(plant.x*plant.x+plant.y*plant.y+plant.z*plant.z);reflectY=star.y-plant.y*(plant.x*star.x+plant.y*star.y+plant.z*star.z+plant.n)/(plant.x*plant.x+plant.y*plant.y+plant.z*plant.z);reflectZ=star.z-plant.z*(plant.x*star.x+plant.y*star.y+plant.z*star.z+plant.n)/(plant.x*plant.x+plant.y*plant.y+plant.z*plant.z);var distance=Math.sqrt((reflectX-star.x)*(reflectX-star.x)+(reflectY-star.y)*(reflectY-star.y)+(reflectZ-star.z)*(reflectZ-star.z)),distanceX=Math.sqrt((reflectX-viewPoint.x)*(reflectX-viewPoint.x)),distanceY=Math.sqrt((reflectY-viewPoint.y)*(reflectY-viewPoint.y));reflectX<=viewPoint.x?reflectX=stage.canvas.width/2-distanceX:reflectX=stage.canvas.width/2+distanceX;reflectY<=viewPoint.y?reflectY=stage.canvas.height/2-distanceY:reflectY=stage.canvas.height/2+distanceY;var rate;rate=distance>0?distance:1;starg.moveTo(reflectX,reflectY);starg.drawCircle(reflectX,reflectY,5*rate/stage.canvas.width)}}function resizeCanvas(){showBar||(targetBarTop=document.body.scrollHeight);document.getElementById("analysis").style.top=targetBarTop+"px";document.getElementById("analysis").style.display="block";myChart&&myChart.resize();var docWidth=document.body.clientWidth>1122?document.body.clientWidth:1122,docHeight=document.body.clientHeight,canvasWidth=docWidth,canvasHeight=docHeight-100;DOC.getElementById("canvas").width=canvasWidth;DOC.getElementById("canvas").height=canvasHeight;scaleY=canvasHeight/oldHeight;scaleX=canvasWidth/oldWidth;oldWidth=canvasWidth;oldHeight=canvasHeight;var nodes=topologic.TopologicalNode.pool;if(nodes)for(var i=0;i<nodes.length;i++){nodes[i].nodeState="resize";nodes[i].toX=scaleX*nodes[i].x;nodes[i].toY=scaleY*nodes[i].y}}function init(data){resizeCanvas();window.onresize=resizeCanvas;canvas=document.getElementById("canvas");stage=new createjs.Stage(canvas);viewPoint={x:stage.canvas.width/2,y:stage.canvas.height/2,z:0};rotateCenter={x:stage.canvas.width/2,y:stage.canvas.height/2,z:stage.canvas.width/2};for(var stars=new Array,i=0;30>i;i++)stars.push({x:Math.random()*stage.canvas.width,y:Math.random()*stage.canvas.height,z:stage.canvas.width/2*Math.random()});var starg=new createjs.Graphics;stage.addChild((new createjs.Container).addChild(new createjs.Shape(starg)));drawSky(starg,stars);exportRoot=new topologic.TopologicalDiagram(transform(data));stage.addChild(exportRoot);var SLT=new createjs.Container,g=new createjs.Graphics;g.setStrokeStyle(1);g.beginStroke("red");g.drawRect(0,0,canvas.width/10,canvas.height/10);SLT.addChild(new createjs.Shape(g));SLT.addChild(exportRoot.SLT);stage.enableMouseOver(10);stage.update();createjs.Ticker.setFPS(topologic.properties.fps);createjs.Ticker.addEventListener("tick",stage);createjs.Ticker.addEventListener("tick",function(e){if(viewPoint.toX){viewPoint.x=viewPoint.x+.08*(viewPoint.toX-viewPoint.x);viewPoint.y=viewPoint.y+.08*(viewPoint.toY-viewPoint.y);viewPoint.z=viewPoint.z+.08*(viewPoint.toZ-viewPoint.z);drawSky(starg,stars)}if(!exportRoot.toX){exportRoot.toX=exportRoot.x;exportRoot.toY=exportRoot.y}if(Math.abs(exportRoot.x-exportRoot.toX)>.1,!0){exportRoot.x+=.1*(exportRoot.toX+(exportRoot.offsetScreenX?exportRoot.offsetScreenX:0)-exportRoot.x);exportRoot.y+=.1*(exportRoot.toY+(exportRoot.offsetScreenY?exportRoot.offsetScreenY:0)-exportRoot.y);exportRoot.SLT.x+=(exportRoot.toX+(exportRoot.offsetScreenX?exportRoot.offsetScreenX:0)-exportRoot.x)/100;exportRoot.SLT.y+=(exportRoot.toY+(exportRoot.offsetScreenY?exportRoot.offsetScreenY:0)-exportRoot.y)/100}if(topologic.TopologicalNode.pool)for(var i=0,il=topologic.TopologicalNode.pool.length;il>i;i++){var node=topologic.TopologicalNode.pool[i];if(node.parent){var childFinish=!0;node.nodeChildren&&(childFinish=(node.nodeChildren||[]).every(function(i){return"stay"===topologic.TopologicalNode.pool[i].nodeState?!0:!1}));if("hide"===node.nodeState&&childFinish||"show"===node.nodeState&&"stay"===topologic.TopologicalNode.pool[node.nodeParent].nodeState){if("show"===node.nodeState&&!node.visible){node.x=topologic.TopologicalNode.pool[node.nodeParent].x;node.y=topologic.TopologicalNode.pool[node.nodeParent].y;node.visible=!0}Math.abs(topologic.TopologicalNode.pool[node.nodeParent].y-node.toY)>Math.abs(topologic.TopologicalNode.pool[node.nodeParent].x-node.toX)&&"show"===node.nodeState?Math.abs(node.y-node.toY)>.1?node.y+=.25*(node.toY-node.y):node.x+=.25*(node.toX-node.x):Math.abs(node.x-node.toX)>.1?node.x+=.25*(node.toX-node.x):node.y+=.25*(node.toY-node.y);exportRoot.drawLine()}else if("drag"===node.nodeState){node.x=node.toX;node.y=node.toY;exportRoot.drawLine();node.nodeState="stay"}else if("init"===node.nodeState){node.y+=.25*(node.toY-node.y);node.x+=.25*(node.toX-node.x);exportRoot.drawLine()}else if("resize"===node.nodeState){node.y+=.25*(node.toY-node.y);node.x+=.25*(node.toX-node.x);exportRoot.drawLine()}if(Math.abs(node.x-node.toX)<.1&&Math.abs(node.y-node.toY)<.1){"hide"===node.nodeState&&(node.visible=!1);"hide"===node.nodeState&&!childFinish||"show"===node.nodeState&&"stay"!==topologic.TopologicalNode.pool[node.nodeParent].nodeState||(node.nodeState="stay")}}}var barTop=document.getElementById("analysis").style.top.replace("px","");Math.abs(barTop-targetBarTop)>.1&&(document.getElementById("analysis").style.top=1*barTop+.08*(targetBarTop-barTop)+"px")})}function transform(data){for(var i=0;i<data.length;i++)!function(d,parent){for(var m=0;m<position.length;m++)if(JSON.stringify(d)===position[m].obj){d.x=position[m].x;d.y=position[m].y;if(d.children&&d.children.length>0)for(var j=0;j<d.children.length;j++)arguments.callee(d.children[j],d);return}if(void 0===parent){var point={};point.obj=JSON.stringify(d);d.x=stage.canvas.width/2-35;d.y=stage.canvas.height/2-35;point.x=d.x;point.y=d.y;position.push(point);d.tport=0}else{parent.taken==parent.tport&&(parent.tport=parent.tport+1);if(parent.tport%4==0){var point={};point.obj=JSON.stringify(d);d.x=parent.x+180*(document.body.clientWidth/window.screen.width);Math.round(parent.tport/4)>0?d.y=parent.y+180*(Math.round(parent.tport/4)-Math.round(parent.children.length/2))*(document.body.clientHeight/window.screen.height):d.y=parent.y;point.x=d.x;point.y=d.y;position.push(point);d.taken=1}else if(parent.tport%4==1){var point={};point.obj=JSON.stringify(d);d.x=parent.x-180*(document.body.clientWidth/window.screen.width);Math.round(parent.tport/4)>0?d.y=parent.y+180*(Math.round(parent.tport/4)-Math.round(parent.children.length/2))*(document.body.clientHeight/window.screen.height):d.y=parent.y;point.x=d.x;point.y=d.y;position.push(point);d.taken=0}else if(parent.tport%4==2){var point={};point.obj=JSON.stringify(d);Math.round(parent.tport/4)>0?d.x=parent.x+180*(Math.round(parent.tport/4)-Math.round(parent.children.length/2))*(document.body.clientWidth/window.screen.width):d.x=parent.x;d.y=parent.y+180*(document.body.clientHeight/window.screen.height);point.x=d.x;point.y=d.y;position.push(point);d.taken=3}else if(parent.tport%4==3){var point={};point.obj=JSON.stringify(d);Math.round(parent.tport/4)>0?d.x=parent.x+180*(Math.round(parent.tport/4)-Math.round(parent.children.length/2))*(document.body.clientWidth/window.screen.width):d.x=parent.x;d.y=parent.y-180*(document.body.clientHeight/window.screen.height);point.x=d.x;point.y=d.y;position.push(point);d.taken=2}d.tport=0;parent.tport=parent.tport+1}if(d.children&&d.children.length>0)for(var j=0;j<d.children.length;j++)arguments.callee(d.children[j],d)}(data[i]);return data}var vm=avalon.define({$id:"main",userNum:0,runTime:0,station:"正常",requests:1e3,showTop:!1});avalon.scan();var queue=new createjs.LoadQueue(!0);queue.loadFile({id:"init",src:"models/data.json",type:createjs.AbstractLoader.JSON});queue.loadFile({id:"tongji",src:"models/tongji.json",type:createjs.AbstractLoader.JSON});queue.loadFile({id:"chart",src:"models/chart.json",type:createjs.AbstractLoader.JSON});window.setInterval(function(){queue.loadFile({src:"models/data.json",type:createjs.AbstractLoader.JSON});queue.loadFile({id:"tongji",src:"models/tongji.json",type:createjs.AbstractLoader.JSON});queue.loadFile({id:"chart",src:"models/chart.json",type:createjs.AbstractLoader.JSON});if(0!==vm.runTime){var time=vm.runTime.match(/[0-9]+/g);if("59"==time[2]){time[2]="00";if("59"==time[1]){time[1]="00";time[0]=1*time[0]+1<10?"0"+(1*time[0]+1):1*time[0]+1}else time[1]=1*time[1]+1<10?"0"+(1*time[1]+1):1*time[1]+1}else time[2]=1*time[2]+1<10?"0"+(1*time[2]+1):1*time[2]+1;vm.runTime=time[0]+":"+time[1]+":"+time[2]}},1e3);var isInit=!0;queue.on("fileload",function(event){if("tongji"===event.item.id){DOC.querySelector(".top").style.display="block";vm.userNum=event.result.userNum;0==vm.runTime&&(vm.runTime=event.result.runTime);vm.station=event.result.station;vm.requests=event.result.requests}else if("chart"==event.item.id){if(JSON.stringify(event.result)===oldBarDataJSON)return;var arr=new Array;for(key in event.result)arr.push(event.result[key]);oldBarDataJSON=JSON.stringify(event.result);require(["echarts/chart/bar"],function(){myChart=echarts.init(document.getElementById("main"));var option={title:{x:50,y:"top",text:"流量统计",textStyle:{color:"#fff",fontFamily:"宋体",fontSize:22,fontWeight:"normal"}},tooltip:{trigger:"item",showDelay:0,hideDelay:50,transitionDuration:0,borderColor:"#333",borderRadius:8,borderWidth:0,padding:10,textStyle:{color:"#93ecff",decoration:"none",fontFamily:"宋体",fontSize:18,fontStyle:"normal",fontWeight:"normal"}},grid:{borderWidth:1,borderColor:"#3c436f",y:80,y2:60},xAxis:[{type:"category",show:!0,data:["电信","移动","联通","防火墙","公安网","vpn流量","成都市局","信息中心","安讯机房"],axisLine:{show:!0,lineStyle:{color:"#0cd4ff",type:"solid",width:2}},axisLabel:{show:!0,interval:"auto",rotate:0,margin:8,textStyle:{color:"#fff",fontFamily:"宋体",fontSize:18,fontStyle:"normal",fontWeight:"normal"}},splitLine:{show:!0,lineStyle:{color:"#3c436f",type:"solid",width:1}},axisTick:{show:!1}}],yAxis:[{type:"value",show:!0,axisLine:{show:!0,lineStyle:{color:"#0cd4ff",type:"solid",width:2}},splitLine:{show:!0,lineStyle:{color:"#282f5e",type:"solid",width:1}},axisLabel:{textStyle:{color:"#fff",fontSize:18}}}],series:[{name:"流量统计",type:"bar",itemStyle:{normal:{color:function(params){var colorList=["#3cd7f9","#ff9201","#fdc913","#6bb413","#fe8463","#1ca1b1","#e87c25","#fcce10","#b5c334"];return colorList[params.dataIndex]},barBorderRadius:[10,10,0,0]},emphasis:{barBorderRadius:[10,10,0,0]}},data:arr}]};myChart.setOption(option)})}else{if(JSON.stringify(event.result)===oldTopologicDataJSON)return;oldTopologicDataJSON=JSON.stringify(event.result);if(isInit){isInit=!1;init(event.result.data);topologic.keepCenter(stage.canvas.width,stage.canvas.height);topologic.TopologicalNode.pool[0].visible=!0;topologic.TopologicalNode.pool[0].x=topologic.TopologicalNode.pool[0].toX;topologic.TopologicalNode.pool[0].y=topologic.TopologicalNode.pool[0].toY;for(var i=1;i<topologic.TopologicalNode.pool.length;i++){topologic.TopologicalNode.pool[i].visible=!1;topologic.TopologicalNode.pool[i].nodeState="show"}}else{resizeCanvas();exportRoot.reloadData(transform(event.result.data));topologic.keepCenter(stage.canvas.width,stage.canvas.height);for(var i=0;i<topologic.TopologicalNode.pool.length;i++){topologic.TopologicalNode.pool[i].x=topologic.TopologicalNode.pool[i].ox||topologic.TopologicalNode.pool[i].toX;topologic.TopologicalNode.pool[i].y=topologic.TopologicalNode.pool[i].oy||topologic.TopologicalNode.pool[i].toY}}}},this)});