define(["require","./util","./curve"],function(require){"use strict";function normalizeRadian(angle){angle%=PI2;0>angle&&(angle+=PI2);return angle}function isInside(shape,area,x,y){if(!area||!shape)return!1;var zoneType=shape.type;_ctx=_ctx||util.getContext();var _mathReturn=_mathMethod(shape,area,x,y);if("undefined"!=typeof _mathReturn)return _mathReturn;if(shape.buildPath&&_ctx.isPointInPath)return _buildPathMethod(shape,_ctx,area,x,y);switch(zoneType){case"ellipse":return!0;case"trochoid":var _r="out"==area.location?area.r1+area.r2+area.d:area.r1-area.r2+area.d;return isInsideCircle(area,x,y,_r);case"rose":return isInsideCircle(area,x,y,area.maxr);default:return!1}}function _mathMethod(shape,area,x,y){var zoneType=shape.type;switch(zoneType){case"bezier-curve":return"undefined"==typeof area.cpX2?isInsideQuadraticStroke(area.xStart,area.yStart,area.cpX1,area.cpY1,area.xEnd,area.yEnd,area.lineWidth,x,y):isInsideCubicStroke(area.xStart,area.yStart,area.cpX1,area.cpY1,area.cpX2,area.cpY2,area.xEnd,area.yEnd,area.lineWidth,x,y);case"line":return isInsideLine(area.xStart,area.yStart,area.xEnd,area.yEnd,area.lineWidth,x,y);case"polyline":return isInsidePolyline(area.pointList,area.lineWidth,x,y);case"ring":return isInsideRing(area.x,area.y,area.r0,area.r,x,y);case"circle":return isInsideCircle(area.x,area.y,area.r,x,y);case"sector":var startAngle=area.startAngle*Math.PI/180,endAngle=area.endAngle*Math.PI/180;if(!area.clockWise){startAngle=-startAngle;endAngle=-endAngle}return isInsideSector(area.x,area.y,area.r0,area.r,startAngle,endAngle,!area.clockWise,x,y);case"path":return area.pathArray&&isInsidePath(area.pathArray,Math.max(area.lineWidth,5),area.brushType,x,y);case"polygon":case"star":case"isogon":return isInsidePolygon(area.pointList,x,y);case"text":var rect=area.__rect||shape.getRect(area);return isInsideRect(rect.x,rect.y,rect.width,rect.height,x,y);case"rectangle":case"image":return isInsideRect(area.x,area.y,area.width,area.height,x,y)}}function _buildPathMethod(shape,context,area,x,y){context.beginPath();shape.buildPath(context,area);context.closePath();return context.isPointInPath(x,y)}function isOutside(shape,area,x,y){return!isInside(shape,area,x,y)}function isInsideLine(x0,y0,x1,y1,lineWidth,x,y){if(0===lineWidth)return!1;var _l=Math.max(lineWidth,5),_a=0,_b=x0;if(y>y0+_l&&y>y1+_l||y0-_l>y&&y1-_l>y||x>x0+_l&&x>x1+_l||x0-_l>x&&x1-_l>x)return!1;if(x0===x1)return Math.abs(x-x0)<=_l/2;_a=(y0-y1)/(x0-x1);_b=(x0*y1-x1*y0)/(x0-x1);var tmp=_a*x-y+_b,_s=tmp*tmp/(_a*_a+1);return _l/2*_l/2>=_s}function isInsideCubicStroke(x0,y0,x1,y1,x2,y2,x3,y3,lineWidth,x,y){if(0===lineWidth)return!1;var _l=Math.max(lineWidth,5);if(y>y0+_l&&y>y1+_l&&y>y2+_l&&y>y3+_l||y0-_l>y&&y1-_l>y&&y2-_l>y&&y3-_l>y||x>x0+_l&&x>x1+_l&&x>x2+_l&&x>x3+_l||x0-_l>x&&x1-_l>x&&x2-_l>x&&x3-_l>x)return!1;var d=curve.cubicProjectPoint(x0,y0,x1,y1,x2,y2,x3,y3,x,y,null);return _l/2>=d}function isInsideQuadraticStroke(x0,y0,x1,y1,x2,y2,lineWidth,x,y){if(0===lineWidth)return!1;var _l=Math.max(lineWidth,5);if(y>y0+_l&&y>y1+_l&&y>y2+_l||y0-_l>y&&y1-_l>y&&y2-_l>y||x>x0+_l&&x>x1+_l&&x>x2+_l||x0-_l>x&&x1-_l>x&&x2-_l>x)return!1;var d=curve.quadraticProjectPoint(x0,y0,x1,y1,x2,y2,x,y,null);return _l/2>=d}function isInsideArcStroke(cx,cy,r,startAngle,endAngle,anticlockwise,lineWidth,x,y){if(0===lineWidth)return!1;var _l=Math.max(lineWidth,5);x-=cx;y-=cy;var d=Math.sqrt(x*x+y*y);if(d-_l>r||r>d+_l)return!1;if(Math.abs(startAngle-endAngle)>=PI2)return!0;if(anticlockwise){var tmp=startAngle;startAngle=normalizeRadian(endAngle);endAngle=normalizeRadian(tmp)}else{startAngle=normalizeRadian(startAngle);endAngle=normalizeRadian(endAngle)}startAngle>endAngle&&(endAngle+=PI2);var angle=Math.atan2(y,x);0>angle&&(angle+=PI2);return angle>=startAngle&&endAngle>=angle||angle+PI2>=startAngle&&endAngle>=angle+PI2}function isInsidePolyline(points,lineWidth,x,y){for(var lineWidth=Math.max(lineWidth,10),i=0,l=points.length-1;l>i;i++){var x0=points[i][0],y0=points[i][1],x1=points[i+1][0],y1=points[i+1][1];if(isInsideLine(x0,y0,x1,y1,lineWidth,x,y))return!0}return!1}function isInsideRing(cx,cy,r0,r,x,y){var d=(x-cx)*(x-cx)+(y-cy)*(y-cy);return r*r>d&&d>r0*r0}function isInsideRect(x0,y0,width,height,x,y){return x>=x0&&x0+width>=x&&y>=y0&&y0+height>=y}function isInsideCircle(x0,y0,r,x,y){return r*r>(x-x0)*(x-x0)+(y-y0)*(y-y0)}function isInsideSector(cx,cy,r0,r,startAngle,endAngle,anticlockwise,x,y){return isInsideArcStroke(cx,cy,(r0+r)/2,startAngle,endAngle,anticlockwise,r-r0,x,y)}function isInsidePolygon(points,x,y){for(var N=points.length,w=0,i=0,j=N-1;N>i;i++){var x0=points[j][0],y0=points[j][1],x1=points[i][0],y1=points[i][1];w+=windingLine(x0,y0,x1,y1,x,y);j=i}return 0!==w}function windingLine(x0,y0,x1,y1,x,y){if(y>y0&&y>y1||y0>y&&y1>y)return 0;if(y1==y0)return 0;var dir=y0>y1?1:-1,t=(y-y0)/(y1-y0),x_=t*(x1-x0)+x0;return x_>x?dir:0}function swapExtrema(){var tmp=extrema[0];extrema[0]=extrema[1];extrema[1]=tmp}function windingCubic(x0,y0,x1,y1,x2,y2,x3,y3,x,y){if(y>y0&&y>y1&&y>y2&&y>y3||y0>y&&y1>y&&y2>y&&y3>y)return 0;var nRoots=curve.cubicRootAt(y0,y1,y2,y3,y,roots);if(0===nRoots)return 0;for(var y0_,y1_,w=0,nExtrema=-1,i=0;nRoots>i;i++){var t=roots[i],x_=curve.cubicAt(x0,x1,x2,x3,t);if(!(x>x_)){if(0>nExtrema){nExtrema=curve.cubicExtrema(y0,y1,y2,y3,extrema);extrema[1]<extrema[0]&&nExtrema>1&&swapExtrema();y0_=curve.cubicAt(y0,y1,y2,y3,extrema[0]);nExtrema>1&&(y1_=curve.cubicAt(y0,y1,y2,y3,extrema[1]))}w+=2==nExtrema?t<extrema[0]?y0>y0_?1:-1:t<extrema[1]?y0_>y1_?1:-1:y1_>y3?1:-1:t<extrema[0]?y0>y0_?1:-1:y0_>y3?1:-1}}return w}function windingQuadratic(x0,y0,x1,y1,x2,y2,x,y){if(y>y0&&y>y1&&y>y2||y0>y&&y1>y&&y2>y)return 0;var nRoots=curve.quadraticRootAt(y0,y1,y2,y,roots);if(0===nRoots)return 0;var t=curve.quadraticExtremum(y0,y1,y2);if(t>=0&&1>=t){for(var w=0,y_=curve.quadraticAt(y0,y1,y2,t),i=0;nRoots>i;i++){var x_=curve.quadraticAt(x0,x1,x2,roots[i]);x>x_||(w+=roots[i]<t?y0>y_?1:-1:y_>y2?1:-1)}return w}var x_=curve.quadraticAt(x0,x1,x2,roots[0]);return x>x_?0:y0>y2?1:-1}function windingArc(cx,cy,r,startAngle,endAngle,anticlockwise,x,y){y-=cy;if(y>r||-r>y)return 0;var tmp=Math.sqrt(r*r-y*y);roots[0]=-tmp;roots[1]=tmp;if(Math.abs(startAngle-endAngle)>=PI2){startAngle=0;endAngle=PI2;var dir=anticlockwise?1:-1;return x>=roots[0]+cx&&x<=roots[1]+cx?dir:0}if(anticlockwise){var tmp=startAngle;startAngle=normalizeRadian(endAngle);endAngle=normalizeRadian(tmp)}else{startAngle=normalizeRadian(startAngle);endAngle=normalizeRadian(endAngle)}startAngle>endAngle&&(endAngle+=PI2);for(var w=0,i=0;2>i;i++){var x_=roots[i];if(x_+cx>x){var angle=Math.atan2(y,x_),dir=anticlockwise?1:-1;0>angle&&(angle=PI2+angle);if(angle>=startAngle&&endAngle>=angle||angle+PI2>=startAngle&&endAngle>=angle+PI2){angle>Math.PI/2&&angle<1.5*Math.PI&&(dir=-dir);w+=dir}}}return w}function isInsidePath(pathArray,lineWidth,brushType,x,y){var w=0,xi=0,yi=0,x0=0,y0=0,beginSubpath=!0,firstCmd=!0;brushType=brushType||"fill";for(var hasStroke="stroke"===brushType||"both"===brushType,hasFill="fill"===brushType||"both"===brushType,i=0;i<pathArray.length;i++){var seg=pathArray[i],p=seg.points;if(beginSubpath||"M"===seg.command){if(i>0){hasFill&&(w+=windingLine(xi,yi,x0,y0,x,y));if(0!==w)return!0}x0=p[p.length-2];y0=p[p.length-1];beginSubpath=!1;if(firstCmd&&"A"!==seg.command){firstCmd=!1;xi=x0;yi=y0}}switch(seg.command){case"M":xi=p[0];yi=p[1];break;case"L":if(hasStroke&&isInsideLine(xi,yi,p[0],p[1],lineWidth,x,y))return!0;hasFill&&(w+=windingLine(xi,yi,p[0],p[1],x,y));xi=p[0];yi=p[1];break;case"C":if(hasStroke&&isInsideCubicStroke(xi,yi,p[0],p[1],p[2],p[3],p[4],p[5],lineWidth,x,y))return!0;hasFill&&(w+=windingCubic(xi,yi,p[0],p[1],p[2],p[3],p[4],p[5],x,y));xi=p[4];yi=p[5];break;case"Q":if(hasStroke&&isInsideQuadraticStroke(xi,yi,p[0],p[1],p[2],p[3],lineWidth,x,y))return!0;hasFill&&(w+=windingQuadratic(xi,yi,p[0],p[1],p[2],p[3],x,y));xi=p[2];yi=p[3];break;case"A":var cx=p[0],cy=p[1],rx=p[2],ry=p[3],theta=p[4],dTheta=p[5],x1=Math.cos(theta)*rx+cx,y1=Math.sin(theta)*ry+cy;if(firstCmd){firstCmd=!1;x0=x1;y0=y1}else w+=windingLine(xi,yi,x1,y1);var _x=(x-cx)*ry/rx+cx;if(hasStroke&&isInsideArcStroke(cx,cy,ry,theta,theta+dTheta,1-p[7],lineWidth,_x,y))return!0;hasFill&&(w+=windingArc(cx,cy,ry,theta,theta+dTheta,1-p[7],_x,y));xi=Math.cos(theta+dTheta)*rx+cx;yi=Math.sin(theta+dTheta)*ry+cy;break;case"z":if(hasStroke&&isInsideLine(xi,yi,x0,y0,lineWidth,x,y))return!0;beginSubpath=!0}}hasFill&&(w+=windingLine(xi,yi,x0,y0,x,y));return 0!==w}function getTextWidth(text,textFont){var key=text+":"+textFont;if(_textWidthCache[key])return _textWidthCache[key];_ctx=_ctx||util.getContext();_ctx.save();textFont&&(_ctx.font=textFont);text=(text+"").split("\n");for(var width=0,i=0,l=text.length;l>i;i++)width=Math.max(_ctx.measureText(text[i]).width,width);_ctx.restore();_textWidthCache[key]=width;if(++_textWidthCacheCounter>TEXT_CACHE_MAX){_textWidthCacheCounter=0;_textWidthCache={}}return width}function getTextHeight(text,textFont){var key=text+":"+textFont;if(_textHeightCache[key])return _textHeightCache[key];_ctx=_ctx||util.getContext();_ctx.save();textFont&&(_ctx.font=textFont);text=(text+"").split("\n");var height=(_ctx.measureText("å›½").width+2)*text.length;_ctx.restore();_textHeightCache[key]=height;if(++_textHeightCacheCounter>TEXT_CACHE_MAX){_textHeightCacheCounter=0;_textHeightCache={}}return height}var _ctx,util=require("./util"),curve=require("./curve"),_textWidthCache={},_textHeightCache={},_textWidthCacheCounter=0,_textHeightCacheCounter=0,TEXT_CACHE_MAX=5e3,PI2=2*Math.PI,roots=[-1,-1,-1],extrema=[-1,-1];return{isInside:isInside,isOutside:isOutside,getTextWidth:getTextWidth,getTextHeight:getTextHeight,isInsidePath:isInsidePath,isInsidePolygon:isInsidePolygon,isInsideSector:isInsideSector,isInsideCircle:isInsideCircle,isInsideLine:isInsideLine,isInsideRect:isInsideRect,isInsidePolyline:isInsidePolyline,isInsideCubicStroke:isInsideCubicStroke,isInsideQuadraticStroke:isInsideQuadraticStroke}});