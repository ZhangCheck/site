define(["require","./tool/guid","./tool/util","./mixin/Transformable","./mixin/Eventful"],function(require){var guid=require("./tool/guid"),util=require("./tool/util"),Transformable=require("./mixin/Transformable"),Eventful=require("./mixin/Eventful"),Group=function(options){options=options||{};this.id=options.id||guid();for(var key in options)this[key]=options[key];this.type="group";this.clipShape=null;this._children=[];this._storage=null;this.__dirty=!0;Transformable.call(this);Eventful.call(this)};Group.prototype.ignore=!1;Group.prototype.children=function(){return this._children.slice()};Group.prototype.childAt=function(idx){return this._children[idx]};Group.prototype.addChild=function(child){if(child!=this&&child.parent!=this){child.parent&&child.parent.removeChild(child);this._children.push(child);child.parent=this;if(this._storage&&this._storage!==child._storage){this._storage.addToMap(child);child instanceof Group&&child.addChildrenToStorage(this._storage)}}};Group.prototype.removeChild=function(child){var idx=util.indexOf(this._children,child);idx>=0&&this._children.splice(idx,1);child.parent=null;if(this._storage){this._storage.delFromMap(child.id);child instanceof Group&&child.delChildrenFromStorage(this._storage)}};Group.prototype.clearChildren=function(){for(var i=0;i<this._children.length;i++){var child=this._children[i];if(this._storage){this._storage.delFromMap(child.id);child instanceof Group&&child.delChildrenFromStorage(this._storage)}}this._children.length=0};Group.prototype.eachChild=function(cb,context){for(var haveContext=!!context,i=0;i<this._children.length;i++){var child=this._children[i];haveContext?cb.call(context,child):cb(child)}};Group.prototype.traverse=function(cb,context){for(var haveContext=!!context,i=0;i<this._children.length;i++){var child=this._children[i];haveContext?cb.call(context,child):cb(child);"group"===child.type&&child.traverse(cb,context)}};Group.prototype.addChildrenToStorage=function(storage){for(var i=0;i<this._children.length;i++){var child=this._children[i];storage.addToMap(child);child instanceof Group&&child.addChildrenToStorage(storage)}};Group.prototype.delChildrenFromStorage=function(storage){for(var i=0;i<this._children.length;i++){var child=this._children[i];storage.delFromMap(child.id);child instanceof Group&&child.delChildrenFromStorage(storage)}};Group.prototype.modSelf=function(){this.__dirty=!0};util.merge(Group.prototype,Transformable.prototype,!0);util.merge(Group.prototype,Eventful.prototype,!0);return Group});