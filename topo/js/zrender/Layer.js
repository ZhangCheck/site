define(["require","./mixin/Transformable","./tool/util","./config"],function(require){function returnFalse(){return!1}function createDom(id,type,painter){var newDom=document.createElement(type),width=painter.getWidth(),height=painter.getHeight();newDom.style.position="absolute";newDom.style.left=0;newDom.style.top=0;newDom.style.width=width+"px";newDom.style.height=height+"px";newDom.width=width*config.devicePixelRatio;newDom.height=height*config.devicePixelRatio;newDom.setAttribute("data-zr-dom-id",id);return newDom}var Transformable=require("./mixin/Transformable"),util=require("./tool/util"),vmlCanvasManager=window.G_vmlCanvasManager,config=require("./config"),Layer=function(id,painter){this.id=id;this.dom=createDom(id,"canvas",painter);this.dom.onselectstart=returnFalse;this.dom.style["-webkit-user-select"]="none";this.dom.style["user-select"]="none";this.dom.style["-webkit-touch-callout"]="none";this.dom.style["-webkit-tap-highlight-color"]="rgba(0,0,0,0)";this.dom.className=config.elementClassName;vmlCanvasManager&&vmlCanvasManager.initElement(this.dom);this.domBack=null;this.ctxBack=null;this.painter=painter;this.unusedCount=0;this.config=null;this.dirty=!0;this.elCount=0;this.clearColor=0;this.motionBlur=!1;this.lastFrameAlpha=.7;this.zoomable=!1;this.panable=!1;this.maxZoom=1/0;this.minZoom=0;Transformable.call(this)};Layer.prototype.initContext=function(){this.ctx=this.dom.getContext("2d");var dpr=config.devicePixelRatio;1!=dpr&&this.ctx.scale(dpr,dpr)};Layer.prototype.createBackBuffer=function(){if(!vmlCanvasManager){this.domBack=createDom("back-"+this.id,"canvas",this.painter);this.ctxBack=this.domBack.getContext("2d");var dpr=config.devicePixelRatio;1!=dpr&&this.ctxBack.scale(dpr,dpr)}};Layer.prototype.resize=function(width,height){var dpr=config.devicePixelRatio;this.dom.style.width=width+"px";this.dom.style.height=height+"px";this.dom.setAttribute("width",width*dpr);this.dom.setAttribute("height",height*dpr);1!=dpr&&this.ctx.scale(dpr,dpr);if(this.domBack){this.domBack.setAttribute("width",width*dpr);this.domBack.setAttribute("height",height*dpr);1!=dpr&&this.ctxBack.scale(dpr,dpr)}};Layer.prototype.clear=function(){var dom=this.dom,ctx=this.ctx,width=dom.width,height=dom.height,haveClearColor=this.clearColor&&!vmlCanvasManager,haveMotionBLur=this.motionBlur&&!vmlCanvasManager,lastFrameAlpha=this.lastFrameAlpha,dpr=config.devicePixelRatio;if(haveMotionBLur){this.domBack||this.createBackBuffer();this.ctxBack.globalCompositeOperation="copy";this.ctxBack.drawImage(dom,0,0,width/dpr,height/dpr)}ctx.clearRect(0,0,width/dpr,height/dpr);if(haveClearColor){ctx.save();ctx.fillStyle=this.clearColor;ctx.fillRect(0,0,width/dpr,height/dpr);ctx.restore()}if(haveMotionBLur){var domBack=this.domBack;ctx.save();ctx.globalAlpha=lastFrameAlpha;ctx.drawImage(domBack,0,0,width/dpr,height/dpr);ctx.restore()}};util.merge(Layer.prototype,Transformable.prototype);return Layer});