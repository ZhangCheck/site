define(["require","../tool/matrix","../tool/vector"],function(require){"use strict";function isAroundZero(val){return val>-EPSILON&&EPSILON>val}function isNotAroundZero(val){return val>EPSILON||-EPSILON>val}var matrix=require("../tool/matrix"),vector=require("../tool/vector"),origin=[0,0],mTranslate=matrix.translate,EPSILON=5e-5,Transformable=function(){this.position||(this.position=[0,0]);"undefined"==typeof this.rotation&&(this.rotation=[0,0,0]);this.scale||(this.scale=[1,1,0,0]);this.needLocalTransform=!1;this.needTransform=!1};Transformable.prototype={constructor:Transformable,updateNeedTransform:function(){this.needLocalTransform=isNotAroundZero(this.rotation[0])||isNotAroundZero(this.position[0])||isNotAroundZero(this.position[1])||isNotAroundZero(this.scale[0]-1)||isNotAroundZero(this.scale[1]-1)},updateTransform:function(){this.updateNeedTransform();var parentHasTransform=this.parent&&this.parent.needTransform;this.needTransform=this.needLocalTransform||parentHasTransform;if(this.needTransform){var m=this.transform||matrix.create();matrix.identity(m);if(this.needLocalTransform){var scale=this.scale;if(isNotAroundZero(scale[0])||isNotAroundZero(scale[1])){origin[0]=-scale[2]||0;origin[1]=-scale[3]||0;var haveOrigin=isNotAroundZero(origin[0])||isNotAroundZero(origin[1]);haveOrigin&&mTranslate(m,m,origin);matrix.scale(m,m,scale);if(haveOrigin){origin[0]=-origin[0];origin[1]=-origin[1];mTranslate(m,m,origin)}}if(this.rotation instanceof Array){if(0!==this.rotation[0]){origin[0]=-this.rotation[1]||0;origin[1]=-this.rotation[2]||0;var haveOrigin=isNotAroundZero(origin[0])||isNotAroundZero(origin[1]);haveOrigin&&mTranslate(m,m,origin);matrix.rotate(m,m,this.rotation[0]);if(haveOrigin){origin[0]=-origin[0];origin[1]=-origin[1];mTranslate(m,m,origin)}}}else 0!==this.rotation&&matrix.rotate(m,m,this.rotation);(isNotAroundZero(this.position[0])||isNotAroundZero(this.position[1]))&&mTranslate(m,m,this.position)}parentHasTransform&&(this.needLocalTransform?matrix.mul(m,this.parent.transform,m):matrix.copy(m,this.parent.transform));this.transform=m;this.invTransform=this.invTransform||matrix.create();matrix.invert(this.invTransform,m)}},setTransform:function(ctx){if(this.needTransform){var m=this.transform;ctx.transform(m[0],m[1],m[2],m[3],m[4],m[5])}},lookAt:function(){var v=vector.create();return function(target){this.transform||(this.transform=matrix.create());var m=this.transform;vector.sub(v,target,this.position);if(!isAroundZero(v[0])||!isAroundZero(v[1])){vector.normalize(v,v);var scale=this.scale;m[2]=v[0]*scale[1];m[3]=v[1]*scale[1];m[0]=v[1]*scale[0];m[1]=-v[0]*scale[0];m[4]=this.position[0];m[5]=this.position[1];this.decomposeTransform()}}}(),decomposeTransform:function(){if(this.transform){var m=this.transform,sx=m[0]*m[0]+m[1]*m[1],position=this.position,scale=this.scale,rotation=this.rotation;isNotAroundZero(sx-1)&&(sx=Math.sqrt(sx));var sy=m[2]*m[2]+m[3]*m[3];isNotAroundZero(sy-1)&&(sy=Math.sqrt(sy));position[0]=m[4];position[1]=m[5];scale[0]=sx;scale[1]=sy;scale[2]=scale[3]=0;rotation[0]=Math.atan2(-m[1]/sy,m[0]/sx);rotation[1]=rotation[2]=0}},transformCoordToLocal:function(x,y){var v2=[x,y];this.needTransform&&this.invTransform&&vector.applyTransform(v2,v2,this.invTransform);return v2}};return Transformable});