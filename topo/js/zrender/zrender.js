define(["require","./dep/excanvas","./tool/util","./tool/log","./tool/guid","./Handler","./Painter","./Storage","./animation/Animation","./tool/env"],function(require){function getFrameCallback(zrInstance){return function(){zrInstance._needsRefreshNextFrame&&zrInstance.refresh()}}require("./dep/excanvas");var util=require("./tool/util"),log=require("./tool/log"),guid=require("./tool/guid"),Handler=require("./Handler"),Painter=require("./Painter"),Storage=require("./Storage"),Animation=require("./animation/Animation"),_instances={},zrender={};zrender.version="2.1.1";zrender.init=function(dom){var zr=new ZRender(guid(),dom);_instances[zr.id]=zr;return zr};zrender.dispose=function(zr){if(zr)zr.dispose();else{for(var key in _instances)_instances[key].dispose();_instances={}}return zrender};zrender.getInstance=function(id){return _instances[id]};zrender.delInstance=function(id){delete _instances[id];return zrender};var ZRender=function(id,dom){this.id=id;this.env=require("./tool/env");this.storage=new Storage;this.painter=new Painter(dom,this.storage);this.handler=new Handler(dom,this.storage,this.painter);this.animation=new Animation({stage:{update:getFrameCallback(this)}});this.animation.start();var self=this;this.painter.refreshNextFrame=function(){self.refreshNextFrame()};this._needsRefreshNextFrame=!1;var self=this,storage=this.storage,oldDelFromMap=storage.delFromMap;storage.delFromMap=function(elId){var el=storage.get(elId);self.stopAnimation(el);oldDelFromMap.call(storage,elId)}};ZRender.prototype.getId=function(){return this.id};ZRender.prototype.addShape=function(shape){this.addElement(shape);return this};ZRender.prototype.addGroup=function(group){this.addElement(group);return this};ZRender.prototype.delShape=function(shapeId){this.delElement(shapeId);return this};ZRender.prototype.delGroup=function(groupId){this.delElement(groupId);return this};ZRender.prototype.modShape=function(shapeId,shape){this.modElement(shapeId,shape);return this};ZRender.prototype.modGroup=function(groupId,group){this.modElement(groupId,group);return this};ZRender.prototype.addElement=function(el){this.storage.addRoot(el);this._needsRefreshNextFrame=!0;return this};ZRender.prototype.delElement=function(el){this.storage.delRoot(el);this._needsRefreshNextFrame=!0;return this};ZRender.prototype.modElement=function(el,params){this.storage.mod(el,params);this._needsRefreshNextFrame=!0;return this};ZRender.prototype.modLayer=function(zLevel,config){this.painter.modLayer(zLevel,config);this._needsRefreshNextFrame=!0;return this};ZRender.prototype.addHoverShape=function(shape){this.storage.addHover(shape);return this};ZRender.prototype.render=function(callback){this.painter.render(callback);this._needsRefreshNextFrame=!1;return this};ZRender.prototype.refresh=function(callback){this.painter.refresh(callback);this._needsRefreshNextFrame=!1;return this};ZRender.prototype.refreshNextFrame=function(){this._needsRefreshNextFrame=!0;return this};ZRender.prototype.refreshHover=function(callback){this.painter.refreshHover(callback);return this};ZRender.prototype.refreshShapes=function(shapeList,callback){this.painter.refreshShapes(shapeList,callback);return this};ZRender.prototype.resize=function(){this.painter.resize();return this};ZRender.prototype.animate=function(el,path,loop){var self=this;"string"==typeof el&&(el=this.storage.get(el));if(el){var target;if(path){for(var pathSplitted=path.split("."),prop=el,i=0,l=pathSplitted.length;l>i;i++)prop&&(prop=prop[pathSplitted[i]]);prop&&(target=prop)}else target=el;if(!target){log('Property "'+path+'" is not existed in element '+el.id);return}null==el.__animators&&(el.__animators=[]);var animators=el.__animators,animator=this.animation.animate(target,{loop:loop}).during(function(){self.modShape(el)}).done(function(){var idx=util.indexOf(el.__animators,animator);idx>=0&&animators.splice(idx,1)});animators.push(animator);return animator}log("Element not existed")};ZRender.prototype.stopAnimation=function(el){if(el.__animators){for(var animators=el.__animators,len=animators.length,i=0;len>i;i++)animators[i].stop();animators.length=0}return this};ZRender.prototype.clearAnimation=function(){this.animation.clear();return this};ZRender.prototype.showLoading=function(loadingEffect){this.painter.showLoading(loadingEffect);return this};ZRender.prototype.hideLoading=function(){this.painter.hideLoading();return this};ZRender.prototype.getWidth=function(){return this.painter.getWidth()};ZRender.prototype.getHeight=function(){return this.painter.getHeight()};ZRender.prototype.toDataURL=function(type,backgroundColor,args){return this.painter.toDataURL(type,backgroundColor,args)};ZRender.prototype.shapeToImage=function(e,width,height){var id=guid();return this.painter.shapeToImage(id,e,width,height)};ZRender.prototype.on=function(eventName,eventHandler,context){this.handler.on(eventName,eventHandler,context);return this};ZRender.prototype.un=function(eventName,eventHandler){this.handler.un(eventName,eventHandler);return this};ZRender.prototype.trigger=function(eventName,event){this.handler.trigger(eventName,event);return this};ZRender.prototype.clear=function(){this.storage.delRoot();this.painter.clear();return this};ZRender.prototype.dispose=function(){this.animation.stop();this.clear();this.storage.dispose();this.painter.dispose();this.handler.dispose();this.animation=this.storage=this.painter=this.handler=null;zrender.delInstance(this.id)};return zrender});