define(["text!./avalon.simplegrid.html","../pager/avalon.pager","../dropdown/avalon.dropdown","../loading/avalon.loading","../scrollbar/avalon.scrollbar","../mmPromise/avalon.mmPromise","css!../chameleon/oniui-common.css","css!./avalon.simplegrid.css"],function(tmpl){function returnFalse(event){event.returnValue=!1}function getDirection(e,target,data){var dir="",offset=target.offset(),width=target[0].offsetWidth,edge=data.edge;e.pageX<offset.left+width&&e.pageX>offset.left+width-edge&&(dir="e");return"e"===dir?dir:""}function makeBool(elem,name,value){value=!!value;elem[name]="boolean"==typeof elem[name]?elem[name]:value}function getHiddenParent(parent){do{if("none"===avalon(parent).css("display")){var oldV,$parent=avalon(parent);return[function(){$parent.css("display","block");oldV=$parent.css("visibility")},function(){$parent.css("display","none");$parent.css("visibility",oldV)}]}if("BODY"===parent.tagName)break}while(parent=parent.parentNode);return[avalon.noop,avalon.noop]}function makeTemplate(opts,name,value){opts[name]="function"==typeof opts[name]?opts[name](value,opts):"string"==typeof opts[name]?opts[name]:value}var theadTemplate,tbodyTemplate,procyTemplate,gridTemplate=tmpl;gridTemplate=gridTemplate.replace(/MS_OPTION_THEAD_BEGIN([\s\S]+)MS_OPTION_THEAD_END/,function(a,b){theadTemplate=b;return"MS_OPTION_THEAD_HOLDER"});gridTemplate=gridTemplate.replace(/MS_OPTION_TBODY_BEGIN([\s\S]+)MS_OPTION_TBODY_END/,function(a,b){tbodyTemplate=b;return"MS_OPTION_TBODY_HOLDER"});gridTemplate=gridTemplate.replace(/MS_OPTION_PROXY_BEGIN([\s\S]+)MS_OPTION_PROXY_END/,function(a,b){procyTemplate=b;return"MS_OPTION_PROXY_HOLDER"});var body=document.body||document.documentElement,remptyfn=/^function\s+\w*\s*\([^)]*\)\s*{\s*}$/m,widget=avalon.ui.simplegrid=function(element,data,vmodels){function reRenderTbody(n,o){var scrollTop=n,scrollDir=scrollTop>prevScrollTop?"down":"up";prevScrollTop=scrollTop;var distance=Math.abs(lastRenderedScrollTop-scrollTop),rowHeight=vmodel._rowHeight;if(distance>=vmodel._rowHeightNoBorders){var linage=distance/rowHeight,integer=Math.floor(linage),decimal=linage-integer;decimal>.55&&(integer+=1);var length=vmodel.data.length,count=0,showRows=vmodel.showRows;if("down"===scrollDir)for(;vmodel.endIndex+1<length;){vmodel.endIndex+=1;vmodel.startIndex+=1;count+=1;var el=vmodel.data[vmodel.endIndex];if(showRows>=integer-count){vmodel._data.push(el);vmodel._data.shift()}if(count===integer)break}else for(;vmodel.startIndex>=0;){vmodel.endIndex-=1;vmodel.startIndex-=1;count+=1;var el=vmodel.data[vmodel.startIndex];if(showRows>=integer-count){vmodel._data.unshift(el);vmodel._data.pop()}if(count===integer)break}lastRenderedScrollTop=vmodel.tbodyScrollTop=vmodel.startIndex*rowHeight}}var scrollbarTimer,vmodel,options=data.simplegridOptions,optId=+new Date;options.columns=options.getColumns(options.columns,options);makeTemplate(options,"theadTemplate",theadTemplate);makeTemplate(options,"tbodyTemplate",tbodyTemplate);makeTemplate(options,"procyTemplate",procyTemplate);var template=gridTemplate.replace(/MS_OPTION_THEAD_HOLDER/,options.theadTemplate).replace(/MS_OPTION_TBODY_HOLDER/,options.tbodyTemplate).replace(/MS_OPTION_PROXY_HOLDER/,options.procyTemplate);options.template=options.getTemplate(template,options).replace(/\{\{MS_OPTION_ID\}\}/g,optId);"object"!=typeof options.pager?options.pager={}:options.pageable=!0;options.pager.parentVMId=data.simplegridId;options.pager.useInnerRequest=options.useInnerRequest;options.pager.parentInterface=options["interface"];options.pager.argFormat=options.argFormat;options.pager.currentPage="1";var pager=options.pager;pager.perPages=options.pageable?pager.perPages||options.data.length:options.data.length;pager.perPages=0==pager.perPages?1:pager.perPages;pager.nextText=pager.nextText||"下一页";pager.prevText=pager.prevText||"上一页";Array.isArray(pager.options)&&(pager.getTemplate="function"==typeof pager.getTemplate?pager.getTemplate:function(tmpl){return tmpl+'<div class="oni-simplegrid-pager-options">每页显示<select ms-widget="dropdown" data-dropdown-list-width="50" data-dropdown-width="50" ms-duplex="perPages" ><option ms-repeat="options" ms-value="el.value">{{el.text}}</option></select>条,共{{totalItems}}条结果</div>'});makeBool(pager,"showJumper",!0);options.pager=options.getPager(pager,options);options.showRows=options.showRows||pager.perPages;if(Array.isArray(options.columnsOrder)){if(options.syncTheadColumnsOrder){orders=options.columnsOrder.concat();for(var elem,newColumns=[],oldColumns=options.columns;el=orders.shift();)label:for(var k=0,kn=oldColumns.length;kn>k;k++){elem=oldColumns[k];if(elem.field==el){newColumns.push(elem);oldColumns.splice(k,1);break label}}options.columns=newColumns}}else{for(var el,orders=[],i=0;el=options.columns[i++];)orders.push(el.field);options.columnsOrder=orders}var _vmodels,loadingOpts={toggle:!1,onInit:function(vm,options,vmodels){vmodel.loadingVModel=vm}};options.loading="object"===avalon.type(options.loading)?avalon.mix(options.loading,loadingOpts):loadingOpts;vmodel=avalon.define(data.simplegridId,function(vm){avalon.mix(vm,options);vm.$skipArray=["_init","widgetElement","data","addColumnCallbacks","scrollPanel","topTable","bottomTable","startIndex","pager","endIndex","template","loading","loadingVModel","rootElement"];vm.loadingVModel=null;vm.widgetElement=element;vm.rootElement="";vm.gridWidth="100%";vm.startIndex=0;vm.endIndex=options.showRows-1;vm.cssLeft="0";vm.barRight=0;vm.scrollerHeight=void 0;vm.paddingBottom="0";vm.barUpdated=!1;vm._data=[];vm._init=!0;vm.$init=function(){avalon.ready(function(){element.innerHTML=options.template.replace(/MS_OPTION_ID/g,vmodel.$id);_vmodels=[vmodel].concat(vmodels);vm.rootElement=element.getElementsByTagName("*")[0];options.useInnerRequest?vmodel.$dataAjax().then(function(resolve){vmodel.reRender(resolve,vmodel);avalon.scan(element,_vmodels)}):avalon.scan(element,_vmodels);"function"==typeof options.onInit&&options.onInit.call(element,vmodel,options,vmodels)})};vm._theadRenderedCallback=function(){var fns=getHiddenParent(vm.widgetElement);fns[0]();for(var cell,tr=this,tbody=this.parentNode,table=tbody.parentNode,cells=tr.children,cellIndex=0,i=0;cell=cells[i++];)if(1===cell.nodeType&&cell["data-vm"]){var c=vm.columns[cellIndex++];-1===String(c.width).indexOf("%")&&(c.width=cell.offsetWidth)}vm.topTable=table;vm.theadHeight=avalon(table).innerHeight();vm.scrollPanel=table.parentNode.parentNode;vm.gridWidth=Math.min(table.offsetWidth,vm.scrollPanel.offsetWidth)+1;fns[1]();vm.theadRenderedCallback.call(tbody,vmodel,options,vmodels)};vm._tbodyRenderedCallback=function(a){function delay(){var cell=tbody.getElementsByTagName("td")[0]||tbody.getElementsByTagName("th")[0],fns=getHiddenParent(vm.widgetElement);fns[0]();var table=vm.bottomTable=tbody.parentNode,noResultHeight=vm._data.size()?0:vmodel.noResultHeight;vm.tbodyHeight=avalon(table).innerHeight()+noResultHeight;var rowCount=tbody.rows.length;vm._rowHeight=rowCount?vm.tbodyHeight/rowCount:35;var perPages=vm.pageable?vm.pager.perPages:vm.data.length;vm.tbodyScrollHeight=vm._rowHeight*perPages;var borderHeight=cell?Math.max(avalon.css(cell,"borderTopWidth",!0),avalon.css(cell,"borderBottomWidth",!0)):0;vm._rowHeightNoBorders=vm._rowHeight-2*borderHeight;fns[1]();vm.tbodyRenderedCallback.call(tbody,vmodel,options,vmodels);setTimeout(function(){vmodel.updateScrollbar(!vmodel.barUpdated);vmodel.barUpdated=!0})}var tbody=this;setTimeout(delay,100)};vm.showLoading=function(){vmodel.loadingVModel.toggle=!0};vm.hideLoading=function(){vmodel.loadingVModel.toggle=!1};vm.startResize=function(e,el){if(!options._drag&&el.resizable){var cell=avalon(this),dir=getDirection(e,cell,options);options._cursor=cell.css("cursor");if(""===dir){options.canResize=!1;cell.css("cursor","default")}else{options.canResize=cell;cell.css("cursor",dir+"-resize")}}};vm.stopResize=function(){if(options.canResize){options.canResize.css("cursor",options._cursor);vmodel.updateScrollbar("forceUpdate");delete options.canResize}};vm.resizeColumn=function(e,el){var cell=options.canResize;if(cell){"number"!=typeof el.width&&(el.width=cell[0].offsetWidth);var cellWidth=el.width,startX=e.pageX;options._drag=!0;fixUserSelect();var gridWidth=vm.gridWidth,moveFn=avalon.bind(document,"mousemove",function(e){if(options._drag){e.preventDefault();var change=e.pageX-startX;vm.gridWidth=gridWidth+change;el.width=cellWidth+change;vmodel.updateScrollbar("forceUpdate")}}),upFn=avalon.bind(document,"mouseup",function(e){e.preventDefault();if(options._drag){restoreUserSelect();delete options._drag;vm.gridWidth=gridWidth+e.pageX-startX;el.width=cellWidth+e.pageX-startX;avalon.unbind(document,"mousemove",moveFn);avalon.unbind(document,"mouseup",upFn)}})}};vm.sortIndex=NaN;vm.getArrow=function(el,$index){var sortIndex=vm.sortIndex,asc=el.sortAsc;return $index!==sortIndex?"ndb":asc?"asc":"desc"};vm.sortColumn=function(el,$index){vm.sortIndex=$index;var trend=el.sortAsc=!el.sortAsc,field=el.field,opts=vmodel.$model;trend=trend?1:-1;if("function"!=typeof opts.remoteSort||remptyfn.test(opts.remoteSort))if("function"!=typeof el.localSort||remptyfn.test(el.localSort))vmodel._data.sort(function(a,b){return trend*a[field].localeCompare(b[field])});else{vmodel._data.sort(function(a,b){return trend*el.localSort(a,b,field,opts)||0});"function"==typeof vmodel.onSort&&setTimeout(function(){vmodel.onSort(vmodel)},500)}else vmodel.remoteSort(field,trend,vmodel)};vm.getColumnsOrder=function(){return vm.columnsOrder};vm.addColumn=function(obj,i){var el=options.getColumns([obj],vm)[0],field=el.field;if(-1===vm.columnsOrder.indexOf(field)){var index=parseInt(i,10)||0,defaultValue=el.defaultValue||"";vm.columns.splice(index,0,el);vm.columnsOrder.splice(index,0,field);vm.addColumnCallbacks[field]=function(array){array.forEach(function(elem){elem.hasOwnProperty(field)||(elem[field]=defaultValue)})}}vm.reRender(vm.data,vm)};vm.getCellProperty=function(name,prop){for(var el,i=0;el=vm.columns[i++];)if(el.field===name)return el[prop]};vm.throttleRenderTbody=function(n,o){vmodel.tbodyScrollTop=n;cancelAnimationFrame(requestID);requestID=requestAnimationFrame(function(){reRenderTbody(n,o)})};vm.getScrollerHeight=function(){var h=vm.tbodyScrollHeight+vm.tbodyScrollTop-vm.theadHeight,max=vm._rowHeight*vm.data.length;if(vm.scrollInPage){h=max;vm.scrollerHeight=h}else{h=h>max?max:h;setTimeout(function(loop){var _h=vm.getScrollbar().getScroller().css("height");h==_h||loop?vm.scrollerHeight=h:arguments.callee(1)},100)}return h};vm.$dataAjax=function(interface){void 0!==interface&&(options["interface"]=interface);return new Promise(function(resolve,reject){fb.requestJson(avalon.mix({},options["interface"],{success:function(interfaceData){var data=interfaceData;options.dataFormat&&"function"==typeof options.dataFormat&&(data=options.dataFormat(vmodel,interfaceData,options));resolve(data);options["interface"].success&&options["interface"].success(interfaceData)}}))})};vm.changePage=function(interface){options.useInnerRequest&&vmodel.$dataAjax(interface).then(function(resolve){vmodel.reRender(resolve,vmodel)})};vm.$spgScrollbarOpts={onScroll:function(n,o,dir){if("v"==dir){clearTimeout(scrollbarTimer);scrollbarTimer=setTimeout(function(){vmodel.throttleRenderTbody(n,o)},16)}else vmodel.cssLeft=void 0==n?"auto":-n+"px"},viewHeightGetter:function(ele){return ele.innerHeight()-vmodel.theadHeight},show:vm.showScrollbar};vm.getScrollbar=function(){return avalon.vmodels["$simplegrid"+optId]};vm.updateScrollbar=function(force){if(force){var scrollbar=vmodel.getScrollbar();scrollbar.getScroller();scrollbar&&scrollbar.update("init")}};vm.$proxyDom=null;vm.$isDown=!1;vm.$isMoving=!1;vm.$movingIndex=-1;vm.onDown=function(e,index){vm.$isDown=!0};vm.onMove=function(e,index){if(vm.$isDown&&vm.columnDragSort&&!vm.$isMoving){vm.$isMoving=!0;vm.$movingIndex=index}};vm.onUp=function(e,index){if(vm.columnDragSort){if(vm.$isMoving&&index!=vm.$movingIndex){var del=vm.columns.splice(vm.$movingIndex,1);vm.columns.splice(index,0,del[0]);del=vm.columnsOrder.splice(vm.$movingIndex,1);vm.columnsOrder.splice(index,0,del[0]);vm._data=vm.getStore(vm.data,vm)}vm.$isMoving=!1;vm.$isDown=!1}};vm.gridEdit=function(el){};vm.chooseThisTr=function(index){vm._data[index].checked=!vm._data[index].checked;vm.selectedRow&&vm.selectedRow(index,vm._data[index])};vm.$watch("showRows",function(rows){vmodel.endIndex=rows});vm.resetColumnsOrder=function(){if(options.columnDragable){orders=options.columnsOrder.concat();for(var elem,newColumns=[],oldColumns=options.columns;el=orders.shift();)label:for(var k=0,kn=oldColumns.length;kn>k;k++){elem=oldColumns[k];if(elem.field==el){newColumns.push(elem);oldColumns.splice(k,1);break label}}options.columns=newColumns}};vm.getColumnWidth=function(key,indexp){for(var index,i=0,il=vm.columns.length;il>i;i++)if(vm.columns[i].field==key){index=i;break}vm.showLineNum&&index++;return 0==index?$(".oni-simplegrid-thead td").eq(index).width()-10:"100%"}});vmodel._data=vmodel.getStore(vmodel.data,vmodel);if(vmodel.pageable)var flagPager=!1,intervalID=setInterval(function(){var elem=document.getElementById("pager-"+vmodel.$id);if(elem&&!flagPager){elem.setAttribute("ms-widget","pager,pager-"+vmodel.$id);avalon(elem).addClass("oni-simplegrid-pager-wrapper");avalon.scan(elem,vmodel);flagPager=!0}var pagerVM=avalon.vmodels["pager-"+vmodel.$id];if(pagerVM){vmodel.pager=pagerVM;clearInterval(intervalID)}},100);var requestID,prevScrollTop=0,lastRenderedScrollTop=0;vmodel.$watch("scrollerHeight",function(n){if(n>0){vmodel.getScrollbar().disabled=!1;vmodel.getScrollbar().toggle=!0}vmodel.updateScrollbar("forceUpdate")});return vmodel};widget.defaults={scrollInPage:!0,rowSingleLine:!0,columns:[],selectedRow:null,showLineNum:!0,columnDragSort:!1,useInnerRequest:!1,theadHeight:35,noResultHeight:100,tbodyScrollHeight:"auto",rowClass:"even",showScrollbar:"always",tbodyScrollTop:0,tbodyHeight:"auto",evenClass:"even",_rowHeight:35,_rowHeightNoBorders:0,columnWidth:"auto",edge:15,_data:[],data:[],topTable:{},bottomTable:{},scrollPanel:{},addColumnCallbacks:{},pageable:!1,syncTheadColumnsOrder:!0,remoteSort:avalon.noop,noResultContent:"暂无结果",columnDragable:!0,"interface":{},argFormat:function(args,pageNum,pageSize){return avalon.mix(args,{rows:pageSize,page:pageNum})},dataFormat:function(vm,interfaceData,options){return interfaceData},theadRenderedCallback:function(vmodel,options,vmodels){},tbodyRenderedCallback:function(vmodel,options,vmodels){vmodel._init?vmodel._init=!1:vmodel.widgetElement.scrollIntoView()},renderCell:function(val,key,row){return val},getColumnTitle:function(){return""},getTemplate:function(tmpl,options){return tmpl},getStore:function(array,vm){return array.slice(vm.startIndex,array.length<vm.endIndex+1?array.length:vm.endIndex+1)},getColumn:function(el,options){return el},getPager:function(pager,options){return pager},getColumns:function(array,options){for(var el,ret=[],i=0;el=array[i++];){"string"==typeof el&&(el={field:el});el.text=el.text||el.field;el.title=options.getColumnTitle(el);el.width=el.width||options.columnWidth;el.className=el.className||"";el.align=el.align||"";el.localSort="function"==typeof el.localSort?el.localSort:!1;makeBool(el,"sortable",!0);makeBool(el,"resizable",!0);makeBool(el,"sortAsc",!0);makeBool(el,"toggle",!0);makeBool(el,"disabledToggle");options.getColumn(el,options);ret.push(el)}return ret},reRender:function(data,vm){void 0===vm&&(vm=this);avalon.each(vm.addColumnCallbacks,function(n,fn){fn(data)});vm.data=data;vm.startIndex=0;vm._data=vm.getStore(data,vm);"function"==typeof vm.onSort&&setTimeout(function(){vm.onSort(vm)},500)}};var fixUserSelect=function(){avalon(body).addClass("oni-helper-noselect")},restoreUserSelect=function(){avalon(body).removeClass("oni-helper-noselect")};if(window.VBArray&&!("msUserSelect"in document.documentElement.style)){var _ieSelectBack;fixUserSelect=function(){_ieSelectBack=body.onselectstart;body.onselectstart=returnFalse};restoreUserSelect=function(){body.onselectstart=_ieSelectBack}}var requestAnimationFrame=window.requestAnimationFrame||function(callback){return window.setTimeout(callback,1e3/60)},cancelAnimationFrame=window.cancelAnimationFrame||function(id){clearTimeout(id)};return avalon});