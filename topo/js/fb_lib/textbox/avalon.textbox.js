define(["./avalon.suggest","text!./avalon.textbox.html","css!../chameleon/oniui-common.css","css!./avalon.textbox.css"],function(avalon,sourceHTML){var htmlStructArray=sourceHTML.split("MS_OPTION_SUGGEST"),suggestHTML=htmlStructArray[1],placeholderOrigin="placeholder"in document.createElement("input"),widget=avalon.ui.textbox=function(element,data,vmodels){function FitToContent(elementInitialHeight){if(vmodel.adaptiveHeight.maxHeight&&""!==vmodel.adaptiveHeight.maxHeight)var maxHeight=parseInt(vmodel.adaptiveHeight.maxHeight,10);if(vmodel.adaptiveHeight.minHeight&&""!==vmodel.adaptiveHeight.minHeight)var minHeight=parseInt(vmodel.adaptiveHeight.minHeight,10);element.clientHeight==element.scrollHeight&&(element.style.height=(minHeight||elementInitialHeight)+"px");var adjustedHeight=element.clientHeight,shouldHigher=!maxHeight||maxHeight>adjustedHeight;if(shouldHigher){adjustedHeight=Math.max(element.scrollHeight,adjustedHeight);maxHeight&&(adjustedHeight=Math.min(maxHeight,adjustedHeight));adjustedHeight>element.clientHeight&&(element.style.height=adjustedHeight+"px")}}var elemParent=element.parentNode,$element=avalon(element),options=data.textboxOptions,vmSub="",sourceList="",inputWraper="",placeholder="",placehold=options.placeholder,_sourceHTML=sourceHTML;_sourceHTML=_sourceHTML.replace(/MS_OPTION_DISABLEDCLASS/gm,options.disabledClass);_sourceHTML=options.getTemplate(_sourceHTML);sourceList=avalon.parseHTML(_sourceHTML).firstChild;inputWraper=sourceList.getElementsByTagName("div")[0];placeholder=sourceList.getElementsByTagName("span")[0];if(options.suggest){var suggestConfig={inputElement:element,strategy:options.suggest,textboxContainer:sourceList,focus:options.suggestFocus||!1,onChange:options.suggestOnChange||"",type:"textbox",limit:options.limit||8,disableLetter:options.suggestDisableLetter||!1};$suggestopts=avalon.mix(suggestConfig,options.suggestion);options.$suggestopts=$suggestopts}placehold=avalon(element).attr("placeholder")||placehold||"";var msDuplexValue,msData,vmodel=avalon.define(data.textboxId,function(vm){avalon.mix(vm,options);vm.$skipArray=["widgetElement","disabledClass","autoTrim","suggest"];vm.widgetElement=element;vm.elementDisabled="";vm.toggle=!0;vm.placehold=placehold;vm.focusClass=!1;vm.placeholderOrigin=placeholderOrigin;vm.placeWidth=0;vm.hidePlaceholder=function(){vm.toggle=!1;element.focus()};vm.blur=function(){vmodel.focusClass=!1;vmodel.elementDisabled=element.disabled;options.autoTrim&&(element.value=element.value.trim());vmodel.placeholderOrigin||(""==element.value&&vmodel.placehold.length?vmodel.toggle=!0:vmodel.toggle=!1)};vm.$remove=function(){var sourceListParent=sourceList.parentNode;sourceListParent.removeChild(sourceList);sourceList.innerHTML=sourceList.textContent=""};vm.clearBtnHeight=0;vm.clearText=function(e){e.stopPropagation();vm.clearBtnHeight=avalon(this).css("height");element.value="";vm.showClearBtn=!1;options.clearAfterFun()};vm.showClearBtn=!1;vm.clearBtnHeight=0;vm.$init=function(continueScan){function clearBtnShow(){element.value&&options.showClear&&"Microsoft Internet Explorer"!=navigator.appName&&(vm.showClearBtn=!0)}avalon.bind(element,"blur",vm.blur);options.autoFocus&&avalon.bind(element,"mouseover",function(){element.focus()});$element.addClass("oni-textbox-input");$element.bind("keyup",function(){clearBtnShow()});$element.bind("focusin",function(){clearBtnShow()});avalon.bind(document,"click",function(e){e.stopPropagation();vm.showClearBtn=!1});var tempDiv=document.createElement("div");elemParent.insertBefore(tempDiv,element);element.msRetain=!0;inputWraper.appendChild(element);~options.width&&$element.width(options.width);~options.height&&$element.height(options.height);~options.tabIndex&&(element.tabIndex=options.tabIndex);elemParent.replaceChild(sourceList,tempDiv);element.msRetain=!1;if(options.suggest){var suggest=avalon.parseHTML(suggestHTML).firstChild;sourceList.appendChild(suggest)}avalon.bind(element,"focus",function(){vmodel.focusClass=!0;vmodel.placeholderOrigin||(vmodel.toggle=!1)});avalon.scan(sourceList,[vmodel].concat(vmodels));if(vmodel.placeholderOrigin)vmodel.placehold.length&&$element.attr("placeholder",vmodel.placehold);else{vmodel.placehold.length&&""==element.value||(vmodel.toggle=!1);vmodel.placeWidth=avalon(inputWraper).innerWidth()}if(continueScan)continueScan();else{avalon.log("avalon请尽快升到1.3.7+");avalon.scan(element,[vmodel].concat(vmodels));"function"==typeof options.onInit&&options.onInit.call(element,vmodel,options,vmodels)}vm.elementDisabled=element.disabled;vmodel.adaptiveHeight.minHeight&&avalon.css(element,"height",vmodel.adaptiveHeight.minHeight)}});for(var i in element.msData)if(0===i.indexOf("ms-duplex")){msDuplexValue=element.msData[i];break}if(msDuplexValue){vmSub=avalon.getModel(msDuplexValue,vmodels);if(vmSub){if(vmodel.adaptiveHeight){var elementInitialHeight;setTimeout(function(){elementInitialHeight=avalon.css(element,"height")},0)}vmSub[1].$watch(vmSub[0],function(){vmodel.elementDisabled=element.disabled;vmodel.placeholderOrigin||(""==element.value&&vmodel.placehold.length?vmodel.toggle=!0:vmodel.toggle=!1);vmodel.adaptiveHeight&&FitToContent(elementInitialHeight)})}}msData=element.msData["ms-disabled"]||element.msData["ms-attr-disabled"]||element.msData["ms-enabled"]||element.msData["ms-attr-enabled"];if(msData){vmSub=avalon.getModel(msData,vmodels);vmSub&&vmSub[1].$watch(vmSub[0],function(){vmodel.elementDisabled=element.disabled;vmodel.placeholderOrigin||(""==element.value&&vmodel.placehold.length?vmodel.toggle=!0:vmodel.toggle=!1)})}return vmodel};widget.defaults={suggest:!1,suggestion:{},showClear:!1,autoTrim:!0,widgetElement:"",tabIndex:-1,width:-1,autoFocus:!1,disabledClass:"oni-textbox-disabled",getTemplate:function(tmp){return tmp.replace(/MS_OPTION_ICON/,"")},clearAfterFun:function(){},stateClass:"",suggestOnChange:"",suggestFocus:!1,adaptiveHeight:""};return avalon});