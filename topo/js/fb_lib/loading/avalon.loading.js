define(["avalon","text!./avalon.loading.html","text!./avalon.loading.bar.html","css!./avalon.loading.css","css!../chameleon/oniui-common.css"],function(avalon,template,ballTemplate){function addType(type,config,drawer,effect){config.drawer=drawer;config.effect=effect;_config[type]=config}function g(id){return document.getElementById(id)}function circleValueList(r,bw,ct){for(var arc,x,y,res,arr=[],count=ct||36,r=r-bw,i=0;count>=i;i++){arc=Math.PI/2-2*Math.PI/count*i;x=Math.cos(arc)*r+1*r+1*bw;y=(1-Math.sin(arc).toFixed(4))*r+1*bw;res=(i?" L":"M")+x+" "+y+(100==i?"Z":"");arr.push(res)}return arr}var widgetCount=0,isIE=navigator.userAgent.match(/msie/gi)||"ActiveXObject"in window,_key=99999-1e4*Math.random()>>0,templateCache={},parts=ballTemplate.split("{{MS_WIDGET_TYPE}}"),_config={};avalon.each(parts,function(i,item){var type,item=item.trim().replace(/^\{\{MS_WIDGET_[^\}]+\}\}/g,function(mat){type=mat.replace(/\{\{MS_WIDGET_|\}\}/g,"").replace(/_/g,"-").toLowerCase();return""});if(type){type=type;item=item.split("{{MS_WIDGET_DIVIDER}}");templateCache[type]={svg:item[1]||item[0],vml:item[0]}}});addType("ball",{width:32,widthInner:28,count:10,interval:120,circleMargin:1,svgDur:"1s"},function(vmodel){var type=vmodel.type,count=vmodel.count,width=vmodel.width,radiusOut=width/2,interval=vmodel.interval,radiusInner=(width-vmodel.widthInner)/2;"ball"===type&&(vmodel.svgDur=interval*count/1e3+"s");return function(loop){var angel=Math.PI*(.5-2*loop/count);vmodel.data.push({x:(radiusOut-radiusInner)*(Math.cos(angel)+1),y:(radiusInner-radiusOut)*(Math.sin(angel)-1),r:radiusInner,begin:[interval*loop/1e3,"s"].join("")});vmodel.opacities.push((loop/count).toFixed(2))}},function(vmodel,ele,tagList,callback){if(isIE||"ticks"===vmodel.type||"spinning-spin"==vmodel.type){var tagList=Array.isArray(tagList)?tagList:["circle","oval"],tag=vmodel.svgSupport?tagList[0]:tagList[1],ele=ele.getElementsByTagName(tag),len=ele.length,index=len,eles=[];avalon.each(ele,function(i,item){eles.push(avalon(item));if(i===len-1&&!vmodel.svgSupport){item.style.display="none";item.style.display="block"}});if("ticks"===vmodel.type){index=0;return function(){for(var i=0;len>i;i++){var op=i>index?vmodel.opacities[1]:vmodel.opacities[0];eles[i]&&eles[i].css("visibility",op>=1?"visible":"hidden")}index++;index>=len&&(index=-1)}}return function(){index--;0>index&&(index=len-1);for(var i=0;len>i;i++)if(callback)callback(eles[i],i,index);else{var op=100*vmodel.opacities[(i+index)%len]/100;eles[i]&&eles[i].css("opacity",op)}}}});addType("ticks",avalon.mix({},_config.ball,{count:3,height:20,interval:360}),function(vmodel){var count=vmodel.count,rate=2+vmodel.circleMargin,radiusInner=(vmodel.width-vmodel.widthInner)/2,marginLeft=(vmodel.width-radiusInner*(3*count-1))/2;return function(loop){vmodel.data.push({x:marginLeft+loop*rate*radiusInner,y:vmodel.height/2-radiusInner,r:radiusInner,begin:[vmodel.interval*loop/1e3,"s"].join("")});vmodel.opacities.push(loop?0:1)}},_config.ball.effect);templateCache.ticks=templateCache.ball;addType("spin",{width:32,widthInner:26,angel:90,arc:"",circle:"",radius:"",opacity:.2,startangle:0,endangle:0,interval:36,$circleData:"",$partsData:"",spinPoint:"23 23",svgDur:"1s",data:[1]},function(vmodel){vmodel.radius=vmodel.width/2-vmodel.widthInner/2;if(vmodel.svgSupport){vmodel.svgDur=36*vmodel.interval/1e3+"s";vmodel.spinPoint=[vmodel.width/2,vmodel.width/2].join(" ");var circle=vmodel.$circleData=circleValueList(vmodel.width/2,vmodel.width/2-vmodel.widthInner/2),parts=vmodel.$partsData=circle.slice(0,Math.floor(vmodel.angel/360*(circle.length-1)));vmodel.arc=parts.join("");vmodel.circle=circle.join("")}else{vmodel.startangle=0;vmodel.endangle=vmodel.angel}},function(vmodel,ele){if(isIE){var angel=stepper=vmodel.angel;if(vmodel.svgSupport){var len=vmodel.$circleData.length,ele=avalon(ele.getElementsByTagName("path")[0]);angel=stepper=Math.floor(vmodel.angel/360*len);return function(){stepper+=1;stepper>=len&&(stepper=0);ele.attr("transform","rotate("+10*stepper+" "+vmodel.spinPoint+")")}}return function(){stepper+=10;var startangle=stepper-angel;if(stepper>360){stepper-=360;startangle-=360}vmodel.startangle=startangle;vmodel.endangle=stepper}}});addType("spokes",{count:8,width:32,spokesWidth:4,spokesHeight:8,interval:125,svgPath:"M14 0 H18 V8 H14 z",svgDur:"1s"},function(vmodel){var count=vmodel.count,w=vmodel.width,sw=vmodel.spokesWidth,sh=vmodel.spokesHeight,interval=vmodel.interval;if(vmodel.svgSupport){vmodel.svgPath=["M",(w-sw)/2," 0 H",(w+sw)/2," V",sh," H",(w-sw)/2," z"].join("");vmodel.svgDur=interval*count/1e3+"s";var step=360/count;return function(loop){vmodel.data.push({begin:[interval*loop/1e3,"s"].join(""),rotate:["rotate(",loop*step," ",[w/2,w/2].join(" ")+")"].join("")});vmodel.opacities.push((loop/count).toFixed(2))}}var angel,step=2*Math.PI/count;return function(loop){angel=Math.PI/2-step*loop;var vsin=Math.sin(angel),vcos=Math.cos(angel),op=(loop/count).toFixed(2);vmodel.data.push({spokesRotation:360*loop/count,spokesOpacity:50*op,spokesLeft:(w/2-sw)*(1+vcos),spokesTop:(w/2-sw)*(1-vsin)});vmodel.opacities.push(op)}},function(vmodel,ele){return _config.ball.effect(vmodel,ele,["path","rect"])});addType("spinning-bubbles",avalon.mix({},_config.ball,{width:64,widthInner:54,$zooms:[]}),function(vmodel){var drawer=_config.ball.drawer(vmodel),count=vmodel.count;count>=7?vmodel.$zooms=[.2,.4,.8,1,.8,.4,.2]:count>=5?vmodel.$zooms=[.2,.8,1,.8,.2]:vmodel.$zooms=[1,.1,.1,.1];for(;vmodel.$zooms.length<vmodel.count;)vmodel.$zooms.push(.1);return function(loop){drawer(loop)}},function(vmodel,ele){var r=(vmodel.width-vmodel.widthInner)/2,count=vmodel.count;return vmodel.svgSupport?_config.ball.effect(vmodel,ele,["circle","oval"],function(ele,loop,step){ele.attr("r",r*vmodel.$zooms[(loop+step)%count])}):_config.ball.effect(vmodel,ele,["circle","oval"],function(ele,loop,step){ele.css("zoom",vmodel.$zooms[(loop+step)%vmodel.count])})});addType("bubbles",avalon.mix({},_config["spinning-bubbles"],{height:30,widthInner:50,count:3,interval:360,circleMargin:.5}),function(vmodel){_config["spinning-bubbles"].drawer(vmodel);return _config.ticks.drawer(vmodel)},_config["spinning-bubbles"].effect);addType("spinning-spin",avalon.mix({},_config.spin,{opacities:[],data:[],radius:1,interval:_config.ball.interval,count:8,width:46,widthInner:38,padding:5}),function(vmodel){function writeOp(loop){var cp=(loop/count).toFixed(2);cp=cp>.6?cp:.2;vmodel.opacities.push(cp)}var ct=360/vmodel.padding*3,r=vmodel.width/2,dt=circleValueList(r,r-vmodel.widthInner/2,ct),count=vmodel.count,interval=vmodel.interval,step=360/count;vmodel.radius=vmodel.width/2-vmodel.widthInner/2;if(vmodel.svgSupport){vmodel.svgDur=interval*count/1e3+"s";vmodel.arc=dt.slice(0,Math.floor((1/count-vmodel.padding/360)*dt.length)).join("");return function(loop){vmodel.data.push({rotate:"rotate("+step*loop+" "+r+" "+r+")",begin:[interval*loop/1e3,"s"].join("")});writeOp(loop)}}return function(loop){vmodel.data.push({startangle:loop/count*360,endangle:(loop+1)/count*360-10});writeOp(loop)}},function(vmodel,ele){return _config.ball.effect(vmodel,ele,["path","arc"])});addType("img",{src:"https://source.qunarzz.com/piao/images/loading_camel.gif",width:52,height:39,miao:0},void 0,void 0);var svgSupport=!!document.createElementNS&&!!document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect,widget=avalon.ui.loading=function(element,data,vmodels){var options=data.loadingOptions;options.template=options.getTemplate(template,options);_config[options.type]||(options.type="ball");avalon.each(_config[options.type],function(i,item){void 0===options[i]&&(options[i]=item)});var vmodel=avalon.define(data.loadingId,function(vm){vm.height="";vm.width="";vm.data=[];vm.opacities=[];avalon.mix(vm,options);vm.widgetElement=element;vm.rootElement="";vm.svgSupport=svgSupport;vm.$loadingID=widgetCount+""+_key;vm.$timer="";vm.$skipArray=["widgetElement","template","opacities","data","rootElement"];var inited;vm.$init=function(continueScan){if(!inited){inited=!0;var container=options.container||vmodel.widgetElement,elementParent=("object"===avalon.type(container)&&1===container.nodeType&&document.body.contains(container)?container:document.getElementById(container))||document.body,type=vmodel.type,html=(templateCache[type]||templateCache.ball)[vmodel.svgSupport?"svg":"vml"];vmodel.width=0==vmodel.width?vmodel.height:vmodel.width;vmodel.height=0==vmodel.height?vmodel.width:vmodel.height;if(vmodel.drawer)for(var loop=0,drawer=vmodel.drawer(vmodel);loop<vmodel.count&&drawer;){drawer(loop);loop++}var frag=avalon.parseHTML(vmodel.template.replace("{{MS_WIDGET_HTML}}",html).replace("{{MS_WIDGET_ID}}",vmodel.$loadingID));newDiv=frag.childNodes[0];elementParent.appendChild(newDiv);vm.rootElement=newDiv;avalon.log("avalon请尽快升到1.3.7+");avalon.scan(elementParent,[vmodel].concat(vmodels));"function"==typeof options.onInit&&options.onInit.call(element,vmodel,options,vmodels);vmodel._effect()}};vm._effect=function(){if(vmodel.toggle){var ele=document.getElementById("oni-loading-"+vmodel.$loadingID);if(ele){var effect=vmodel.effect&&vmodel.effect(vmodel,ele);if(effect){clearInterval(vmodel.$timer);vmodel.$timer=setInterval(effect,vmodel.interval)}}}};vm.$remove=function(){clearInterval(vmodel.$timer);element.innerHTML=element.textContent=""};vm.showLoading=function(){if(!vmodel.toggle){vmodel.toggle=!0;vmodel._effect()}};vm.hideLoading=function(){vmodel.toggle=!1};vm.destroyLoading=function(){vmodel.toggle=!1;vmodel.$remove()};vm.appendTo=function(container){var cnt=container||vm.widgetElement,modal=g("modal"+vm.$id),loading=g("loading"+vm.$id);modal&&cnt.appendChild(modal);loading&&cnt.appendChild(loading)}});vmodel.$watch("toggle",function(n){n?vmodel._effect():clearInterval(vmodel.$timer)});widgetCount++;return vmodel};widget.defaults={onInit:avalon.noop,color:"#619FE8",type:"ball",toggle:!0,modal:!0,modalOpacity:.1,modalBackground:"#fff",container:void 0,getTemplate:function(tmpl,opts,tplName){return tmpl},$author:"skipper@123"}});