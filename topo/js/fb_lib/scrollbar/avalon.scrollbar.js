define(["avalon","text!./avalon.scrollbar.html","../draggable/avalon.draggable","css!./avalon.scrollbar.css","css!../chameleon/oniui-common.css"],function(avalon,template){function getByClassName(cname,par){var par=par||document.body;if(par.getElementsByClassName)return par.getElementsByClassName(cname);var child=par.getElementsByTagName("*"),arr=[];avalon.each(child,function(i,item){var ele=avalon(item);ele.hasClass(cname)&&arr.push(item)});return arr}function strToNumber(s){return Math.round(parseFloat(s))||0}var wheelBinded,wheelArr=[],keyArr=[],scrollerGetted=[],widget=avalon.ui.scrollbar=function(element,data,vmodels){var options=data.scrollbarOptions;options.template=options.getTemplate(template,options);var vmodel=avalon.define(data.scrollbarId,function(vm){avalon.mix(vm,options);vm.widgetElement=element;vm.draggerHeight=vm.draggerWidth="";vm.inFocuse=!1;vm._position=[];vm.rootElement=element;vm.viewElement=element;vm.$skipArray=["rootElement"];vm.dragging=!1;var inited,scroller,bars=[];vm.$init=function(continueScan){function wheelLike(diretion,arr,e,func){avalon.each(arr,function(i,item){bars[i].data("oni-scrollbar-needed")&&vmodel._computer(func||function(obj){return vmodel._clickComputer(obj,diretion)},item[0],item[1],function(breakOut){breakOut||e.preventDefault()},"breakOutCallbackCannotIgnore")})}function myOnWheel(e){vmodel.disabled||vmodel.inFocuse&&wheelLike(e.wheelDelta>0?"up":"down",vs,e)}function myKeyDown(e){if(!vmodel.disabled){var k=e.keyCode;if(k>32&&41>k&vmodel.inFocuse)if(k in{37:1,39:1,38:1,40:1})wheelLike(k in{37:1,38:1}?"up":"down",k in{38:1,40:1}?vs:hs,e);else{var diretion=k in{33:1,36:1}?"up":"down";wheelLike(diretion,vs,e,function(obj){var _top=scroller[0].scrollTop;k in{33:1,36:1}?_top&&e.preventDefault():_top<obj.scrollerH-obj.viewH&&e.preventDefault();if(k in{36:1,35:1})return{x:0,y:36==k?0:obj.draggerparHeight-obj.draggerHeight+100};var frame=(obj.draggerparHeight-obj.draggerHeight)*obj.viewH/(obj.scrollerH-obj.viewH);return vmodel._clickComputer(obj,diretion,strToNumber(frame)||1)})}}}if(!inited){inited=!0;vmodel.widgetElement.style.position="relative";vmodel.viewElement=vmodel.widgetElement==document.body?document.getElementsByTagName("html")[0]:vmodel.widgetElement;vmodel.viewElement.style.overflow=vmodel.viewElement.style.overflowX=vmodel.viewElement.style.overflowY="hidden";vmodel.widgetElement==document.body&&(vmodel.widgetElement.style.overflow=vmodel.widgetElement.style.overflowX=vmodel.widgetElement.style.overflowY="hidden");vmodel._position=vmodel.position.split(",");var frag=avalon.parseHTML(options.template);vmodel.widgetElement.appendChild(frag);if(continueScan)continueScan();else{avalon.log("avalon请尽快升到1.3.7+");avalon.scan(element,[vmodel].concat(vmodels));"function"==typeof options.onInit&&options.onInit.call(element,vmodel,options,vmodels)}var children=vmodel.widgetElement.childNodes;avalon.each(children,function(i,item){var ele=avalon(item);ele.hasClass("oni-scrollbar")||ele.hasClass("ui-scrollbar")?bars.push(ele):(ele.hasClass("oni-scrollbar-scroller")||ele.hasClass("ui-scrollbar-scroller"))&&(scroller=ele)});if(vmodel.position.match(/left|right/g)){var vs=[],hs=[];avalon.each(vmodel._position,function(i,item){item.match(/left|right/g)?vs.push([i,item]):hs.push([i,item])});if(vmodel.widgetElement==document.body){vmodel.inFocuse=!0;wheelArr.push(myOnWheel);keyArr.push(myKeyDown)}else{avalon.bind(element,"mouseenter",function(e){vmodel.inFocuse=!0;wheelArr.push(myOnWheel);keyArr.push(myKeyDown)});avalon.bind(element,"mouseleave",function(e){vmodel.inFocuse=!1;for(var i=0,len=wheelArr.length;len>i;i++)if(wheelArr[i]===myOnWheel){wheelArr.splice(i,1);keyArr.splice(i,1);break}})}if(!wheelBinded){wheelBinded=!0;avalon.bind(document,"mousewheel",function(e){var cb=wheelArr[wheelArr.length-1];cb&&cb(e)});avalon.bind(document,"keydown",function(e){var cb=keyArr[keyArr.length-1];cb&&cb(e)})}}avalon.bind(element,"mouseenter",function(){avalon.each(bars,function(i,item){vmodel._show("e",!1,item)})});avalon.bind(element,"mouseleave",function(){vmodel._hide()});vmodel.update("init");if(scroller&&scrollerGetted.length){avalon.each(scrollerGetted,function(i,func){func()});scrollerGetted=[]}}};vm.$draggableOpts={beforeStart:function(){vmodel.dragging=!0},drag:function(e,data){var dr=avalon(data.element);vmodel._computer(function(obj){var a={x:strToNumber(dr.css("left"))>>0,y:strToNumber(dr.css("top"))>>0};a.x==obj.draggerparWidth-obj.draggerWidth&&(a.x+=100);a.y==obj.draggerparHeight-obj.draggerHeight&&(a.y+=100);return a},dr.attr("oni-scrollbar-index"),dr.attr("oni-scrollbar-pos"))},handle:function(e,data){return!vmodel.disabled&&this},containment:"parent"};vm.$draggableOpts.stop=function(e,data){vmodel.$draggableOpts.drag(e,data);vmodel.dragging=!1;avalon(data.element).removeClass("oni-state-active")};vm.$remove=function(){avalon.each(bars,function(i,bar){bar[0]&&bar[0].parentNode&&bar[0].parentNode.removeChild(bar[0])})};vm._onScroll=function(){"scrolling"==vmodel.show&&avalon.each(bars,function(i,item){vmodel._show("e",!1,item)})};vm._show=function(e,always,index){if("scrolling"==vmodel.show){e.stopPropagation&&e.stopPropagation();var item=index.css?index:bars[index];if(item){clearTimeout(item.data("oni-scrollbar-hidetimer"));item.css("visibility","visible");item.css("opacity",1);always||item.data("oni-scrollbar-hidetimer",setTimeout(function(){item.css("opacity",0)},1e3))}}};vm._hide=function(e,index){"scrolling"==vmodel.show&&(index&&bars[index]?bars[index].css("opacity",0):avalon.each(bars,function(i,item){item.css("opacity",0)}))};vm.getBars=function(){return bars};vm.getScroller=function(){return scroller};vm.update=function(ifInit,x,y){if(!vmodel.disabled){if(!scroller)return scrollerGetted.push(function(){vmodel.update(ifInit,x,y)});var viewW,viewH,barDictionary,ele=avalon(vmodel.viewElement),barH=vmodel.widgetElement===document.body?vmodel.viewElement.clientHeight:strToNumber(ele.css("height")),barW=strToNumber(ele.css("width")),h=vmodel.viewHeightGetter(ele),w=vmodel.viewWidthGetter(ele),p=vmodel.position,barMinus={},y=void 0==y?vmodel.scrollTop:y,x=void 0==x?vmodel.scrollLeft:x;vmodel.viewElement!=vmodel.widgetElement&&p.match(/right|left/g)&&avalon(vmodel.widgetElement).css("height",barH);var hPadding=scroller.width()-scroller.innerWidth(),vPadding=scroller.height()-scroller.innerHeight();scroller.css("height",h+vPadding);scroller.css("width",w+hPadding);viewW=scroller[0].scrollWidth;viewH=scroller[0].scrollHeight;barDictionary={top:p.match(/top/g)&&viewW>w&&w>0,right:p.match(/right/g)&&viewH>h&&h>0,bottom:p.match(/bottom/g)&&viewW>w&&w>0,left:p.match(/left/g)&&viewH>h&&h>0};if(bars.length>1)for(var ps=["top","right","bottom","left"],i=0;4>i;i++){barMinus[ps[i]]=[(barDictionary[i?ps[i-1]:ps[3]]&&1)>>0,(barDictionary[3>i?ps[i+1]:ps[0]]&&1)>>0];i>1&&(barMinus[ps[i]]=barMinus[ps[i]].reverse())}h=scroller.innerHeight();w=scroller.innerWidth();avalon.each(vmodel._position,function(i,item){var dragger,bar=bars[i],isVertical=item.match(/left|right/);bar&&(dragger=avalon(getByClassName("oni-scrollbar-dragger",bar.element)[0]));if(ifInit&&dragger){dragger.attr("ms-draggable","$,$draggableOpts");dragger.attr("oni-scrollbar-pos",item);dragger.attr("oni-scrollbar-index",i);avalon.scan(dragger[0],vmodel)}if(barDictionary[item]){if(bar){bar.data("oni-scrollbar-needed",!0);bar.css("visibility","visible");"scrolling"==vmodel.show||"never"==vmodel.show?bar.css("opacity",0):bar.css("opacity",1)}if(bar){var sh=strToNumber(bar.css("height")),sw=strToNumber(bar.css("width")),bh=sh,bw=sw,draggerpar=avalon(getByClassName("oni-scrollbar-draggerpar",bar[0])[0]),headerLength=vmodel.showBarHeader?2:0,draggerParCss=[];if(bars.length>1){var barCss=[],minus=barMinus[item];if(isVertical){barCss=[["top",minus[0]*bw],["height",barH-bw*(minus[0]+minus[1])]];draggerParCss=[["top",headerLength/2*bw],["height",barH-bw*(minus[0]+minus[1]+headerLength)]]}else{barCss=[["left",minus[0]*bh],["width",barW-bh*(minus[0]+minus[1])]];draggerParCss=[["left",headerLength/2*bh],["width",barW-bh*(headerLength+minus[0]+minus[1])]]}avalon.each(barCss,function(index,css){bar.css.apply(bar,css)});bh=bar.height();bw=bar.width()}else draggerParCss=isVertical?[["top",bw],["height",barH-2*bw]]:[["left",bh],["width",barW-2*bh]];var ex;if(isVertical){ex="always"==vmodel.show?bw:0;scroller.css("width",w+hPadding-ex)}else{ex="always"==vmodel.show?bh:0;scroller.css("height",h+vPadding-ex)}avalon.each(draggerParCss,function(index,css){draggerpar.css.apply(draggerpar,css)});sh=bh-headerLength*bw;sw=bw-headerLength*bh;var draggerCss;if(isVertical){var draggerTop=y,draggerHeight=strToNumber(h*sh/viewH);draggerHeight=vmodel.limitRateV*bw>draggerHeight&&vmodel.limitRateV*bw||draggerHeight;draggerTop=0>draggerTop?0:draggerTop;draggerTop=draggerTop>viewH-h?viewH-h:draggerTop;draggerTop=strToNumber((sh-draggerHeight)*draggerTop/(viewH-h));draggerTop=Math.min(sh-draggerHeight,draggerTop);draggerCss=[["width","100%"],["height",draggerHeight],["top",draggerTop]];y=y>0?y>viewH-h+ex?viewH-h+ex:y:0}else{var draggerLeft=x,draggerWidth=strToNumber(w*sw/viewW);draggerWidth=vmodel.limitRateH*bh>draggerWidth&&vmodel.limitRateH*bh||draggerWidth;draggerLeft=0>draggerLeft?0:draggerLeft;draggerLeft=draggerLeft>viewW-w?viewW-w:draggerLeft;draggerLeft=strToNumber((sw-draggerWidth)*draggerLeft/(viewW-w));draggerLeft=Math.min(sw-draggerWidth,draggerLeft);draggerCss=[["height","100%"],["width",draggerWidth],["left",draggerLeft]];x=x>0?x>viewW-w+ex?viewW-w+ex:x:0}avalon.each(draggerCss,function(index,css){dragger.css.apply(dragger,css)});ifInit&&(isVertical?vmodel._scrollTo(void 0,y):vmodel._scrollTo(x,void 0));if(vmodel.showBarHeader){0==y&&isVertical||!isVertical&&0==x?avalon(getByClassName("oni-scrollbar-arrow-up",bar[0])[0]).addClass("oni-state-disabled"):avalon(getByClassName("oni-scrollbar-arrow-up",bar[0])[0]).removeClass("oni-state-disabled");y>=draggerpar.innerHeight()-dragger.innerHeight()&&isVertical||!isVertical&&x>=draggerpar.innerWidth()-dragger.innerWidth()?!vmodel.breakOutCallback&&avalon(getByClassName("oni-scrollbar-arrow-down",bar[0])[0]).addClass("oni-state-disabled"):avalon(getByClassName("oni-scrollbar-arrow-down",bar[0])[0]).removeClass("oni-state-disabled")}}}else if(bar){bar.css("opacity",0);bar.css("visibility","hidden");bar.data("oni-scrollbar-needed",!1)}})}};vm._arrClick=function(e,diretion,position,barIndex){vmodel.disabled||vmodel._computer(function(obj){return vmodel._clickComputer(obj,diretion)},barIndex,position)};vm._clickComputer=function(obj,diretion,step){var step=step||obj.step||40,l=strToNumber(obj.dragger.css("left"))>>0,r=strToNumber(obj.dragger.css("top"))>>0,x="down"==diretion?l+step:l-step,y="down"==diretion?r+step:r-step;return{x:x,y:y}};vm._arrDown=function($event,diretion,position,barIndex,ismouseup){if(!vmodel.disabled){var se=this,ele=avalon(se);clearInterval(ele.data("mousedownTimer"));clearTimeout(ele.data("setTimer"));bars[barIndex];if(ismouseup||ele.hasClass("oni-state-disabled"))return ele.removeClass("oni-state-active");ele.data("setTimer",setTimeout(function(){ele.addClass("oni-state-active");ele.data("mousedownTimer",setInterval(function(){return vmodel._computer(function(obj){return vmodel._clickComputer(obj,diretion)},barIndex,position,function(breakOut){if(breakOut){clearInterval(ele.data("mousedownTimer"));clearTimeout(ele.data("setTimer"))}})},120))},10))}};vm._barClick=function(e,position,barIndex){if(!vmodel.disabled){var ele=avalon(this);ele.hasClass("oni-scrollbar-dragger")||vmodel._computer(function(obj){return{x:Math.ceil(e.pageX-obj.offset.left-obj.draggerWidth/2),y:Math.ceil(e.pageY-obj.offset.top-obj.draggerHeight/2)}},barIndex,position)}};vm._computer=function(axisComputer,barIndex,position,callback,breakOutCallbackCannotIgnore){if(!vmodel.disabled){var bar=bars[barIndex];if(bar&&bar.data("oni-scrollbar-needed")){var obj={},isVertical=position.match(/left|right/g);obj.dragger=avalon(getByClassName("oni-scrollbar-dragger",bar[0])[0]);obj.draggerWidth=strToNumber(obj.dragger.css("width"));obj.draggerHeight=strToNumber(obj.dragger.css("height"));obj.draggerpar=avalon(obj.dragger[0].parentNode);obj.draggerparWidth=strToNumber(obj.draggerpar.css("width"));obj.draggerparHeight=strToNumber(obj.draggerpar.css("height"));obj.offset=obj.draggerpar.offset();obj.up=avalon(getByClassName("oni-scrollbar-arrow-up",bar[0])[0]);obj.down=avalon(getByClassName("oni-scrollbar-arrow-down",bar[0])[0]);obj.viewer=avalon(vmodel.viewElement);obj.viewH=scroller.innerHeight();obj.viewW=scroller.innerWidth();obj.scrollerH=scroller[0].scrollHeight;obj.scrollerW=scroller[0].scrollWidth;obj.step=isVertical?40*(obj.draggerparHeight-obj.draggerHeight)/(obj.scrollerH-obj.viewH):40*(obj.draggerparWidth-obj.draggerWidth)/(obj.scrollerW-obj.viewW);obj.step=strToNumber(obj.step)||1;var breakOut,xy=axisComputer(obj);xy.x=strToNumber(xy.x);xy.y=strToNumber(xy.y);if(isVertical){if(xy.y<0){xy.y=0;obj.up.addClass("oni-state-disabled");breakOut=["v","up"]}else obj.up.removeClass("oni-state-disabled");if(xy.y>obj.draggerparHeight-obj.draggerHeight){xy.y=obj.draggerparHeight-obj.draggerHeight;breakOut=["v","down"];obj.down.addClass("oni-state-disabled")}else obj.down.removeClass("oni-state-disabled");strToNumber((obj.scrollerH-obj.viewH)*xy.y/(obj.draggerparHeight-obj.draggerHeight))-vmodel.scrollTop;obj.dragger.css("top",xy.y);vmodel._scrollTo(void 0,strToNumber((obj.scrollerH-obj.viewH)*xy.y/(obj.draggerparHeight-obj.draggerHeight)))}else{if(xy.x<0){xy.x=0;breakOut=["h","up"];obj.up.addClass("oni-state-disabled")}else obj.up.removeClass("oni-state-disabled");if(xy.x>obj.draggerparWidth-obj.draggerWidth){xy.x=obj.draggerparWidth-obj.draggerWidth;breakOut=["h","down"];!vmodel.breakOutCallback&&obj.down.addClass("oni-state-disabled")}else obj.down.removeClass("oni-state-disabled");obj.dragger.css("left",xy.x);vmodel._scrollTo(strToNumber((obj.scrollerW-obj.viewW)*xy.x/(obj.draggerparWidth-obj.draggerWidth)),void 0)}}(!vmodel.breakOutCallback||breakOutCallbackCannotIgnore)&&callback&&callback(breakOut);vmodel.breakOutCallback&&vmodel.breakOutCallback(breakOut,vmodel,obj)}};vm._scrollTo=function(x,y){if(void 0!=y){scroller[0].scrollTop=y;vmodel.scrollTop=scroller[0].scrollTop}if(void 0!=x){scroller[0].scrollLeft=x;vmodel.scrollLeft=scroller[0].scrollLeft}};vm.scrollTo=function(x,y){vmodel.update(!1,x,y);vm._scrollTo(x,y)};vm._initWheel=function(e,type){"enter"==type?vmodel.inFocuse=!0:vmodel.inFocuse=!1};vm._draggerDown=function(e,isdown){if(!vmodel.disabled){var ele=avalon(this);isdown?ele.addClass("oni-state-active"):ele.removeClass("oni-state-active")}};vm._stopPropagation=function(e){e.stopPropagation()}});vmodel.$watch("scrollLeft",function(newValue,oldValue){vmodel._onScroll();vmodel.onScroll&&vmodel.onScroll(newValue,oldValue,"h",vmodel)});vmodel.$watch("scrollTop",function(newValue,oldValue){vmodel._onScroll();vmodel.onScroll&&vmodel.onScroll(newValue,oldValue,"v",vmodel)});return vmodel};widget.defaults={disabled:!1,toggle:!0,position:"right",limitRateV:1.5,limitRateH:1.5,scrollTop:0,scrollLeft:0,show:"always",showBarHeader:!0,draggerHTML:"",breakOutCallback:!1,onInit:avalon.noop,viewHeightGetter:function(viewElement){return viewElement.innerHeight()},viewWidthGetter:function(viewElement){return viewElement.innerWidth()},getTemplate:function(tmpl,opts){return tmpl},onScroll:function(newValue,oldValue,diretion,vmodel){},size:"normal",$author:"skipper@123"}});