define(["avalon","text!./avalon.dropdown.html","../avalon.getModel","../scrollbar/avalon.scrollbar","css!../chameleon/oniui-common.css","css!./avalon.dropdown.css"],function(avalon,template){function parseData(data){try{data="true"===data?!0:"false"===data?!1:"null"===data?null:+data+""===data?+data:data}catch(e){}return data}function getDataFromOption(data,arr,parent){var ret=arr||[];parent=parent||null;for(var el,i=0;el=data[i++];)if(Array.isArray(el.options)){ret.push({label:el.label,value:el.value,enable:ensureBool(el.enable,!0),group:!0,parent:parent,toggle:!0});getDataFromOption(el.options,ret,el)}else{"string"==typeof el&&(el={label:el,value:el,title:el});ret.push({label:el.label,value:el.value,title:el.title,enable:ensureBool(parent&&parent.enable,!0)&&ensureBool(el.enable,!0),group:!1,parent:parent,data:el,toggle:!0})}return ret}function getFragmentFromData(data){for(var parent,node,el,ret=document.createDocumentFragment(),i=0;el=data[i++];)if(el.group){node=document.createElement("optgroup");node.label=el.label;node.disabled=!el.enable;ret.appendChild(node);parent=node}else{node=document.createElement("option");node.text=el.label;node.value=el.value;node.disabled=!el.enable;el.parent&&parent?parent.appendChild(node):ret.appendChild(node)}return ret}function ensureBool(value,defaultValue){return"boolean"==typeof value?value:defaultValue}function getDataFromHTML(select,arr,parent){var ret=arr||[],elems=select.children;parent=parent||null;for(var el,i=0;el=elems[i++];)if(1===el.nodeType)if("OPTGROUP"===el.tagName){parent={label:el.label,value:"",enable:!el.disabled,group:!0,parent:!1,toggle:!0};ret.push(parent);getDataFromHTML(el,ret,parent)}else"OPTION"===el.tagName&&ret.push({label:el.label.trim()||el.text.trim()||el.value.trim(),title:el.title.trim(),value:parseData(el.value.trim()||el.text.trim()),enable:ensureBool(parent&&parent.enable,!0)&&!el.disabled,group:!1,parent:parent,toggle:!0});return ret}function getEnableOption(data,index,direction){var i,ret,size=data.size(),left=[],right=[],dataItem={};for(i=0;index>i;i++){dataItem=data[i];dataItem.enable&&!dataItem.group&&dataItem.toggle&&left.push(i)}for(i=index+1;size>i;i++){dataItem=data[i];dataItem.enable&&!dataItem.group&&dataItem.toggle&&right.push(i)}ret=0===left.length&&0===right.length?null:direction?right.length>0?right.shift():left.shift():left.length>0?left.pop():right.pop();return ret}function siblings(n){for(var r=[];n;n=n.nextSibling)1===n.nodeType&&r.push(n);return r}var styleReg=/^(\d+).*$/,ie6=!-[1]&&!window.XMLHttpRequest,widget=avalon.ui.dropdown=function(element,data,vmodels){function optionsSync(){avalon.each(element.getElementsByTagName("option"),function(i,option){if(vmodel.value.$model.indexOf(option.value)>-1||vmodel.value.$model.indexOf(parseData(option.value))>-1)try{option.selected=!0}catch(e){avalon(option).attr("selected","selected")}else try{option.selected=!1}catch(e){option.removeAttribute("selected")}})}function _buildOptions(opt){var duplexModel,duplexName=(element.msData["ms-duplex"]||"").trim();if(duplexName&&(duplexModel=avalon.getModel(duplexName,vmodels))){opt.value=duplexModel[1][duplexModel[0]];opt.$hasDuplex=!0}else if(hasBuiltinTemplate){var values=[];Array.prototype.forEach.call(element.options,function(option){option.selected&&values.push(parseData(option.value))});opt.value=values}else Array.isArray(opt.value)||(opt.value=[opt.value||""]);if(!opt.multiple){Array.isArray(opt.value)&&(opt.value=void 0!==opt.value[0]?opt.value[0]:"");var option=opt.data.filter(function(item){return item.value===opt.value&&!item.group}),options=opt.data.filter(function(item){return!item.group});if(0===option.length&&options.length>0){opt.value=options[0].value;duplexModel&&(duplexModel[1][duplexModel[0]]=opt.value)}}var changedCallbackModel,changedCallbackName=$element.attr("data-duplex-changed");changedCallbackName&&(changedCallbackModel=avalon.getModel(changedCallbackName,vmodels))&&(opt.changedCallback=changedCallbackModel[1][changedCallbackModel[0]]);opt.duplexName=duplexName;var docBody=document.body,container=opt.container;opt.container=("object"===avalon.type(container)&&1===container.nodeType&&docBody.contains(container)?container:document.getElementById(container))||docBody}function createListNode(){return avalon.parseHTML(listTemplate)}function setLabelTitle(value){vmodel.multiple||"array"!==avalon.type(value)||(value=value[0]);var option=vmodel.data.$model.filter(function(item){return item.value===value});option=option.length>0?option[0]:null;if(!option&&vmodel.data.length)avalon.log("[log] avalon.dropdown 设置label出错");else if(option){vmodel.label=option.label;vmodel.title=option.title||option.label||""}return option}function computeTitleWidth(){var title=document.getElementById("title-"+vmodel.$id),$title=avalon(title);return title?vmodel.width-$title.css("paddingLeft").replace(styleReg,"$1")-$title.css("paddingRight").replace(styleReg,"$1"):"auto"}function _positionListNode(){!vmodel.multiple&&listNode&&vmodel._position()}var dataSource,dataModel,templates,titleTemplate,listTemplate,blurHandler,scrollHandler,resizeHandler,$element=avalon(element),elemParent=element.parentNode,options=data.dropdownOptions,hasBuiltinTemplate=!0,keepState=!1;"multiple,size".replace(avalon.rword,function(name){hasAttribute(element,name)&&(options[name]=element[name])});options.enable=!element.disabled;templates=options.template=options.getTemplate(template,options).replace(/MS_OPTION_ID/g,data.dropdownId).split("MS_OPTION_TEMPLATE");titleTemplate=templates[0];listTemplate=templates[1];dataSource=options.data.$model||options.data;element.removeAttribute("ms-duplex");avalon.scan(element,vmodels);dataModel=getDataFromHTML(element);hasBuiltinTemplate=!!dataModel.length;0===dataModel.length&&(dataModel=getDataFromOption(dataSource));options.data=dataModel;avalon(element).css("display","none");_buildOptions(options);for(var i=0,n=dataModel.length;n>i;i++)if(dataModel[i].value==options.value){options.activeIndex=i;options.currentOption=avalon.mix(!0,{},dataModel[i]);break}var titleNode,listNode,vmodel=avalon.define(data.dropdownId,function(vm){avalon.mix(vm,options);vm.$skipArray=["widgetElement","duplexName","menuNode","dropdownNode","scrollWidget","rootElement"];vm.multiple&&vm.$hasDuplex&&-1===vm.$skipArray.indexOf("value")&&vm.$skipArray.push("value");vm.render=function(data){if(void 0!==data){vmodel.data=getDataFromOption(data.$model||data);vmodel._styleFix(!0)}};vm.widgetElement=element;vm.rootElement={};vm.menuWidth="auto";vm.menuHeight=vm.height;vm.dataSource=dataSource;vm.focusClass=!1;vm.$init=function(continueScan){if(vmodel.multiple){listNode=createListNode();var list=listNode.firstChild;elemParent.insertBefore(listNode,element);list.appendChild(element)}else{var title;titleNode=avalon.parseHTML(titleTemplate);title=titleNode.firstChild;elemParent.insertBefore(titleNode,element);title.appendChild(element);titleNode=title;vmodel.titleWidth=computeTitleWidth();setLabelTitle(vmodel.value);blurHandler=avalon.bind(document.body,"click",function(e){titleNode.contains(e.target)?vmodel._toggle():listNode&&listNode.contains(e.target)||vmodel.__cursorInList__||vmodel.multiple||!vmodel.toggle||(vmodel.toggle=!1)});if(vmodel.position){scrollHandler=avalon.bind(window,"scroll",_positionListNode);resizeHandler=avalon.bind(window,"resize",_positionListNode)}}if(!hasBuiltinTemplate){element.appendChild(getFragmentFromData(dataModel));avalon.each(["multiple","size"],function(i,attr){avalon(element).attr(attr,vmodel[attr])})}if(vmodel.multiple)vmodel.value.$watch("length",function(){vmodel.multipleChange=!vmodel.multipleChange;optionsSync()});else{var duplexModel,duplexName=(element.msData["ms-duplex"]||"").trim();duplexName&&(duplexModel=avalon.getModel(duplexName,vmodels))&&duplexModel[1].$watch(duplexModel[0],function(newValue){vmodel.value=newValue});vmodel.$watch("value",function(n,o){avalon.nextTick(function(){function valueStateKeep(stateKeep){if(stateKeep){keepState=!0;vmodel.value=o}else{if(duplexModel){duplexModel[1][duplexModel[0]]=n;element.value=n}vmodel.currentOption=setLabelTitle(n)}}var onChange="function"===avalon.type(vmodel.onChange)&&vmodel.onChange||!1;if(keepState)keepState=!1;else if(onChange&&onChange.call(element,n,o,vmodel,valueStateKeep)!==!1||!onChange){if(duplexModel){duplexModel[1][duplexModel[0]]=n;element.value=n}vmodel.currentOption=setLabelTitle(n)}})})}var disabledModel,enabledModel,disabledAttr=element.msData["ms-disabled"],enabledAttr=element.msData["ms-enabled"];if(disabledAttr&&(disabledModel=avalon.getModel(disabledAttr,vmodels))){disabledModel[1].$watch(disabledModel[0],function(n){vmodel.enable=!n});vmodel.enable=!disabledModel[1][disabledModel[0]]}if(enabledAttr&&(enabledModel=avalon.getModel(enabledAttr,vmodels))){enabledModel[1].$watch(enabledModel[0],function(n){vmodel.enable=n});vmodel.enable=enabledModel[1][enabledModel[0]]}vmodel.enable=!element.disabled;var readOnlyModel,readOnlyAttr=vmodel.readonlyAttr;if(readOnlyAttr&&(readOnlyModel=avalon.getModel(readOnlyAttr,vmodels))){readOnlyModel[1].$watch(readOnlyModel[0],function(n){vmodel.readOnly=n});vmodel.readOnly=readOnlyModel[1][readOnlyModel[0]]}if(vmodel.$source){if("string"===avalon.type(vmodel.$source)){var sourceModel=avalon.getModel(vmodel.$source,vmodels);sourceModel&&(vmodel.$source=sourceModel[1][sourceModel[0]])}else vmodel.$source.$id?vmodel.$source.length>0&&vmodel._refresh(vmodel.$source.length):vmodel.$source=null;vmodel.$source&&vmodel.$source.$watch&&vmodel.$source.$watch("length",function(n){vmodel._refresh(n)})}avalon.scan(element.parentNode,[vmodel].concat(vmodels));if(continueScan)continueScan();else{avalon.log("请尽快升到avalon1.3.7+");"function"==typeof options.onInit&&options.onInit.call(element,vmodel,options,vmodels)}vmodel.multiple&&optionsSync()};vm.repeatRendered=function(){vmodel.multiple&&avalon.vmodels["scrollbar-"+vmodel.$id].update()};vm.$remove=function(){blurHandler&&avalon.unbind(window,"click",blurHandler);scrollHandler&&avalon.unbind(window,"scroll",scrollHandler);resizeHandler&&avalon.unbind(window,"resize",resizeHandler);vmodel.toggle=!1;listNode&&vmodel.container&&vmodel.container.contains(listNode)&&vmodel.container.removeChild(listNode);avalon.log("dropdown $remove")};vm._select=function(index,event){var option=vmodel.data[index].$model;if(option&&option.enable&&!option.group){var oldValue=vmodel.value;if(vmodel.multiple){index=vmodel.value.indexOf(option.value);index>-1?vmodel.value.splice(index,1):vmodel.value.push(option.value)}else vmodel.value=option.value;vmodel.toggle=!1;"function"===avalon.type(vmodel.onSelect)&&vmodel.onSelect.call(element,event,vmodel.value,oldValue,vmodel);vmodel.activeIndex=index}};vm._refresh=function(len){vmodel.data.clear();vmodel.label="";vmodel.__cursorInList__=!1;if(len>0){vmodel._disabledScrollbar(!1);vmodel.data.pushArray(getDataFromOption(vmodel.$source.$model||vmodel.$source));var option;if(option=setLabelTitle(vmodel.value))vmodel.activeIndex=vmodel.data.$model.indexOf(option);else{vmodel.currentOption=vmodel.data[0].$model;vmodel.activeIndex=0;var v=vmodel.data[0].value;!vmodel.multiple||v instanceof Array||(v=[v]);setLabelTitle(vmodel.value=v)}vmodel.menuNode&&vmodel._styleFix(!0)}};vm._titleenter=function(){vmodel.hoverAutoShow&&vmodel._toggle()};vm._titleleave=function(){vmodel.hoverAutoShow&&(vmodel.toggle=!1)};vm._keydown=function(event){if(vmodel.keyboardEvent!==!1&&!vmodel.multiple){var index=vmodel.activeIndex||0,oldValue=vmodel.value;switch(event.keyCode){case 9:case 27:event.preventDefault();break;case 13:vmodel._select(index,event);break;case 38:case 63233:event.preventDefault();index=getEnableOption(vmodel.data,index);if(null===index)return;vmodel.value=vmodel.data[index].value;vmodel.activeIndex=index;vmodel.scrollTo(index);"function"===avalon.type(vmodel.onSelect)&&vmodel.onSelect.call(element,event,vmodel.value,oldValue,vmodel);break;case 40:case 63235:event.preventDefault();index=getEnableOption(vmodel.data,index,!0);if(null===index)return;vmodel.value=vmodel.data[index].value;vmodel.activeIndex=index;vmodel.scrollTo(index);"function"===avalon.type(vmodel.onSelect)&&vmodel.onSelect.call(element,event,vmodel.value,oldValue,vmodel)}}};vm._toggle=function(b){if(0===vmodel.data.length&&!vmodel.realTimeData||!vmodel.enable||vmodel.readOnly)vmodel.toggle=!1;else{if(!listNode){var list;listNode=createListNode();list=listNode.firstChild;vmodel.container.appendChild(listNode);listNode=list;vm.rootElement=list;avalon.scan(list,[vmodel].concat(vmodels));vmodel.menuNode=document.getElementById("menu-"+vmodel.$id);vmodel.dropdownNode=document.getElementById("list-"+vmodel.$id)}if("boolean"==typeof b)if(b){var firstItemIndex,selectedItemIndex,value=vmodel.value;"array"!==avalon.type(value)&&(value=[value]);if(null==vmodel.activeIndex){avalon.each(vmodel.data,function(i,item){void 0===firstItemIndex&&item.enable&&(firstItemIndex=i);if(item.value===value[0]){selectedItemIndex=i;return!1}return!0});selectedItemIndex||(selectedItemIndex=firstItemIndex);vmodel.activeIndex=selectedItemIndex||0}vmodel.scrollWidget=avalon.vmodels["scrollbar-"+vmodel.$id];vmodel._styleFix();vmodel._position();"function"===avalon.type(vmodel.onShow)&&vmodel.onShow.call(element,listNode,vmodel)}else"function"===avalon.type(vmodel.onHide)&&vmodel.onHide.call(element,listNode,vmodel);else vmodel.toggle=!vmodel.toggle}};vm.$watch("toggle",function(b){vmodel.focusClass=b;vmodel._toggle(b)});vm.toggle=!1;vm._position=function(){for(var $titleNode=avalon(titleNode),offset=$titleNode.offset(),outerHeight=$titleNode.outerHeight(!0),$listNode=avalon(listNode),$sourceNode=avalon(titleNode.firstChild),listHeight=$listNode.height(),$window=avalon(window),css={},offsetParent=listNode.offsetParent,$offsetParent=avalon(offsetParent);$sourceNode.element&&1!=$sourceNode.element.nodeType;)$sourceNode=avalon($sourceNode.element.nextSibling);if(options.position&&offset.top+outerHeight+listHeight>$window.scrollTop()+$window.height()&&offset.top-listHeight>$window.scrollTop()){css.top=offset.top-listHeight;$listNode.addClass("m-up");$sourceNode.addClass("m-up")}else{$listNode.removeClass("m-up");$sourceNode.removeClass("m-up");css.top=offset.top+outerHeight-$sourceNode.css("borderBottomWidth").replace(styleReg,"$1")}if(offsetParent&&"BODY"!==offsetParent.tagName&&"HTML"!==offsetParent.tagName){css.top=css.top-$offsetParent.offset().top+listNode.offsetParent.scrollTop;css.left=offset.left-$offsetParent.offset().left+listNode.offsetParent.scrollLeft}else css.left=offset.left;$listNode.css(css)};vm.__cursorInList__=!1;vm._listenter=function(){vmodel.__cursorInList__=!0;vmodel.hoverAutoShow&&(vmodel.toggle=!0)};vm._listleave=function(){vmodel.__cursorInList__=!1;vmodel.hoverAutoShow&&(vmodel.toggle=!1)};vm._blur=function(){vmodel.__cursorInList__||vmodel.multiple||!vmodel.toggle||(vmodel.toggle=!1)};vm.val=function(newValue){if("undefined"!=typeof newValue){"array"!==avalon.type(newValue)&&(newValue=[newValue]);vmodel.value=newValue}return vmodel.value};vm.isActive=function(el){var value=el.value,enable=el.enable,group=el.group;return vmodel.multiple?vmodel.value.indexOf(value)>-1&&enable&&!group:vmodel.value===value&&enable&&!group};vm._styleFix=function(resetHeight){var MAX_HEIGHT=options.height||200,$menu=avalon(vmodel.menuNode),height="";if(resetHeight){vmodel.menuHeight="";avalon(vmodel.dropdownNode).css({height:""})}height=vmodel.dropdownNode.scrollHeight;vmodel.menuWidth=ie6?vmodel.listWidth:vmodel.listWidth-$menu.css("borderLeftWidth").replace(styleReg,"$1")-$menu.css("borderRightWidth").replace(styleReg,"$1");if(height>MAX_HEIGHT){vmodel._disabledScrollbar(!1);height=MAX_HEIGHT;avalon(vmodel.dropdownNode).css({width:vmodel.menuWidth-vmodel.scrollWidget.getBars()[0].width()})}else{vmodel._disabledScrollbar(!0);avalon(vmodel.dropdownNode).css({width:vmodel.menuWidth})}vmodel.menuHeight=height;vmodel.updateScrollbar();vmodel.scrollTo(vmodel.activeIndex)};vm.updateScrollbar=function(){vmodel.scrollWidget.update()};vm.scrollTo=function(activeIndex){if(vmodel.dropdownNode){var nodes=siblings(vmodel.dropdownNode.firstChild),$activeNode=avalon(nodes[activeIndex]),menuHeight=vmodel.menuHeight,nodeTop=nodes.length?$activeNode.position().top-avalon(nodes[0]).position().top:0,nodeHeight=nodes.length?$activeNode.height():0,scrollTop=vmodel.dropdownNode.scrollTop;(nodeTop>scrollTop+menuHeight-nodeHeight||scrollTop>nodeTop+nodeHeight)&&vmodel.scrollWidget.scrollTo(0,nodeTop+nodeHeight-menuHeight)}};vm._disabledScrollbar=function(b){vmodel.scrollWidget&&(vmodel.scrollWidget.disabled=!!b)}});vmodel.$watch("enable",function(n){n||(vmodel.toggle=!1)});vmodel.$watch("readOnly",function(n){n&&(vmodel.toggle=!1)});return vmodel};widget.version="1.0";widget.defaults={realTimeData:!1,container:null,width:200,listWidth:200,titleWidth:0,height:200,enable:!0,readOnly:!1,hoverAutoShow:!1,readonlyAttr:null,currentOption:null,data:[],$source:null,textFiled:"text",valueField:"value",value:[],label:"",multiple:!1,listClass:"",title:"",titleClass:"",activeIndex:null,size:1,menuNode:null,dropdownNode:null,scrollWidget:null,position:!0,onSelect:null,onShow:null,onHide:null,onChange:null,$hasDuplex:!1,multipleChange:!1,keyboardEvent:!0,getTemplate:function(str,options){return str},onInit:avalon.noop};var hasAttribute=document.documentElement.hasAttribute?function(el,attr){return el.hasAttribute(attr)}:function(el,attr){var outer=el.outerHTML,part=outer.slice(0,outer.search(/\/?['"]?>(?![^<]*<['"])/));return new RegExp("\\s"+attr+"\\b","i").test(part)};return avalon});