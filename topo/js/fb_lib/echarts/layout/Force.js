define(["require","./forceLayoutWorker","zrender/tool/vector"],function(require){function createWorkerUrl(){if("undefined"!=typeof Worker&&"undefined"!=typeof Blob)try{var blob=new Blob([ForceLayoutWorker.getWorkerCode()]);workerUrl=window.URL.createObjectURL(blob)}catch(e){workerUrl=""}return workerUrl}var workerUrl,ForceLayoutWorker=require("./forceLayoutWorker"),vec2=require("zrender/tool/vector"),requestAnimationFrame=window.requestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(func){setTimeout(func,16)},ArrayCtor="undefined"==typeof Float32Array?Array:Float32Array,ForceLayout=function(opts){"undefined"==typeof workerUrl&&createWorkerUrl();opts=opts||{};this.width=opts.width||500;this.height=opts.height||500;this.center=opts.center||[this.width/2,this.height/2];this.ratioScaling=opts.ratioScaling||!1;this.scaling=opts.scaling||1;this.gravity="undefined"!=typeof opts.gravity?opts.gravity:1;this.large=opts.large||!1;this.preventNodeOverlap=opts.preventNodeOverlap||!1;this.preventNodeEdgeOverlap=opts.preventNodeEdgeOverlap||!1;this.maxSpeedIncrease=opts.maxSpeedIncrease||1;this.onupdate=opts.onupdate||function(){};this.temperature=opts.temperature||1;this.coolDown=opts.coolDown||.99;this._layout=null;this._layoutWorker=null;var self=this,_$onupdate=this._$onupdate;this._$onupdate=function(e){_$onupdate.call(self,e)}};ForceLayout.prototype.updateConfig=function(){var width=this.width,height=this.height,size=Math.min(width,height),config={center:this.center,width:this.ratioScaling?width:size,height:this.ratioScaling?height:size,scaling:this.scaling||1,gravity:this.gravity||1,barnesHutOptimize:this.large,preventNodeOverlap:this.preventNodeOverlap,preventNodeEdgeOverlap:this.preventNodeEdgeOverlap,maxSpeedIncrease:this.maxSpeedIncrease};if(this._layoutWorker)this._layoutWorker.postMessage({cmd:"updateConfig",config:config});else for(var name in config)this._layout[name]=config[name]};ForceLayout.prototype.init=function(graph,useWorker){if(this._layoutWorker){this._layoutWorker.terminate();this._layoutWorker=null}if(workerUrl&&useWorker)try{if(!this._layoutWorker){this._layoutWorker=new Worker(workerUrl);this._layoutWorker.onmessage=this._$onupdate}this._layout=null}catch(e){this._layoutWorker=null;this._layout||(this._layout=new ForceLayoutWorker)}else this._layout||(this._layout=new ForceLayoutWorker);this.temperature=1;this.graph=graph;for(var len=graph.nodes.length,positionArr=new ArrayCtor(2*len),massArr=new ArrayCtor(len),sizeArr=new ArrayCtor(len),i=0;len>i;i++){var n=graph.nodes[i];positionArr[2*i]=n.layout.position[0];positionArr[2*i+1]=n.layout.position[1];massArr[i]="undefined"==typeof n.layout.mass?1:n.layout.mass;sizeArr[i]="undefined"==typeof n.layout.size?1:n.layout.size;n.layout.__index=i}len=graph.edges.length;for(var edgeArr=new ArrayCtor(2*len),edgeWeightArr=new ArrayCtor(len),i=0;len>i;i++){var edge=graph.edges[i];edgeArr[2*i]=edge.node1.layout.__index;edgeArr[2*i+1]=edge.node2.layout.__index;edgeWeightArr[i]=edge.layout.weight||1}if(this._layoutWorker)this._layoutWorker.postMessage({cmd:"init",nodesPosition:positionArr,nodesMass:massArr,nodesSize:sizeArr,edges:edgeArr,edgesWeight:edgeWeightArr});else{this._layout.initNodes(positionArr,massArr,sizeArr);this._layout.initEdges(edgeArr,edgeWeightArr)}this.updateConfig()};ForceLayout.prototype.step=function(steps){var nodes=this.graph.nodes;if(this._layoutWorker){for(var positionArr=new ArrayCtor(2*nodes.length),i=0;i<nodes.length;i++){var n=nodes[i];positionArr[2*i]=n.layout.position[0];positionArr[2*i+1]=n.layout.position[1]}this._layoutWorker.postMessage(positionArr.buffer,[positionArr.buffer]);this._layoutWorker.postMessage({cmd:"update",steps:steps,temperature:this.temperature,coolDown:this.coolDown});for(var i=0;steps>i;i++)this.temperature*=this.coolDown}else{requestAnimationFrame(this._$onupdate);for(var i=0;i<nodes.length;i++){var n=nodes[i];vec2.copy(this._layout.nodes[i].position,n.layout.position)}for(var i=0;steps>i;i++){this._layout.temperature=this.temperature;this._layout.update();this.temperature*=this.coolDown}}};ForceLayout.prototype._$onupdate=function(e){if(this._layoutWorker){for(var positionArr=new Float32Array(e.data),i=0;i<this.graph.nodes.length;i++){var n=this.graph.nodes[i];n.layout.position[0]=positionArr[2*i];n.layout.position[1]=positionArr[2*i+1]}this.onupdate&&this.onupdate()}else if(this._layout){for(var i=0;i<this.graph.nodes.length;i++){var n=this.graph.nodes[i];vec2.copy(n.layout.position,this._layout.nodes[i].position)}this.onupdate&&this.onupdate()}};ForceLayout.prototype.dispose=function(){this._layoutWorker&&this._layoutWorker.terminate();this._layoutWorker=null;this._layout=null};return ForceLayout});