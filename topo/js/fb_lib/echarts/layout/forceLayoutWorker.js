define(["require","zrender/tool/vector"],function __echartsForceLayoutWorker(require){"use strict";function Region(){this.subRegions=[];this.nSubRegions=0;this.node=null;this.mass=0;this.centerOfMass=null;this.bbox=new ArrayCtor(4);this.size=0}function GraphNode(){this.position=vec2.create();this.force=vec2.create();this.forcePrev=vec2.create();this.speed=vec2.create();this.speedPrev=vec2.create();this.mass=1;this.inDegree=0;this.outDegree=0}function GraphEdge(node1,node2){this.node1=node1;this.node2=node2;this.weight=1}function ForceLayout(){this.barnesHutOptimize=!1;this.barnesHutTheta=1.5;this.repulsionByDegree=!1;this.preventNodeOverlap=!1;this.preventNodeEdgeOverlap=!1;this.strongGravity=!0;this.gravity=1;this.scaling=1;this.edgeWeightInfluence=1;this.center=[0,0];this.width=500;this.height=500;this.maxSpeedIncrease=1;this.nodes=[];this.edges=[];this.bbox=new ArrayCtor(4);this._rootRegion=new Region;this._rootRegion.centerOfMass=vec2.create();this._massArr=null;this._k=0}var vec2,inWorker="undefined"==typeof window&&"undefined"==typeof require;vec2=inWorker?{create:function(x,y){var out=new Float32Array(2);out[0]=x||0;out[1]=y||0;return out},dist:function(a,b){var x=b[0]-a[0],y=b[1]-a[1];return Math.sqrt(x*x+y*y)},len:function(a){var x=a[0],y=a[1];return Math.sqrt(x*x+y*y)},scaleAndAdd:function(out,a,b,scale){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;return out},scale:function(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;return out},add:function(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];return out},sub:function(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];return out},dot:function(v1,v2){return v1[0]*v2[0]+v1[1]*v2[1]},normalize:function(out,a){var x=a[0],y=a[1],len=x*x+y*y;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len}return out},negate:function(out,a){out[0]=-a[0];out[1]=-a[1];return out},copy:function(out,a){out[0]=a[0];out[1]=a[1];return out},set:function(out,x,y){out[0]=x;out[1]=y;return out}}:require("zrender/tool/vector");var ArrayCtor="undefined"==typeof Float32Array?Array:Float32Array;Region.prototype.beforeUpdate=function(){for(var i=0;i<this.nSubRegions;i++)this.subRegions[i].beforeUpdate();this.mass=0;if(this.centerOfMass){this.centerOfMass[0]=0;this.centerOfMass[1]=0}this.nSubRegions=0;this.node=null};Region.prototype.afterUpdate=function(){this.subRegions.length=this.nSubRegions;for(var i=0;i<this.nSubRegions;i++)this.subRegions[i].afterUpdate()};Region.prototype.addNode=function(node){if(0===this.nSubRegions){if(null==this.node){this.node=node;return}this._addNodeToSubRegion(this.node);this.node=null}this._addNodeToSubRegion(node);this._updateCenterOfMass(node)};Region.prototype.findSubRegion=function(x,y){for(var i=0;i<this.nSubRegions;i++){var region=this.subRegions[i];if(region.contain(x,y))return region}};Region.prototype.contain=function(x,y){return this.bbox[0]<=x&&this.bbox[2]>=x&&this.bbox[1]<=y&&this.bbox[3]>=y};Region.prototype.setBBox=function(minX,minY,maxX,maxY){this.bbox[0]=minX;this.bbox[1]=minY;this.bbox[2]=maxX;this.bbox[3]=maxY;this.size=(maxX-minX+maxY-minY)/2};Region.prototype._newSubRegion=function(){var subRegion=this.subRegions[this.nSubRegions];if(!subRegion){subRegion=new Region;this.subRegions[this.nSubRegions]=subRegion}this.nSubRegions++;return subRegion};Region.prototype._addNodeToSubRegion=function(node){var subRegion=this.findSubRegion(node.position[0],node.position[1]),bbox=this.bbox;if(!subRegion){var cx=(bbox[0]+bbox[2])/2,cy=(bbox[1]+bbox[3])/2,w=(bbox[2]-bbox[0])/2,h=(bbox[3]-bbox[1])/2,xi=node.position[0]>=cx?1:0,yi=node.position[1]>=cy?1:0,subRegion=this._newSubRegion();subRegion.setBBox(xi*w+bbox[0],yi*h+bbox[1],(xi+1)*w+bbox[0],(yi+1)*h+bbox[1])}subRegion.addNode(node)};Region.prototype._updateCenterOfMass=function(node){null==this.centerOfMass&&(this.centerOfMass=vec2.create());var x=this.centerOfMass[0]*this.mass,y=this.centerOfMass[1]*this.mass;x+=node.position[0]*node.mass;y+=node.position[1]*node.mass;this.mass+=node.mass;this.centerOfMass[0]=x/this.mass;this.centerOfMass[1]=y/this.mass};ForceLayout.prototype.nodeToNodeRepulsionFactor=function(mass,d,k){return k*k*mass/d};ForceLayout.prototype.edgeToNodeRepulsionFactor=function(mass,d,k){return k*mass/d};ForceLayout.prototype.attractionFactor=function(w,d,k){return w*d/k};ForceLayout.prototype.initNodes=function(positionArr,massArr,sizeArr){this.temperature=1;var nNodes=positionArr.length/2;this.nodes.length=0;for(var haveSize="undefined"!=typeof sizeArr,i=0;nNodes>i;i++){var node=new GraphNode;node.position[0]=positionArr[2*i];node.position[1]=positionArr[2*i+1];node.mass=massArr[i];haveSize&&(node.size=sizeArr[i]);this.nodes.push(node)}this._massArr=massArr;haveSize&&(this._sizeArr=sizeArr)};ForceLayout.prototype.initEdges=function(edgeArr,edgeWeightArr){var nEdges=edgeArr.length/2;this.edges.length=0;for(var edgeHaveWeight="undefined"!=typeof edgeWeightArr,i=0;nEdges>i;i++){var sIdx=edgeArr[2*i],tIdx=edgeArr[2*i+1],sNode=this.nodes[sIdx],tNode=this.nodes[tIdx];if(sNode&&tNode){sNode.outDegree++;tNode.inDegree++;var edge=new GraphEdge(sNode,tNode);edgeHaveWeight&&(edge.weight=edgeWeightArr[i]);this.edges.push(edge)}}};ForceLayout.prototype.update=function(){var nNodes=this.nodes.length;this.updateBBox();this._k=.4*this.scaling*Math.sqrt(this.width*this.height/nNodes);if(this.barnesHutOptimize){this._rootRegion.setBBox(this.bbox[0],this.bbox[1],this.bbox[2],this.bbox[3]);this._rootRegion.beforeUpdate();for(var i=0;nNodes>i;i++)this._rootRegion.addNode(this.nodes[i]);this._rootRegion.afterUpdate()}else{var mass=0,centerOfMass=this._rootRegion.centerOfMass;vec2.set(centerOfMass,0,0);for(var i=0;nNodes>i;i++){var node=this.nodes[i];mass+=node.mass;vec2.scaleAndAdd(centerOfMass,centerOfMass,node.position,node.mass)}mass>0&&vec2.scale(centerOfMass,centerOfMass,1/mass)}this.updateForce();this.updatePosition()};ForceLayout.prototype.updateForce=function(){for(var nNodes=this.nodes.length,i=0;nNodes>i;i++){var node=this.nodes[i];vec2.copy(node.forcePrev,node.force);vec2.copy(node.speedPrev,node.speed);vec2.set(node.force,0,0)}this.updateNodeNodeForce();this.gravity>0&&this.updateGravityForce();this.updateEdgeForce();this.preventNodeEdgeOverlap&&this.updateNodeEdgeForce()};ForceLayout.prototype.updatePosition=function(){for(var nNodes=this.nodes.length,v=vec2.create(),i=0;nNodes>i;i++){var node=this.nodes[i],speed=node.speed;vec2.scale(node.force,node.force,1/30);var df=vec2.len(node.force)+.1,scale=Math.min(df,500)/df;vec2.scale(node.force,node.force,scale);vec2.add(speed,speed,node.force);vec2.scale(speed,speed,this.temperature);vec2.sub(v,speed,node.speedPrev);var swing=vec2.len(v);if(swing>0){vec2.scale(v,v,1/swing);var base=vec2.len(node.speedPrev);if(base>0){swing=Math.min(swing/base,this.maxSpeedIncrease)*base;vec2.scaleAndAdd(speed,node.speedPrev,v,swing)}}var ds=vec2.len(speed),scale=Math.min(ds,100)/(ds+.1);vec2.scale(speed,speed,scale);vec2.add(node.position,node.position,speed)}};ForceLayout.prototype.updateNodeNodeForce=function(){for(var nNodes=this.nodes.length,i=0;nNodes>i;i++){var na=this.nodes[i];if(this.barnesHutOptimize)this.applyRegionToNodeRepulsion(this._rootRegion,na);else for(var j=i+1;nNodes>j;j++){var nb=this.nodes[j];this.applyNodeToNodeRepulsion(na,nb,!1)}}};ForceLayout.prototype.updateGravityForce=function(){for(var i=0;i<this.nodes.length;i++)this.applyNodeGravity(this.nodes[i])};ForceLayout.prototype.updateEdgeForce=function(){for(var i=0;i<this.edges.length;i++)this.applyEdgeAttraction(this.edges[i])};ForceLayout.prototype.updateNodeEdgeForce=function(){for(var i=0;i<this.nodes.length;i++)for(var j=0;j<this.edges.length;j++)this.applyEdgeToNodeRepulsion(this.edges[j],this.nodes[i])};ForceLayout.prototype.applyRegionToNodeRepulsion=function(){var v=vec2.create();return function(region,node){if(region.node)this.applyNodeToNodeRepulsion(region.node,node,!0);else{if(0===region.mass&&0===node.mass)return;vec2.sub(v,node.position,region.centerOfMass);var d2=v[0]*v[0]+v[1]*v[1];if(d2>this.barnesHutTheta*region.size*region.size){var factor=this._k*this._k*(node.mass+region.mass)/(d2+1);vec2.scaleAndAdd(node.force,node.force,v,2*factor)}else for(var i=0;i<region.nSubRegions;i++)this.applyRegionToNodeRepulsion(region.subRegions[i],node)}}}();ForceLayout.prototype.applyNodeToNodeRepulsion=function(){var v=vec2.create();return function(na,nb,oneWay){if(na!==nb&&(0!==na.mass||0!==nb.mass)){vec2.sub(v,na.position,nb.position);var d2=v[0]*v[0]+v[1]*v[1];if(0!==d2){var factor,mass=na.mass+nb.mass,d=Math.sqrt(d2);vec2.scale(v,v,1/d);if(this.preventNodeOverlap){d=d-na.size-nb.size;d>0?factor=this.nodeToNodeRepulsionFactor(mass,d,this._k):0>=d&&(factor=this._k*this._k*10*mass)}else factor=this.nodeToNodeRepulsionFactor(mass,d,this._k);oneWay||vec2.scaleAndAdd(na.force,na.force,v,2*factor);vec2.scaleAndAdd(nb.force,nb.force,v,2*-factor)}}}}();ForceLayout.prototype.applyEdgeAttraction=function(){var v=vec2.create();return function(edge){var na=edge.node1,nb=edge.node2;vec2.sub(v,na.position,nb.position);var w,d=vec2.len(v);w=0===this.edgeWeightInfluence?1:1==this.edgeWeightInfluence?edge.weight:Math.pow(edge.weight,this.edgeWeightInfluence);var factor;if(this.preventOverlap){d=d-na.size-nb.size;if(0>=d)return}var factor=this.attractionFactor(w,d,this._k);vec2.scaleAndAdd(na.force,na.force,v,-factor);vec2.scaleAndAdd(nb.force,nb.force,v,factor)}}();ForceLayout.prototype.applyNodeGravity=function(){var v=vec2.create();return function(node){vec2.sub(v,this.center,node.position);this.width>this.height?v[1]*=this.width/this.height:v[0]*=this.height/this.width;var d=vec2.len(v)/100;this.strongGravity?vec2.scaleAndAdd(node.force,node.force,v,d*this.gravity*node.mass):vec2.scaleAndAdd(node.force,node.force,v,this.gravity*node.mass/(d+1))}}();ForceLayout.prototype.applyEdgeToNodeRepulsion=function(){var v12=vec2.create(),v13=vec2.create(),p=vec2.create();return function(e,n3){var n1=e.node1,n2=e.node2;if(n1!==n3&&n2!==n3){vec2.sub(v12,n2.position,n1.position);vec2.sub(v13,n3.position,n1.position);var len12=vec2.len(v12);vec2.scale(v12,v12,1/len12);var len=vec2.dot(v12,v13);if(!(0>len||len>len12)){vec2.scaleAndAdd(p,n1.position,v12,len);var dist=vec2.dist(p,n3.position)-n3.size,factor=this.edgeToNodeRepulsionFactor(n3.mass,Math.max(dist,.1),100);vec2.sub(v12,n3.position,p);vec2.normalize(v12,v12);vec2.scaleAndAdd(n3.force,n3.force,v12,factor);vec2.scaleAndAdd(n1.force,n1.force,v12,-factor);vec2.scaleAndAdd(n2.force,n2.force,v12,-factor)}}}}();ForceLayout.prototype.updateBBox=function(){for(var minX=1/0,minY=1/0,maxX=-(1/0),maxY=-(1/0),i=0;i<this.nodes.length;i++){var pos=this.nodes[i].position;minX=Math.min(minX,pos[0]);minY=Math.min(minY,pos[1]);maxX=Math.max(maxX,pos[0]);maxY=Math.max(maxY,pos[1])}this.bbox[0]=minX;this.bbox[1]=minY;this.bbox[2]=maxX;this.bbox[3]=maxY};ForceLayout.getWorkerCode=function(){var str=__echartsForceLayoutWorker.toString();return str.slice(str.indexOf("{")+1,str.lastIndexOf("return"))};if(inWorker){var forceLayout=null;self.onmessage=function(e){if(e.data instanceof ArrayBuffer){if(!forceLayout)return;for(var positionArr=new Float32Array(e.data),nNodes=positionArr.length/2,i=0;nNodes>i;i++){var node=forceLayout.nodes[i];node.position[0]=positionArr[2*i];node.position[1]=positionArr[2*i+1]}}else switch(e.data.cmd){case"init":forceLayout||(forceLayout=new ForceLayout);forceLayout.initNodes(e.data.nodesPosition,e.data.nodesMass,e.data.nodesSize);forceLayout.initEdges(e.data.edges,e.data.edgesWeight);break;case"updateConfig":if(forceLayout)for(var name in e.data.config)forceLayout[name]=e.data.config[name];break;case"update":var steps=e.data.steps;if(forceLayout){var nNodes=forceLayout.nodes.length,positionArr=new Float32Array(2*nNodes);forceLayout.temperature=e.data.temperature;for(var i=0;steps>i;i++){forceLayout.update();forceLayout.temperature*=e.data.coolDown}for(var i=0;nNodes>i;i++){var node=forceLayout.nodes[i];positionArr[2*i]=node.position[0];positionArr[2*i+1]=node.position[1]}self.postMessage(positionArr.buffer,[positionArr.buffer])}else{var emptyArr=new Float32Array;self.postMessage(emptyArr.buffer,[emptyArr.buffer])}}}}return ForceLayout});