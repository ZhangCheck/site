define(["require"],function(require){function Heatmap(opt){this.option=opt;if(opt)for(var i in defaultOptions)void 0!==opt[i]?this.option[i]=opt[i]:this.option[i]=defaultOptions[i];else this.option=defaultOptions}var defaultOptions={blurSize:30,gradientColors:["blue","cyan","lime","yellow","red"],minAlpha:.05,valueScale:1,opacity:1},BRUSH_SIZE=20,GRADIENT_LEVELS=256;Heatmap.prototype={getCanvas:function(data,width,height){var brush=this._getBrush(),gradient=this._getGradient(),r=BRUSH_SIZE+this.option.blurSize,canvas=document.createElement("canvas");canvas.width=width;canvas.height=height;for(var ctx=canvas.getContext("2d"),len=data.length,i=0;len>i;++i){var p=data[i],x=p[0],y=p[1],value=p[2],alpha=Math.min(1,Math.max(value*this.option.valueScale||this.option.minAlpha,this.option.minAlpha));ctx.globalAlpha=alpha;ctx.drawImage(brush,x-r,y-r)}for(var imageData=ctx.getImageData(0,0,canvas.width,canvas.height),pixels=imageData.data,len=pixels.length/4;len--;){var id=4*len+3,alpha=pixels[id]/256,colorOffset=Math.floor(alpha*(GRADIENT_LEVELS-1));pixels[id-3]=gradient[4*colorOffset];pixels[id-2]=gradient[4*colorOffset+1];pixels[id-1]=gradient[4*colorOffset+2];pixels[id]*=this.option.opacity}ctx.putImageData(imageData,0,0);return canvas},_getBrush:function(){if(!this._brushCanvas){this._brushCanvas=document.createElement("canvas");var r=BRUSH_SIZE+this.option.blurSize,d=2*r;this._brushCanvas.width=d;this._brushCanvas.height=d;var ctx=this._brushCanvas.getContext("2d");ctx.shadowOffsetX=d;ctx.shadowBlur=this.option.blurSize;ctx.shadowColor="black";ctx.beginPath();ctx.arc(-r,r,BRUSH_SIZE,0,2*Math.PI,!0);ctx.closePath();ctx.fill()}return this._brushCanvas},_getGradient:function(){if(!this._gradientPixels){var levels=GRADIENT_LEVELS,canvas=document.createElement("canvas");canvas.width=1;canvas.height=levels;for(var ctx=canvas.getContext("2d"),gradient=ctx.createLinearGradient(0,0,0,levels),len=this.option.gradientColors.length,i=0;len>i;++i)"string"==typeof this.option.gradientColors[i]?gradient.addColorStop((i+1)/len,this.option.gradientColors[i]):gradient.addColorStop(this.option.gradientColors[i].offset,this.option.gradientColors[i].color);ctx.fillStyle=gradient;ctx.fillRect(0,0,1,levels);this._gradientPixels=ctx.getImageData(0,0,1,levels).data}return this._gradientPixels}};return Heatmap});