define(["require","./number"],function(require){function smartLogSteps(opts){clearStaticVariables();custOpts=opts||{};reformSetting();makeTicksList();return[makeResult(),clearStaticVariables()][0]}function clearStaticVariables(){logPositive=custOpts=logMappingOffset=lnBase=absMin=absMax=splitNumber=tickList=logLabelBase=logLabelMode=null}function reformSetting(){logLabelBase=custOpts.logLabelBase;if(null==logLabelBase){logLabelMode="plain";logLabelBase=10;lnBase=LN10}else{logLabelBase=+logLabelBase;1>logLabelBase&&(logLabelBase=10);logLabelMode="exponent";lnBase=mathLog(logLabelBase)}splitNumber=custOpts.splitNumber;null==splitNumber&&(splitNumber=DEFAULT_SPLIT_NUMBER);var dataMin=parseFloat(custOpts.dataMin),dataMax=parseFloat(custOpts.dataMax);isFinite(dataMin)||isFinite(dataMax)?isFinite(dataMin)?isFinite(dataMax)?dataMin>dataMax&&(dataMax=[dataMin,dataMin=dataMax][0]):dataMax=dataMin:dataMin=dataMax:dataMin=dataMax=1;logPositive=custOpts.logPositive;null==logPositive&&(logPositive=dataMax>0||0===dataMin);absMin=logPositive?dataMin:-dataMax;absMax=logPositive?dataMax:-dataMin;EPSILON>absMin&&(absMin=EPSILON);EPSILON>absMax&&(absMax=EPSILON)}function makeTicksList(){function baseAnalysis(){splitNumber>spanExpon&&(splitNumber=spanExpon);var stepExpon=mathFloor(fixAccurate(spanExpon/splitNumber)),splitNumberAdjust=mathCeil(fixAccurate(spanExpon/stepExpon)),spanExponAdjust=stepExpon*splitNumberAdjust,halfDiff=(spanExponAdjust-spanDataLog)/2,minExponAdjust=mathFloor(fixAccurate(minDataLog-halfDiff));aroundZero(minExponAdjust-minDataLog)&&(minExponAdjust-=1);logMappingOffset=-minExponAdjust*lnBase;for(var n=minExponAdjust;maxDataLog>=n-stepExpon;n+=stepExpon)tickList.push(mathPow(logLabelBase,n))}function detailAnalysis(){for(var minDecimal=toDecimalFrom4Hex(minExpon,0),endDecimal=minDecimal+2;endDecimal>minDecimal&&toH(minDecimal+1)+toK(minDecimal+1)*LN2D10<minDataLog;)minDecimal++;for(var maxDecimal=toDecimalFrom4Hex(maxExpon,0),endDecimal=maxDecimal-2;maxDecimal>endDecimal&&toH(maxDecimal-1)+toK(maxDecimal-1)*LN2D10>maxDataLog;)maxDecimal--;logMappingOffset=-(toH(minDecimal)*LN10+toK(minDecimal)*LN2);for(var i=minDecimal;maxDecimal>=i;i++){var h=toH(i),k=toK(i);tickList.push(mathPow(10,h)*mathPow(2,k))}}function toDecimalFrom4Hex(h,k){return 3*h+k}function toK(decimal){return decimal-3*toH(decimal)}function toH(decimal){return mathFloor(fixAccurate(decimal/3))}tickList=[];var maxDataLog=fixAccurate(mathLog(absMax)/lnBase),minDataLog=fixAccurate(mathLog(absMin)/lnBase),maxExpon=mathCeil(maxDataLog),minExpon=mathFloor(minDataLog),spanExpon=maxExpon-minExpon,spanDataLog=maxDataLog-minDataLog;"exponent"===logLabelMode?baseAnalysis():MIN_BASE_10_SPLIT_NUMBER>=spanExpon&&splitNumber>MIN_BASE_10_SPLIT_NUMBER?detailAnalysis():baseAnalysis()}function makeResult(){for(var resultTickList=[],i=0,len=tickList.length;len>i;i++)resultTickList[i]=(logPositive?1:-1)*tickList[i];!logPositive&&resultTickList.reverse();var dataMappingMethods=makeDataMappingMethods(),value2Coord=dataMappingMethods.value2Coord,newDataMin=value2Coord(resultTickList[0]),newDataMax=value2Coord(resultTickList[resultTickList.length-1]);if(newDataMin===newDataMax){newDataMin-=1;newDataMax+=1}return{dataMin:newDataMin,dataMax:newDataMax,tickList:resultTickList,logPositive:logPositive,labelFormatter:makeLabelFormatter(),dataMappingMethods:dataMappingMethods}}function makeLabelFormatter(){if("exponent"===logLabelMode){var myLogLabelBase=logLabelBase,myLnBase=lnBase;return function(value){if(!isFinite(parseFloat(value)))return"";var sign="";if(0>value){value=-value;sign="-"}return sign+myLogLabelBase+makeSuperscriptExponent(mathLog(value)/myLnBase)}}return function(value){return isFinite(parseFloat(value))?number.addCommas(formatNumber(value)):""}}function makeDataMappingMethods(){var myLogPositive=logPositive,myLogMappingOffset=logMappingOffset;return{value2Coord:function(x){if(null==x||isNaN(x)||!isFinite(x))return x;x=parseFloat(x);isFinite(x)?myLogPositive&&EPSILON>x?x=EPSILON:!myLogPositive&&x>-EPSILON&&(x=-EPSILON):x=EPSILON;x=mathAbs(x);return(myLogPositive?1:-1)*(mathLog(x)+myLogMappingOffset)},coord2Value:function(x){if(null==x||isNaN(x)||!isFinite(x))return x;x=parseFloat(x);isFinite(x)||(x=EPSILON);return myLogPositive?mathPow(LOG_BASE,x-myLogMappingOffset):-mathPow(LOG_BASE,-x+myLogMappingOffset)}}}function fixAccurate(result){return+Number(+result).toFixed(14)}function formatNumber(num){return Number(num).toFixed(15).replace(/\.?0*$/,"")}function makeSuperscriptExponent(exponent){exponent=formatNumber(Math.round(exponent));for(var result=[],i=0,len=exponent.length;len>i;i++){var cha=exponent.charAt(i);result.push(SUPERSCRIPTS[cha]||"")}return result.join("")}function aroundZero(val){return val>-EPSILON&&EPSILON>val}var logPositive,logLabelBase,logLabelMode,lnBase,custOpts,splitNumber,logMappingOffset,absMin,absMax,tickList,number=require("./number"),Mt=Math,mathLog=Mt.log,mathPow=Mt.pow,mathAbs=Mt.abs,mathCeil=Mt.ceil,mathFloor=Mt.floor,LOG_BASE=Mt.E,LN10=Mt.LN10,LN2=Mt.LN2,LN2D10=LN2/LN10,EPSILON=1e-9,DEFAULT_SPLIT_NUMBER=5,MIN_BASE_10_SPLIT_NUMBER=2,SUPERSCRIPTS={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","-":"⁻"};return smartLogSteps});