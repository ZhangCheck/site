define(["require","./kwargs"],function(require){function guessDataType(arr){if("undefined"==typeof arr)return"number";switch(Object.prototype.toString.call(arr)){case"[object Int32Array]":return"int32";case"[object Int16Array]":return"int16";case"[object Int8Array]":return"int8";case"[object Uint32Array]":return"uint32";case"[object Uint16Array]":return"uint16";case"[object Uint8Array]":return"uint8";case"[object Uint8ClampedArray]":return"uint8c";case"[object Float32Array]":return"float32";case"[object Float64Array]":return"float64";default:return"number"}}function parseRange(index,dimSize){if(index.indexOf(":")>=0){var start,end,res=index.split(/\s*:\s*/),step=parseInt(res[2]||1,10);if(0===step)throw new Error("Slice step cannot be zero");if(step>0){start=parseInt(res[0]||0,10);end=parseInt(res[1]||dimSize,10)}else{start=parseInt(res[0]||dimSize-1,10);end=parseInt(res[1]||-1,10)}0>start&&(start=dimSize+start);0>end&&res[1]&&(end=dimSize+end);if(step>0){start=Math.max(Math.min(dimSize,start),0);end=Math.max(Math.min(dimSize,end),0)}else{start=Math.max(Math.min(dimSize-1,start),-1);end=Math.max(Math.min(dimSize-1,end),-1)}return[start,end,step]}var start=parseInt(index,10);0>start&&(start=dimSize+start);if(0>start||start>dimSize)throw new Error(indexOutofBoundsErrorMsg(index));start=Math.max(Math.min(dimSize-1,start),0);return[start,start+1,1]}function getSize(shape){for(var size=shape[0],i=1;i<shape.length;i++)size*=shape[i];return size}function getDimension(array){for(var dim=1,el=array[0];el instanceof Array;){el=el[0];dim++}return dim}function getShape(array){for(var shape=[array.length],el=array[0];el instanceof Array;){shape.push(el.length);el=el[0]}return shape}function calculateDimStride(shape,axis){if(axis==shape.length-1)return 1;for(var stride=shape[axis+1],i=axis+2;i<shape.length;i++)stride*=shape[i];return stride}function calculateDimStrides(shape){for(var strides=[],tmp=1,len=getSize(shape),i=0;i<shape.length;i++){tmp*=shape[i];strides.push(len/tmp)}return strides}function arrayEqual(arr1,arr2){if(arr1.length!==arr2.length)return!1;for(var i=0;i<arr1.length;i++)if(arr1[i]!==arr2[i])return!1;return!0}function broadcastErrorMsg(shape1,shape2){return"Shape ("+shape1.toString()+") ("+shape2.toString()+") could not be broadcast together"}function axisOutofBoundsErrorMsg(axis){return"Axis "+axis+" out of bounds"}function indexOutofBoundsErrorMsg(idx){return"Index "+idx+" out of bounds"}var kwargs=require("./kwargs"),ArraySlice=Array.prototype.slice;this.Int32Array=window.Int32Array||Array;this.Int16Array=window.Int16Array||Array;this.Int8Array=window.Int8Array||Array;this.Uint32Array=window.Uint32Array||Array;this.Uint16Array=window.Uint16Array||Array;this.Uint8Array=window.Uint8Array||Array;this.Float32Array=window.Float32Array||Array;this.Float64Array=window.Float64Array||Array;var ArrayConstructor={int32:this.Int32Array,int16:this.Int16Array,int8:this.Int8Array,uint32:this.Uint32Array,uint16:this.Uint16Array,uint8:this.Uint8Array,uint8c:this.Uint8ClampedArray,float32:this.Float32Array,float64:this.Float64Array,number:Array},dTypeStrideMap={int32:4,int16:2,int8:1,uint32:4,uint16:2,uint8:1,uint8c:1,float32:4,float64:8,number:1},E_ADD=0,E_SUB=1,E_MUL=2,E_DIV=3,E_MOD=4,E_AND=5,E_OR=6,E_XOR=7,E_EQL=8,NDArray=function(array){var dtype=arguments[arguments.length-1];"string"==typeof dtype?this._dtype=dtype:this._dtype=guessDataType(array);if(array&&"string"!=typeof array){if(array instanceof NDArray){array._dtype=this._dtype;return array}"undefined"!=typeof array.length?this.initFromArray(array):"number"==typeof array&&this.initFromShape.apply(this,arguments)}else{this._array=new ArrayConstructor[this._dtype];this._shape=[0];this._size=0}};NDArray.prototype={initFromArray:function(input){function flatten(axis,_out,_in){for(var len=_in.length,i=0;len>i;i++)dim-1>axis?flatten(axis+1,_out,_in[i]):_out[cursor++]=_in[i]}var dim=getDimension(input),cursor=0,shape=getShape(input),size=getSize(shape);this._array=new ArrayConstructor[this._dtype](size);flatten(0,this._array,input);this._shape=shape;this._size=size;return this},initFromShape:function(shape){"number"==typeof shape&&(shape=Array.prototype.slice.call(arguments));if(shape){var size=getSize(shape);if("number"===this._dtype){this._array=[];for(var data=this._array,i=0;size>i;i++)data[i]=0}else this._array=new ArrayConstructor[this._dtype](size)}this._shape=shape;this._size=getSize(shape);return this},fill:function(value){for(var data=this._array,i=0;i<data.length;i++)data[i]=value;return this},shape:function(){return this._shape.slice()},size:function(){return this._size},dtype:function(){return this._dtype},dimension:function(){return this._shape.length},strides:function(){for(var strides=calculateDimStrides(this._shape),dTypeStride=dTypeStrideMap[this._dtype],i=0;i<strides.length;i++)strides[i]*=dTypeStride;return strides},reshape:function(shape){"number"==typeof shape&&(shape=Array.prototype.slice.call(arguments));if(!this._isShapeValid(shape))throw new Error("Total size of new array must be unchanged");this._shape=shape;return this},_isShapeValid:function(shape){return getSize(shape)===this._size},resize:function(shape){"number"==typeof shape&&(shape=Array.prototype.slice.call(arguments));var len=getSize(shape);if(len<this._size)"number"===this._dtype&&(this._array.length=len);else if("number"===this._dtype)for(var i=this._array.length;len>i;i++)this._array[i]=0;else{for(var newArr=new ArrayConstructor[this._dtype](len),originArr=this._array,i=0;i<originArr.length;i++)newArr[i]=originArr[i];this._array=newArr}this._shape=shape;this._size=len;return this},transpose:kwargs(function(axes,out){for(var originAxes=[],i=0;i<this._shape.length;i++)originAxes.push(i);"undefined"==typeof axes&&(axes=originAxes.slice());for(var i=0;i<axes.length;i++)if(axes[i]>=this._shape.length)throw new Error(axisOutofBoundsErrorMsg(axes[i]));if(axes.length<=1)return this;for(var targetAxes=originAxes.slice(),i=0;i<Math.floor(axes.length/2);i++)for(var j=axes.length-1;j>=Math.ceil(axes.length/2);j--){targetAxes[axes[i]]=axes[j];targetAxes[axes[j]]=axes[i]}return this._transposelike(targetAxes,out)}),swapaxes:kwargs(function(axis1,axis2,out){return this.transpose([axis1,axis2],out)}),rollaxis:kwargs(function(axis,start,out){if(axis>=this._shape.length)throw new Error(axisOutofBoundsErrorMsg(axis));for(var axes=[],i=0;i<this._shape.length;i++)axes.push(i);axes.splice(axis,1);axes.splice(start,0,axis);return this._transposelike(axes,out)},{start:0}),_transposelike:function(axes,out){function transpose(axis,offset,transposedOffset){var size=shape[axis],stride=strides[axis],transposedStride=transposedStrides[axis];if(dim-1>axis)for(var i=0;size>i;i++)transpose(axis+1,offset+stride*i,transposedOffset+transposedStride*i);else for(var i=0;size>i;i++)transposedData[transposedOffset+i]=source[offset+stride*i]}for(var source=this._array,shape=this._shape.slice(),strides=calculateDimStrides(this._shape),dim=shape.length,tmpStrides=[],tmpShape=[],i=0;i<axes.length;i++){var axis=axes[i];tmpShape[i]=shape[axis];tmpStrides[i]=strides[axis]}strides=tmpStrides;shape=tmpShape;this._shape=shape;var transposedStrides=calculateDimStrides(this._shape);if(!out){out=new NDArray;out._shape=this._shape.slice();out._dtype=this._dtype;out._size=this._size}var transposedData=new ArrayConstructor[this._dtype](this._size);out._array=transposedData;transpose(0,0,0);return out},repeat:kwargs(function(repeats,axis,out){var shape;if("undefined"==typeof axis){shape=[this._size];axis=0}else shape=this._shape.slice();var originShape=shape.slice();shape[axis]*=repeats;if(out){if(!arrayEqual(shape,out._shape))throw new Error(broadcastErrorMsg(shape,out._shape))}else{out=new NDArray(this._dtype);out.initFromShape(shape)}for(var data=out._array,stride=calculateDimStride(originShape,axis),axisSize=originShape[axis],source=this._array,offsetStride=stride*axisSize,offset=0;offset<this._size;offset+=offsetStride)for(var k=0;stride>k;k++)for(var idx=offset+k,idxRepeated=offset*repeats+k,i=0;axisSize>i;i++){for(var j=0;repeats>j;j++){data[idxRepeated]=source[idx];idxRepeated+=stride}idx+=stride}return out}),choose:function(){console.warn("TODO")},take:function(){console.warn("TODO")},tile:function(){console.warn("TODO")},_withPreprocess1:function(axis,out,funcWithAxis,funcFlatten){var source=this._array;if(this._size){if("undefined"!=typeof axis){0>axis&&(axis=this._shape.length+axis);if(axis>=this._shape.length||0>axis)throw new Error(axisOutofBoundsErrorMsg(axis));var shape=this._shape.slice();shape.splice(axis,1);if(out&&!arrayEqual(shape,out._shape))throw new Error(broadcastErrorMsg(shape,out._shape));if(!out){out=new NDArray(this._dtype);out.initFromShape(shape)}var data=out._array,stride=calculateDimStride(this._shape,axis),axisSize=this._shape[axis],offsetStride=stride*axisSize;funcWithAxis.call(this,data,source,offsetStride,axisSize,stride);return out}return funcFlatten.call(this,source)}},_withPreprocess2:function(axis,out,funcWithAxis,funcFlatten){var source=this._array;if(this._size){if(out&&!arrayEqual(this._shape,out._shape))throw new Error(broadcastErrorMsg(this._shape,out._shape));if(!out){out=new NDArray(this._dtype);out.initFromShape(this._shape)}var data=out._array;if("undefined"!=typeof axis){0>axis&&(axis=this._shape.length+axis);if(axis>=this._shape.length||0>axis)throw new Error(axisOutofBoundsErrorMsg(axis));if(axis>=this._shape.length)throw new Error(axisOutofBoundsErrorMsg(axis));var stride=calculateDimStride(this._shape,axis),axisSize=this._shape[axis],offsetStride=stride*axisSize;funcWithAxis.call(this,data,source,offsetStride,axisSize,stride)}else{out.reshape([this._size]);funcFlatten.call(this,data,source)}return out}},max:kwargs(function(){function withAxis(data,source,offsetStride,axisSize,stride){for(var cursor=0,offset=0;offset<this._size;offset+=offsetStride)for(var i=0;stride>i;i++){for(var idx=i+offset,max=source[idx],j=0;axisSize>j;j++){var d=source[idx];d>max&&(max=d);idx+=stride}data[cursor++]=max}}function withFlatten(source){for(var max=source[0],i=1;i<this._size;i++)source[i]>max&&(max=source[i]);return max}return function(axis,out){return this._withPreprocess1(axis,out,withAxis,withFlatten)}}()),min:kwargs(function(){function withAxis(data,source,offsetStride,axisSize,stride){for(var cursor=0,offset=0;offset<this._size;offset+=offsetStride)for(var i=0;stride>i;i++){for(var idx=i+offset,min=source[idx],j=0;axisSize>j;j++){var d=source[idx];min>d&&(min=d);idx+=stride}data[cursor++]=min}}function withFlatten(source){for(var min=source[0],i=1;i<this._size;i++)source[i]<min&&(min=source[i]);return min}return function(axis,out){return this._withPreprocess1(axis,out,withAxis,withFlatten)}}()),argmax:kwargs(function(){function withAxis(data,source,offsetStride,axisSize,stride){for(var cursor=0,offset=0;offset<this._size;offset+=offsetStride)for(var i=0;stride>i;i++){for(var dataIdx=0,idx=i+offset,max=source[idx],j=0;axisSize>j;j++){var d=source[idx];if(d>max){max=d;dataIdx=j}idx+=stride}data[cursor++]=dataIdx}}function withFlatten(source){for(var max=source[0],idx=0,i=1;i<this._size;i++)if(source[i]>max){idx=i;max=source[i]}return idx}return function(axis,out){return this._withPreprocess1(axis,out,withAxis,withFlatten)}}()),argmin:kwargs(function(){function withAxis(data,source,offsetStride,axisSize,stride){for(var cursor=0,offset=0;offset<this._size;offset+=offsetStride)for(var i=0;stride>i;i++){for(var dataIdx=0,idx=i+offset,min=source[idx],j=0;axisSize>j;j++){var d=source[idx];if(min>d){min=d;dataIdx=j}idx+=stride}data[cursor++]=dataIdx}}function withFlatten(source){for(var min=source[0],idx=0,i=1;i<this._size;i++)if(source[i]<min){idx=i;min=source[i]}return idx}return function(axis,out){return this._withPreprocess1(axis,out,withAxis,withFlatten)}}()),sum:kwargs(function(){function withAxis(data,source,offsetStride,axisSize,stride){for(var cursor=0,offset=0;offset<this._size;offset+=offsetStride)for(var i=0;stride>i;i++){for(var sum=0,idx=i+offset,j=0;axisSize>j;j++){sum+=source[idx];idx+=stride}data[cursor++]=sum}}function withFlatten(source){for(var sum=0,i=0;i<this._size;i++)sum+=source[i];return sum}return function(axis,out){return this._withPreprocess1(axis,out,withAxis,withFlatten)}}()),prod:kwargs(function(){function withAxis(data,source,offsetStride,axisSize,stride){for(var cursor=0,offset=0;offset<this._size;offset+=offsetStride)for(var i=0;stride>i;i++){for(var prod=1,idx=i+offset,j=0;axisSize>j;j++){prod*=source[idx];idx+=stride}data[cursor++]=prod}}function withFlatten(source){for(var prod=1,i=0;i<this._size;i++)prod*=source[i];return prod}return function(axis,out){return this._withPreprocess1(axis,out,withAxis,withFlatten)}}()),mean:kwargs(function(){function withAxis(data,source,offsetStride,axisSize,stride){for(var cursor=0,offset=0;offset<this._size;offset+=offsetStride)for(var i=0;stride>i;i++){for(var sum=0,idx=i+offset,j=0;axisSize>j;j++){sum+=source[idx];idx+=stride}var mean=sum/axisSize;data[cursor++]=mean}}function withFlatten(source){for(var sum=0,len=source.length,i=0;len>i;i++)sum+=source[i];var mean=sum/len;return mean}return function(axis,out){return this._withPreprocess1(axis,out,withAxis,withFlatten)}}()),"var":kwargs(function(){function withAxis(data,source,offsetStride,axisSize,stride){for(var cursor=0,offset=0;offset<this._size;offset+=offsetStride)for(var i=0;stride>i;i++){for(var sum=0,idx=i+offset,j=0;axisSize>j;j++){sum+=source[idx];idx+=stride}var mean=sum/axisSize,moments=0;idx=i+offset;for(var j=0;axisSize>j;j++){var diff=source[idx]-mean;moments+=diff*diff;idx+=stride}data[cursor++]=moments/axisSize}}function withFlatten(source){for(var sum=0,len=source.length,i=0;len>i;i++)sum+=source[i];for(var mean=sum/len,moments=0,i=0;len>i;i++){var diff=source[i]-mean;moments+=diff*diff}return moments/len}return function(axis,out){return this._withPreprocess1(axis,out,withAxis,withFlatten)}}()),std:kwargs(function(){function withAxis(data,source,offsetStride,axisSize,stride){for(var cursor=0,offset=0;offset<this._size;offset+=offsetStride)for(var i=0;stride>i;i++){for(var sum=0,idx=i+offset,j=0;axisSize>j;j++){sum+=source[idx];idx+=stride}var mean=sum/axisSize,moments=0;idx=i+offset;for(var j=0;axisSize>j;j++){var diff=source[idx]-mean;moments+=diff*diff;idx+=stride}data[cursor++]=Math.sqrt(moments/axisSize)}}function withFlatten(source){for(var sum=0,len=source.length,i=0;len>i;i++)sum+=source[i];for(var mean=sum/len,moments=0,i=0;len>i;i++){var diff=source[i]-mean;moments+=diff*diff}return Math.sqrt(moments/len)}return function(axis,out){return this._withPreprocess1(axis,out,withAxis,withFlatten)}}()),ptp:kwargs(function(){function withAxis(data,source,offsetStride,axisSize,stride){for(var cursor=0,offset=0;offset<this._size;offset+=offsetStride)for(var i=0;stride>i;i++){for(var idx=offset+i,min=source[idx],max=source[idx],j=0;axisSize>j;j++){var d=source[idx];min>d&&(min=d);d>max&&(max=d);idx+=stride}data[cursor++]=max-min}}function withFlatten(source){for(var min=source[0],max=source[0],i=1;i<this._size;i++){source[i]<min&&(min=source[i]);source[i]>max&&(max=source[i])}return max-min}return function(axis,out){return this._withPreprocess1(axis,out,withAxis,withFlatten)}}()),sort:kwargs(function(axis,order){0>axis&&(axis=this._shape.length+axis);var compareFunc;"ascending"===order?compareFunc=function(a,b){return a-b}:"descending"===order&&(compareFunc=function(a,b){return b-a});for(var source=this._array,stride=calculateDimStride(this._shape,axis),axisSize=this._shape[axis],offsetStride=stride*axisSize,tmp=new Array(axisSize),offset=0;offset<this._size;offset+=offsetStride)for(var i=0;stride>i;i++){for(var idx=offset+i,j=0;axisSize>j;j++){tmp[j]=source[idx];idx+=stride}tmp.sort(compareFunc);for(var idx=offset+i,j=0;axisSize>j;j++){source[idx]=tmp[j];idx+=stride}}return this},{axis:-1,order:"ascending"}),argsort:kwargs(function(axis,order,out){0>axis&&(axis=this._shape.length+axis);if(this._size){if(out&&!arrayEqual(this._shape,out._shape))throw new Error(broadcastErrorMsg(this._shape,out._shape));if(!out){out=new NDArray(this._dtype);out.initFromShape(this._shape)}var compareFunc,data=out._array;"ascending"===order?compareFunc=function(a,b){return tmp[a]-tmp[b]}:"descending"===order&&(compareFunc=function(a,b){return tmp[b]-tmp[a]});for(var source=this._array,stride=calculateDimStride(this._shape,axis),axisSize=this._shape[axis],offsetStride=stride*axisSize,tmp=new Array(axisSize),indexList=new Array(axisSize),offset=0;offset<this._size;offset+=offsetStride)for(var i=0;stride>i;i++){for(var idx=offset+i,j=0;axisSize>j;j++){tmp[j]=source[idx];indexList[j]=j;idx+=stride}indexList.sort(compareFunc);for(var idx=offset+i,j=0;axisSize>j;j++){data[idx]=indexList[j];idx+=stride}}return out}},{axis:-1,order:"ascending"}),cumsum:kwargs(function(){function withAxis(data,source,offsetStride,axisSize,stride){for(var offset=0;offset<this._size;offset+=offsetStride)for(var i=0;stride>i;i++){var idx=offset+i,prevIdx=idx;data[idx]=source[idx];for(var j=1;axisSize>j;j++){prevIdx=idx;idx+=stride;data[idx]=data[prevIdx]+source[idx]}}}function withFlatten(data,source){data[0]=source[0];for(var i=1;i<data.length;i++)data[i]=data[i-1]+source[i]}return function(axis,out){return this._withPreprocess2(axis,out,withAxis,withFlatten)}}()),cumprod:kwargs(function(){function withAxis(data,source,offsetStride,axisSize,stride){for(var offset=0;offset<this._size;offset+=offsetStride)for(var i=0;stride>i;i++){var idx=offset+i,prevIdx=idx;data[idx]=source[idx];for(var j=1;axisSize>j;j++){prevIdx=idx;idx+=stride;data[idx]=data[prevIdx]*source[idx]}}}function withFlatten(data,source){data[0]=source[0];for(var i=1;i<data.length;i++)data[i]=data[i-1]*source[i]}return function(axis,out){return this._withPreprocess2(axis,out,withAxis,withFlatten)}}()),dot:function(){console.warn("TODO")},map:function(mappedMin,mappedMax){for(var input=this._array,output=this._array,min=input[0],max=input[0],l=this._size,i=1;l>i;i++){var val=input[i];min>val&&(min=val);val>max&&(max=val)}for(var range=max-min,mappedRange=mappedMax-mappedMin,i=0;l>i;i++)if(0===range)output[i]=mappedMin;else{var val=input[i],percent=(val-min)/range;output[i]=mappedRange*percent+mappedMin}return this},add:function(rightOperand,out){return this.binaryOperation(this,rightOperand,E_ADD,out)},sub:function(rightOperand,out){return this.binaryOperation(this,rightOperand,E_SUB,out)},mul:function(rightOperand,out){return this.binaryOperation(this,rightOperand,E_MUL,out)},div:function(rightOperand,out){return this.binaryOperation(this,rightOperand,E_DIV,out)},mod:function(rightOperand,out){return this.binaryOperation(this,rightOperand,E_MOD,out)},and:function(rightOperand,out){return this.binaryOperation(this,rightOperand,E_AND,out)},or:function(rightOperand,out){return this.binaryOperation(this,rightOperand,E_OR,out)},xor:function(rightOperand,out){return this.binaryOperation(this,rightOperand,E_XOR,out)},equal:function(rightOperand,out){return this.binaryOperation(this,rightOperand,E_EQL,out)},binaryOperation:function(lo,ro,op,out){var shape=[],isLoScalar="number"==typeof lo,isRoScalar="number"==typeof ro;if(isLoScalar)shape=ro._shape.slice();else if(isRoScalar)shape=lo._shape.slice();else{for(var cl=lo._shape.length-1,cr=ro._shape.length-1,loBroadCasted=lo,roBroadCasted=ro;cl>=0&&cr>=0;){if(1==lo._shape[cl]){shape.unshift(ro._shape[cr]);loBroadCasted=lo.repeat(ro._shape[cr],cl)}else if(1==ro._shape[cr]){shape.unshift(lo._shape[cl]);roBroadCasted=ro.repeat(lo._shape[cl],cr)}else{if(ro._shape[cr]!=lo._shape[cl])throw new Error(broadcastErrorMsg(lo._shape,ro._shape));shape.unshift(lo._shape[cl])}cl--;cr--}for(var i=cl;i>=0;i--)shape.unshift(lo._shape[i]);for(var i=cr;i>=0;i--)shape.unshift(ro._shape[i]);lo=loBroadCasted;ro=roBroadCasted}if(out){if(!arrayEqual(shape,out._shape))throw new Error(broadcastErrorMsg(shape,out._shape))}else{out=new NDArray(this._dtype);out.initFromShape(shape)}var diffAxis,isLoLarger,loData,roData,outData=out._array;if(isLoScalar){diffAxis=ro._shape.length-1;isLoLarger=!1;loData=lo;roData=ro._array}else if(isRoScalar){diffAxis=lo._shape.length-1;isLoLarger=!0;roData=ro;loData=lo._array}else{diffAxis=Math.abs(lo._shape.length-ro._shape.length);isLoLarger=lo._shape.length>=ro._shape.length;loData=lo._array;roData=ro._array}var _a,_b,res,stride=calculateDimStride(shape,diffAxis),axisSize=shape[diffAxis],offsetStride=stride*axisSize,offsetRepeats=out._size/offsetStride,idx=0;if(isLoLarger)if(isRoScalar)for(var c=0;offsetRepeats>c;c++)for(var i=0;offsetStride>i;i++){_a=loData[idx];_b=roData;switch(op){case E_ADD:res=_a+_b;break;case E_SUB:res=_a-_b;break;case E_MUL:res=_a*_b;break;case E_DIV:res=_a/_b;break;case E_MOD:res=_a%_b;break;case E_AND:res=_a&_b;break;case E_OR:res=_a|_b;break;case E_XOR:res=_a^_b;break;case E_EQL:res=_a==_b;break;default:throw new Error("Unkown operation "+op)}outData[idx]=res;idx++}else for(var c=0;offsetRepeats>c;c++)for(var i=0;offsetStride>i;i++){_a=loData[idx];_b=roData[i];switch(op){case E_ADD:res=_a+_b;break;case E_SUB:res=_a-_b;break;case E_MUL:res=_a*_b;break;case E_DIV:res=_a/_b;break;case E_MOD:res=_a%_b;break;case E_AND:res=_a&_b;break;case E_OR:res=_a|_b;break;case E_XOR:res=_a^_b;break;case E_EQL:res=_a==_b;break;default:throw new Error("Unkown operation "+op)}outData[idx]=res;idx++}else if(isLoScalar)for(var c=0;offsetRepeats>c;c++)for(var i=0;offsetStride>i;i++){_a=loData;_b=roData[idx];switch(op){case E_ADD:res=_a+_b;break;case E_SUB:res=_a-_b;break;case E_MUL:res=_a*_b;break;case E_DIV:res=_a/_b;break;case E_MOD:res=_a%_b;break;case E_AND:res=_a&_b;break;case E_OR:res=_a|_b;break;case E_XOR:res=_a^_b;break;case E_EQL:res=_a==_b;break;default:throw new Error("Unkown operation "+op)}outData[idx]=res;idx++}else for(var c=0;offsetRepeats>c;c++)for(var i=0;offsetStride>i;i++){_a=loData[idx];_b=roData[i];switch(op){case E_ADD:res=_a+_b;break;case E_SUB:res=_a-_b;break;case E_MUL:res=_a*_b;break;case E_DIV:res=_a/_b;break;case E_MOD:res=_a%_b;break;case E_AND:res=_a&_b;break;case E_OR:res=_a|_b;break;case E_XOR:res=_a^_b;break;case E_EQL:res=_a==_b;break;default:throw new Error("Unkown operation "+op)}outData[idx]=res;idx++}return out},neg:function(){for(var data=this._array,i=0;i<this._size;i++)data[i]=-data[i];return this},sin:function(){return this._mathAdapter(Math.sin)},cos:function(){return this._mathAdapter(Math.cos)},tan:function(){return this._mathAdapter(Math.tan)},abs:function(){return this._mathAdapter(Math.abs)},log:function(){return this._mathAdapter(Math.log)},sqrt:function(){return this._mathAdapter(Math.sqrt)},ceil:function(){return this._mathAdapter(Math.ceil)},floor:function(){return this._mathAdapter(Math.floor)},pow:function(exp){for(var data=this._array,i=0;i<this._size;i++)data[i]=Math.pow(data[i],exp);return this},_mathAdapter:function(mathFunc){for(var data=this._array,i=0;i<this._size;i++)data[i]=mathFunc(data[i]);return this},round:function(decimals){decimals=Math.floor(decimals||0);var offset=Math.pow(10,decimals),data=this._array;if(0===decimals)for(var i=0;i<this._size;i++)data[i]=Math.round(data[i]);else for(var i=0;i<this._size;i++)data[i]=Math.round(data[i]*offset)/offset;return this},clip:function(min,max){for(var data=this._array,i=0;i<this._size;i++)data[i]=Math.max(Math.min(data[i],max),min);return this},get:function(index,out){function getPiece(axis,offset){var range=ranges[axis],stride=strides[axis];if(len-1>axis)if(range[2]>0)for(var i=range[0];i<range[1];i+=range[2])getPiece(axis+1,offset+stride*i);else for(var i=range[0];i>range[1];i+=range[2])getPiece(axis+1,offset+stride*i);else if(range[2]>0)for(var i=range[0];i<range[1];i+=range[2])for(var j=0;stride>j;j++)data[cursor++]=source[i*stride+j+offset];else for(var i=range[0];i>range[1];i+=range[2])for(var j=0;stride>j;j++)data[cursor++]=source[i*stride+j+offset]}"number"==typeof index&&(index=index.toString());var strides=calculateDimStrides(this._shape),res=this._parseRanges(index),ranges=res[0],shape=res[1];if(ranges.length>this._shape.length)throw new Error("Too many indices");var data,len=ranges.length;if(shape.length){out=new NDArray(this._dtype);out.initFromShape(shape);data=out._array}else data=[];var source=this._array,cursor=0;getPiece(0,0);return shape.length?out:data[0]},set:function(index,narray){"number"==typeof index&&(index=index.toString());var strides=calculateDimStrides(this._shape),res=this._parseRanges(index),ranges=res[0],shape=res[1];if(ranges.length>this._shape.length)throw new Error("Too many indices");var isScalar="number"==typeof narray,len=ranges.length,data=this._array;if(isScalar)var source=narray;else{if(!arrayEqual(shape,narray.shape()))throw new Error(broadcastErrorMsg(shape,narray.shape()));var source=narray._array}var cursor=0,setPiece=function(axis,offset){var range=ranges[axis],stride=strides[axis];if(len-1>axis)if(range[2]>0)for(var i=range[0];i<range[1];i+=range[2])setPiece(axis+1,offset+stride*i);else for(var i=range[0];i>range[1];i+=range[2])setPiece(axis+1,offset+stride*i);else if(range[2]>0)for(var i=range[0];i<range[1];i+=range[2])for(var j=0;stride>j;j++)isScalar?data[i*stride+j+offset]=source:data[i*stride+j+offset]=source[cursor++];else for(var i=range[0];i>range[1];i+=range[2])for(var j=0;stride>j;j++)isScalar?data[i*stride+j+offset]=source:data[i*stride+j+offset]=source[cursor++]};setPiece(0,0);return this},insert:kwargs(function(obj,values,axis){var data=this._array,isObjScalar=!1;if("number"==typeof obj){obj=[obj];isObjScalar=!0}"number"==typeof values?values=new NDArray([values]):values instanceof Array&&(values=new NDArray(values));if("undefined"==typeof axis){this._shape=[this._size];axis=0}for(var prev=obj[0],axisSize=this._shape[axis],i=0;i<obj.length;i++){obj[i]<0&&(obj[i]=axisSize+obj[i]);if(obj[i]>axisSize)throw new Error(indexOutofBoundsErrorMsg(obj[i]));if(obj[i]<prev)throw new Error("Index must be in ascending order");prev=obj[i]}var targetShape=this._shape.slice();isObjScalar?targetShape.splice(axis,1):targetShape[axis]=obj.length;for(var sourceShape=values._shape,cs=sourceShape.length-1,ct=targetShape.length-1,valueBroadcasted=values;cs>=0&&ct>=0;){if(1===sourceShape[cs])valueBroadcasted=values.repeat(targetShape[ct],cs);else if(sourceShape[cs]!==targetShape[ct])throw new Error(broadcastErrorMsg(sourceShape,targetShape));cs--;ct--}values=valueBroadcasted;for(var stride=calculateDimStride(this._shape,axis),axisSize=this._shape[axis],offsetStride=axisSize*stride,offsetRepeats=this._size/offsetStride,objLen=obj.length,indices=new Uint32Array(offsetRepeats*objLen),cursor=0,offset=0;offset<this._size;offset+=offsetStride)for(var i=0;objLen>i;i++){var objIdx=obj[i];indices[cursor++]=offset+objIdx*stride}var resShape=this._shape.slice();resShape[axis]+=obj.length;var resSize=getSize(resShape);if(this._array.length<resSize)var data=new ArrayConstructor[this._dtype](resSize);else var data=this._array;for(var source=this._array,valuesArr=values._array,idxCursor=indices.length-1,end=this._size,start=indices[idxCursor],dataCursor=resSize-1,valueCursor=values._size-1;idxCursor>=0;){for(var i=end-1;i>=start;i--)data[dataCursor--]=source[i];end=start;start=indices[--idxCursor];for(var i=0;stride>i;i++){0>valueCursor&&(valueCursor=values._size-1);data[dataCursor--]=valuesArr[valueCursor--]}}for(var i=end-1;i>=0;i--)data[dataCursor--]=source[i];this._array=data;this._shape=resShape;this._size=resSize;return this}),append:function(){console.warn("TODO")},"delete":kwargs(function(obj,axis){var data=this._array;"number"==typeof obj&&(obj=[obj]);var size=this._size;if("undefined"==typeof axis){this._shape=[size];axis=0}for(var stride=calculateDimStride(this._shape,axis),axisSize=this._shape[axis],offsetStride=stride*axisSize,cursor=0,offset=0;size>offset;offset+=offsetStride){for(var start=0,end=obj[0],objCursor=0;objCursor<obj.length;){0>end&&(end+=axisSize);if(end>axisSize)throw new Error(indexOutofBoundsErrorMsg(end));if(start>end)throw new Error("Index must be in ascending order");for(var i=start;end>i;i++)for(var j=0;stride>j;j++)data[cursor++]=data[i*stride+j+offset];start=end+1;end=obj[++objCursor]}for(var i=start;axisSize>i;i++)for(var j=0;stride>j;j++)data[cursor++]=data[i*stride+j+offset]}this._shape[axis]-=obj.length;this._size=getSize(this._shape);return this}),_parseRanges:function(index){for(var rangesStr=index.split(/\s*,\s*/),ranges=[],shape=[],j=0,i=0;i<rangesStr.length;i++)if("..."===rangesStr[i])for(var end=this._shape.length-(rangesStr.length-i);end>=j;){ranges.push([0,this._shape[j],1]);shape.push(this._shape[j]);j++}else{var range=parseRange(rangesStr[i],this._shape[j]);ranges.push(range);if(rangesStr[i].indexOf(":")>=0){var size=Math.floor((range[1]-range[0])/range[2]);size=0>size?0:size;shape.push(size)}j++}for(;j<this._shape.length;j++)shape.push(this._shape[j]);return[ranges,shape]},toArray:function(){function create(axis,out){for(var len=shape[axis],i=0;len>i;i++)dim-1>axis?create(axis+1,out[i]=[]):out[i]=data[cursor++]}var data=this._array,cursor=0,shape=this._shape,dim=shape.length,output=[];create(0,output);return output},copy:function(){var numArr=new NDArray;numArr._array=ArraySlice.call(this._array);numArr._shape=this._shape.slice();numArr._dtype=this._dtype;numArr._size=this._size;return numArr},constructor:NDArray};NDArray.range=kwargs(function(min,max,step,dtype){var args=ArraySlice.call(arguments),lastArg=args[args.length-1];if("string"==typeof lastArg){var dtype=lastArg;args.pop()}if(1===args.length){max=args[0];step=1;min=0}else 2==args.length&&(step=1);dtype=dtype||"number";for(var array=new ArrayConstructor[dtype](Math.ceil((max-min)/step)),cursor=0,i=min;max>i;i+=step)array[cursor++]=i;var ndarray=new NDArray;ndarray._array=array;ndarray._shape=[array.length];ndarray._dtype=dtype;ndarray._size=array.length;return ndarray});NDArray.zeros=kwargs(function(shape,dtype){var ret=new NDArray(dtype);ret.initFromShape(shape);return ret});return NDArray});