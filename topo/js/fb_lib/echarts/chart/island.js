define(["require","./base","zrender/shape/Circle","../config","../util/ecData","zrender/tool/util","zrender/tool/event","zrender/tool/color","../util/accMath","../chart"],function(require){function Island(ecTheme,messageCenter,zr,option,myChart){ChartBase.call(this,ecTheme,messageCenter,zr,option,myChart);this._nameConnector;this._valueConnector;this._zrHeight=this.zr.getHeight();this._zrWidth=this.zr.getWidth();var self=this;self.shapeHandler.onmousewheel=function(param){var shape=param.target,event=param.event,delta=zrEvent.getDelta(event);delta=delta>0?-1:1;shape.style.r-=delta;shape.style.r=shape.style.r<5?5:shape.style.r;var value=ecData.get(shape,"value"),dvalue=value*self.option.island.calculateStep;value=dvalue>1?Math.round(value-dvalue*delta):+(value-dvalue*delta).toFixed(2);var name=ecData.get(shape,"name");shape.style.text=name+":"+value;ecData.set(shape,"value",value);ecData.set(shape,"name",name);self.zr.modShape(shape.id);self.zr.refreshNextFrame();zrEvent.stop(event)}}var ChartBase=require("./base"),CircleShape=require("zrender/shape/Circle"),ecConfig=require("../config");ecConfig.island={zlevel:0,z:5,r:15,calculateStep:.1};var ecData=require("../util/ecData"),zrUtil=require("zrender/tool/util"),zrEvent=require("zrender/tool/event");Island.prototype={type:ecConfig.CHART_TYPE_ISLAND,_combine:function(tarShape,srcShape){var zrColor=require("zrender/tool/color"),accMath=require("../util/accMath"),value=accMath.accAdd(ecData.get(tarShape,"value"),ecData.get(srcShape,"value")),name=ecData.get(tarShape,"name")+this._nameConnector+ecData.get(srcShape,"name");tarShape.style.text=name+this._valueConnector+value;ecData.set(tarShape,"value",value);ecData.set(tarShape,"name",name);tarShape.style.r=this.option.island.r;tarShape.style.color=zrColor.mix(tarShape.style.color,srcShape.style.color)},refresh:function(newOption){if(newOption){newOption.island=this.reformOption(newOption.island);this.option=newOption;this._nameConnector=this.option.nameConnector;this._valueConnector=this.option.valueConnector}},getOption:function(){return this.option},resize:function(){var newWidth=this.zr.getWidth(),newHieght=this.zr.getHeight(),xScale=newWidth/(this._zrWidth||newWidth),yScale=newHieght/(this._zrHeight||newHieght);if(1!==xScale||1!==yScale){this._zrWidth=newWidth;this._zrHeight=newHieght;for(var i=0,l=this.shapeList.length;l>i;i++)this.zr.modShape(this.shapeList[i].id,{style:{x:Math.round(this.shapeList[i].style.x*xScale),y:Math.round(this.shapeList[i].style.y*yScale)}})}},add:function(shape){var name=ecData.get(shape,"name"),value=ecData.get(shape,"value"),seriesName=null!=ecData.get(shape,"series")?ecData.get(shape,"series").name:"",font=this.getFont(this.option.island.textStyle),islandOption=this.option.island,islandShape={zlevel:islandOption.zlevel,z:islandOption.z,style:{x:shape.style.x,y:shape.style.y,r:this.option.island.r,color:shape.style.color||shape.style.strokeColor,text:name+this._valueConnector+value,textFont:font},draggable:!0,hoverable:!0,onmousewheel:this.shapeHandler.onmousewheel,_type:"island"};"#fff"===islandShape.style.color&&(islandShape.style.color=shape.style.strokeColor);this.setCalculable(islandShape);islandShape.dragEnableTime=0;ecData.pack(islandShape,{name:seriesName},-1,value,-1,name);islandShape=new CircleShape(islandShape);this.shapeList.push(islandShape);this.zr.addShape(islandShape)},del:function(shape){this.zr.delShape(shape.id);for(var newShapeList=[],i=0,l=this.shapeList.length;l>i;i++)this.shapeList[i].id!=shape.id&&newShapeList.push(this.shapeList[i]);this.shapeList=newShapeList},ondrop:function(param,status){if(this.isDrop&&param.target){var target=param.target,dragged=param.dragged;this._combine(target,dragged);this.zr.modShape(target.id);status.dragIn=!0;this.isDrop=!1}},ondragend:function(param,status){var target=param.target;if(this.isDragend){if(status.dragIn){this.del(target);status.needRefresh=!0}}else if(!status.dragIn){target.style.x=zrEvent.getX(param.event);target.style.y=zrEvent.getY(param.event);this.add(target);status.needRefresh=!0}this.isDragend=!1}};zrUtil.inherits(Island,ChartBase);require("../chart").define("island",Island);return Island});