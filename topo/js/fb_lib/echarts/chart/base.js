define(["require","zrender/shape/Image","../util/shape/Icon","../util/shape/MarkLine","../util/shape/Symbol","zrender/shape/Polyline","zrender/shape/ShapeBundle","../config","../util/ecData","../util/ecAnimation","../util/ecEffect","../util/accMath","../component/base","../layout/EdgeBundling","zrender/tool/util","zrender/tool/area"],function(require){function isCoordAvailable(coord){return null!=coord.x&&null!=coord.y}function Base(ecTheme,messageCenter,zr,option,myChart){ComponentBase.call(this,ecTheme,messageCenter,zr,option,myChart);var self=this;this.selectedMap={};this.lastShapeList=[];this.shapeHandler={onclick:function(){self.isClick=!0},ondragover:function(param){var calculableShape=param.target;calculableShape.highlightStyle=calculableShape.highlightStyle||{};var highlightStyle=calculableShape.highlightStyle,brushType=highlightStyle.brushTyep,strokeColor=highlightStyle.strokeColor,lineWidth=highlightStyle.lineWidth;highlightStyle.brushType="stroke";highlightStyle.strokeColor=self.ecTheme.calculableColor||ecConfig.calculableColor;highlightStyle.lineWidth="icon"===calculableShape.type?30:10;self.zr.addHoverShape(calculableShape);setTimeout(function(){if(highlightStyle){highlightStyle.brushType=brushType;highlightStyle.strokeColor=strokeColor;highlightStyle.lineWidth=lineWidth}},20)},ondrop:function(param){null!=ecData.get(param.dragged,"data")&&(self.isDrop=!0)},ondragend:function(){self.isDragend=!0}}}var ImageShape=require("zrender/shape/Image"),IconShape=require("../util/shape/Icon"),MarkLineShape=require("../util/shape/MarkLine"),SymbolShape=require("../util/shape/Symbol"),PolylineShape=require("zrender/shape/Polyline"),ShapeBundle=require("zrender/shape/ShapeBundle"),ecConfig=require("../config"),ecData=require("../util/ecData"),ecAnimation=require("../util/ecAnimation"),ecEffect=require("../util/ecEffect"),accMath=require("../util/accMath"),ComponentBase=require("../component/base"),EdgeBundling=require("../layout/EdgeBundling"),zrUtil=require("zrender/tool/util"),zrArea=require("zrender/tool/area");Base.prototype={setCalculable:function(shape){shape.dragEnableTime=this.ecTheme.DRAG_ENABLE_TIME||ecConfig.DRAG_ENABLE_TIME;shape.ondragover=this.shapeHandler.ondragover;shape.ondragend=this.shapeHandler.ondragend;shape.ondrop=this.shapeHandler.ondrop;return shape},ondrop:function(param,status){if(this.isDrop&&param.target&&!status.dragIn){var data,target=param.target,dragged=param.dragged,seriesIndex=ecData.get(target,"seriesIndex"),dataIndex=ecData.get(target,"dataIndex"),series=this.series,legend=this.component.legend;if(-1===dataIndex){if(ecData.get(dragged,"seriesIndex")==seriesIndex){status.dragOut=status.dragIn=status.needRefresh=!0;this.isDrop=!1;return}data={value:ecData.get(dragged,"value"),name:ecData.get(dragged,"name")};this.type===ecConfig.CHART_TYPE_PIE&&data.value<0&&(data.value=0);for(var hasFind=!1,sData=series[seriesIndex].data,i=0,l=sData.length;l>i;i++)if(sData[i].name===data.name&&"-"===sData[i].value){series[seriesIndex].data[i].value=data.value;hasFind=!0}!hasFind&&series[seriesIndex].data.push(data);legend&&legend.add(data.name,dragged.style.color||dragged.style.strokeColor)}else{data=series[seriesIndex].data[dataIndex]||"-";if(null!=data.value){"-"!=data.value?series[seriesIndex].data[dataIndex].value=accMath.accAdd(series[seriesIndex].data[dataIndex].value,ecData.get(dragged,"value")):series[seriesIndex].data[dataIndex].value=ecData.get(dragged,"value");if(this.type===ecConfig.CHART_TYPE_FUNNEL||this.type===ecConfig.CHART_TYPE_PIE){legend&&1===legend.getRelatedAmount(data.name)&&this.component.legend.del(data.name);data.name+=this.option.nameConnector+ecData.get(dragged,"name");legend&&legend.add(data.name,dragged.style.color||dragged.style.strokeColor)}}else"-"!=data?series[seriesIndex].data[dataIndex]=accMath.accAdd(series[seriesIndex].data[dataIndex],ecData.get(dragged,"value")):series[seriesIndex].data[dataIndex]=ecData.get(dragged,"value")}status.dragIn=status.dragIn||!0;this.isDrop=!1;var self=this;setTimeout(function(){self.zr.trigger("mousemove",param.event)},300)}},ondragend:function(param,status){if(this.isDragend&&param.target&&!status.dragOut){var target=param.target,seriesIndex=ecData.get(target,"seriesIndex"),dataIndex=ecData.get(target,"dataIndex"),series=this.series;if(null!=series[seriesIndex].data[dataIndex].value){series[seriesIndex].data[dataIndex].value="-";var name=series[seriesIndex].data[dataIndex].name,legend=this.component.legend;legend&&0===legend.getRelatedAmount(name)&&legend.del(name)}else series[seriesIndex].data[dataIndex]="-";status.dragOut=!0;status.needRefresh=!0;this.isDragend=!1}},onlegendSelected:function(param,status){var legendSelected=param.selected;for(var itemName in this.selectedMap){this.selectedMap[itemName]!=legendSelected[itemName]&&(status.needRefresh=!0);this.selectedMap[itemName]=legendSelected[itemName]}},_buildPosition:function(){this._symbol=this.option.symbolList;this._sIndex2ShapeMap={};this._sIndex2ColorMap={};this.selectedMap={};this.xMarkMap={};for(var xAxisIndex,yAxisIndex,xAxis,yAxis,series=this.series,_position2sIndexMap={top:[],bottom:[],left:[],right:[],other:[]},i=0,l=series.length;l>i;i++)if(series[i].type===this.type){series[i]=this.reformOption(series[i]);this.legendHoverLink=series[i].legendHoverLink||this.legendHoverLink;xAxisIndex=series[i].xAxisIndex;yAxisIndex=series[i].yAxisIndex;xAxis=this.component.xAxis.getAxis(xAxisIndex);yAxis=this.component.yAxis.getAxis(yAxisIndex);xAxis.type===ecConfig.COMPONENT_TYPE_AXIS_CATEGORY?_position2sIndexMap[xAxis.getPosition()].push(i):yAxis.type===ecConfig.COMPONENT_TYPE_AXIS_CATEGORY?_position2sIndexMap[yAxis.getPosition()].push(i):_position2sIndexMap.other.push(i)}for(var position in _position2sIndexMap)_position2sIndexMap[position].length>0&&this._buildSinglePosition(position,_position2sIndexMap[position]);this.addShapeList()},_buildSinglePosition:function(position,seriesArray){var mapData=this._mapData(seriesArray),locationMap=mapData.locationMap,maxDataLength=mapData.maxDataLength;if(0!==maxDataLength&&0!==locationMap.length){switch(position){case"bottom":case"top":this._buildHorizontal(seriesArray,maxDataLength,locationMap,this.xMarkMap);break;case"left":case"right":this._buildVertical(seriesArray,maxDataLength,locationMap,this.xMarkMap);break;case"other":this._buildOther(seriesArray,maxDataLength,locationMap,this.xMarkMap)}for(var i=0,l=seriesArray.length;l>i;i++)this.buildMark(seriesArray[i])}},_mapData:function(seriesArray){for(var serie,stackKey,serieName,iconShape,series=this.series,dataIndex=0,stackMap={},magicStackKey="__kener__stack__",legend=this.component.legend,locationMap=[],maxDataLength=0,i=0,l=seriesArray.length;l>i;i++){serie=series[seriesArray[i]];serieName=serie.name;this._sIndex2ShapeMap[seriesArray[i]]=this._sIndex2ShapeMap[seriesArray[i]]||this.query(serie,"symbol")||this._symbol[i%this._symbol.length];if(legend){this.selectedMap[serieName]=legend.isSelected(serieName);this._sIndex2ColorMap[seriesArray[i]]=legend.getColor(serieName);iconShape=legend.getItemShape(serieName);if(iconShape){var style=iconShape.style;if(this.type==ecConfig.CHART_TYPE_LINE){style.iconType="legendLineIcon";style.symbol=this._sIndex2ShapeMap[seriesArray[i]]}else if(serie.itemStyle.normal.barBorderWidth>0){var highlightStyle=iconShape.highlightStyle;style.brushType="both";style.x+=1;style.y+=1;style.width-=2;style.height-=2;style.strokeColor=highlightStyle.strokeColor=serie.itemStyle.normal.barBorderColor;highlightStyle.lineWidth=3}legend.setItemShape(serieName,iconShape)}}else{this.selectedMap[serieName]=!0;this._sIndex2ColorMap[seriesArray[i]]=this.zr.getColor(seriesArray[i])}if(this.selectedMap[serieName]){stackKey=serie.stack||magicStackKey+seriesArray[i];if(null==stackMap[stackKey]){stackMap[stackKey]=dataIndex;locationMap[dataIndex]=[seriesArray[i]];dataIndex++}else locationMap[stackMap[stackKey]].push(seriesArray[i])}maxDataLength=Math.max(maxDataLength,serie.data.length)}return{locationMap:locationMap,maxDataLength:maxDataLength}},_calculMarkMapXY:function(xMarkMap,locationMap,xy){for(var series=this.series,j=0,k=locationMap.length;k>j;j++)for(var m=0,n=locationMap[j].length;n>m;m++){var seriesIndex=locationMap[j][m],valueIndex="xy"==xy?0:"",grid=this.component.grid,tarMark=xMarkMap[seriesIndex];if("-1"!=xy.indexOf("x")){tarMark["counter"+valueIndex]>0&&(tarMark["average"+valueIndex]=tarMark["sum"+valueIndex]/tarMark["counter"+valueIndex]);var x=this.component.xAxis.getAxis(series[seriesIndex].xAxisIndex||0).getCoord(tarMark["average"+valueIndex]);tarMark["averageLine"+valueIndex]=[[x,grid.getYend()],[x,grid.getY()]];tarMark["minLine"+valueIndex]=[[tarMark["minX"+valueIndex],grid.getYend()],[tarMark["minX"+valueIndex],grid.getY()]];tarMark["maxLine"+valueIndex]=[[tarMark["maxX"+valueIndex],grid.getYend()],[tarMark["maxX"+valueIndex],grid.getY()]];tarMark.isHorizontal=!1}valueIndex="xy"==xy?1:"";if("-1"!=xy.indexOf("y")){tarMark["counter"+valueIndex]>0&&(tarMark["average"+valueIndex]=tarMark["sum"+valueIndex]/tarMark["counter"+valueIndex]);var y=this.component.yAxis.getAxis(series[seriesIndex].yAxisIndex||0).getCoord(tarMark["average"+valueIndex]);tarMark["averageLine"+valueIndex]=[[grid.getX(),y],[grid.getXend(),y]];tarMark["minLine"+valueIndex]=[[grid.getX(),tarMark["minY"+valueIndex]],[grid.getXend(),tarMark["minY"+valueIndex]]];tarMark["maxLine"+valueIndex]=[[grid.getX(),tarMark["maxY"+valueIndex]],[grid.getXend(),tarMark["maxY"+valueIndex]]];tarMark.isHorizontal=!0}}},addLabel:function(tarShape,serie,data,name,orient){var queryTarget=[data,serie],nLabel=this.deepMerge(queryTarget,"itemStyle.normal.label"),eLabel=this.deepMerge(queryTarget,"itemStyle.emphasis.label"),nTextStyle=nLabel.textStyle||{},eTextStyle=eLabel.textStyle||{};if(nLabel.show){var style=tarShape.style;style.text=this._getLabelText(serie,data,name,"normal");style.textPosition=null==nLabel.position?"horizontal"===orient?"right":"top":nLabel.position;style.textColor=nTextStyle.color;style.textFont=this.getFont(nTextStyle);style.textAlign=nTextStyle.align;style.textBaseline=nTextStyle.baseline}if(eLabel.show){var highlightStyle=tarShape.highlightStyle;highlightStyle.text=this._getLabelText(serie,data,name,"emphasis");highlightStyle.textPosition=nLabel.show?tarShape.style.textPosition:null==eLabel.position?"horizontal"===orient?"right":"top":eLabel.position;highlightStyle.textColor=eTextStyle.color;highlightStyle.textFont=this.getFont(eTextStyle);highlightStyle.textAlign=eTextStyle.align;highlightStyle.textBaseline=eTextStyle.baseline}return tarShape},_getLabelText:function(serie,data,name,status){var formatter=this.deepQuery([data,serie],"itemStyle."+status+".label.formatter");formatter||"emphasis"!==status||(formatter=this.deepQuery([data,serie],"itemStyle.normal.label.formatter"));var value=this.getDataFromOption(data,"-");if(!formatter)return value instanceof Array?null!=value[2]?this.numAddCommas(value[2]):value[0]+" , "+value[1]:this.numAddCommas(value);if("function"==typeof formatter)return formatter.call(this.myChart,{seriesName:serie.name,series:serie,name:name,value:value,data:data,status:status});if("string"==typeof formatter){formatter=formatter.replace("{a}","{a0}").replace("{b}","{b0}").replace("{c}","{c0}").replace("{a0}",serie.name).replace("{b0}",name).replace("{c0}",this.numAddCommas(value));return formatter}},buildMark:function(seriesIndex){var serie=this.series[seriesIndex];if(this.selectedMap[serie.name]){serie.markLine&&this._buildMarkLine(seriesIndex);serie.markPoint&&this._buildMarkPoint(seriesIndex)}},_buildMarkPoint:function(seriesIndex){for(var mpData,pos,attachStyle=(this.markAttachStyle||{})[seriesIndex],serie=this.series[seriesIndex],markPoint=zrUtil.clone(serie.markPoint),i=0,l=markPoint.data.length;l>i;i++){mpData=markPoint.data[i];pos=this.getMarkCoord(seriesIndex,mpData);mpData.x=null!=mpData.x?mpData.x:pos[0];mpData.y=null!=mpData.y?mpData.y:pos[1];if(mpData.type&&("max"===mpData.type||"min"===mpData.type)){mpData.value=pos[3];mpData.name=mpData.name||mpData.type;mpData.symbolSize=mpData.symbolSize||zrArea.getTextWidth(pos[3],this.getFont())/2+5}}for(var shapeList=this._markPoint(seriesIndex,markPoint),i=0,l=shapeList.length;l>i;i++){var tarShape=shapeList[i];tarShape.zlevel=serie.zlevel;tarShape.z=serie.z+1;for(var key in attachStyle)tarShape[key]=zrUtil.clone(attachStyle[key]);this.shapeList.push(tarShape)}if(this.type===ecConfig.CHART_TYPE_FORCE||this.type===ecConfig.CHART_TYPE_CHORD)for(var i=0,l=shapeList.length;l>i;i++)this.zr.addShape(shapeList[i])},_buildMarkLine:function(seriesIndex){for(var pos,attachStyle=(this.markAttachStyle||{})[seriesIndex],serie=this.series[seriesIndex],markLine=zrUtil.clone(serie.markLine),i=0,l=markLine.data.length;l>i;i++){var mlData=markLine.data[i];if(!mlData.type||"max"!==mlData.type&&"min"!==mlData.type&&"average"!==mlData.type)pos=[this.getMarkCoord(seriesIndex,mlData[0]),this.getMarkCoord(seriesIndex,mlData[1])];else{pos=this.getMarkCoord(seriesIndex,mlData);markLine.data[i]=[zrUtil.clone(mlData),{}];markLine.data[i][0].name=mlData.name||mlData.type;markLine.data[i][0].value="average"!==mlData.type?pos[3]:+pos[3].toFixed(null!=markLine.precision?markLine.precision:this.deepQuery([this.ecTheme,ecConfig],"markLine.precision"));pos=pos[2];mlData=[{},{}]}if(null!=pos&&null!=pos[0]&&null!=pos[1]){markLine.data[i][0].x=null!=mlData[0].x?mlData[0].x:pos[0][0];markLine.data[i][0].y=null!=mlData[0].y?mlData[0].y:pos[0][1];markLine.data[i][1].x=null!=mlData[1].x?mlData[1].x:pos[1][0];markLine.data[i][1].y=null!=mlData[1].y?mlData[1].y:pos[1][1]}}var shapeList=this._markLine(seriesIndex,markLine),isLarge=markLine.large;if(isLarge){var shapeBundle=new ShapeBundle({style:{shapeList:shapeList}}),firstShape=shapeList[0];if(firstShape){zrUtil.merge(shapeBundle.style,firstShape.style);zrUtil.merge(shapeBundle.highlightStyle={},firstShape.highlightStyle);shapeBundle.style.brushType="stroke";shapeBundle.zlevel=serie.zlevel;shapeBundle.z=serie.z+1;shapeBundle.hoverable=!1;for(var key in attachStyle)shapeBundle[key]=zrUtil.clone(attachStyle[key])}this.shapeList.push(shapeBundle);this.zr.addShape(shapeBundle);shapeBundle._mark="largeLine";var effect=markLine.effect;effect.show&&(shapeBundle.effect=effect)}else{for(var i=0,l=shapeList.length;l>i;i++){var tarShape=shapeList[i];tarShape.zlevel=serie.zlevel;tarShape.z=serie.z+1;for(var key in attachStyle)tarShape[key]=zrUtil.clone(attachStyle[key]);this.shapeList.push(tarShape)}if(this.type===ecConfig.CHART_TYPE_FORCE||this.type===ecConfig.CHART_TYPE_CHORD)for(var i=0,l=shapeList.length;l>i;i++)this.zr.addShape(shapeList[i])}},_markPoint:function(seriesIndex,mpOption){var serie=this.series[seriesIndex],component=this.component;zrUtil.merge(zrUtil.merge(mpOption,zrUtil.clone(this.ecTheme.markPoint||{})),zrUtil.clone(ecConfig.markPoint));mpOption.name=serie.name;var itemShape,color,value,queryTarget,nColor,eColor,effect,pList=[],data=mpOption.data,dataRange=component.dataRange,legend=component.legend,zrWidth=this.zr.getWidth(),zrHeight=this.zr.getHeight();if(mpOption.large){itemShape=this.getLargeMarkPointShape(seriesIndex,mpOption);itemShape._mark="largePoint";itemShape&&pList.push(itemShape)}else for(var i=0,l=data.length;l>i;i++)if(null!=data[i].x&&null!=data[i].y){value=null!=data[i].value?data[i].value:"";legend&&(color=legend.getColor(serie.name));if(dataRange){color=isNaN(value)?color:dataRange.getColor(value);queryTarget=[data[i],mpOption];nColor=this.deepQuery(queryTarget,"itemStyle.normal.color")||color;eColor=this.deepQuery(queryTarget,"itemStyle.emphasis.color")||nColor;if(null==nColor&&null==eColor)continue}color=null==color?this.zr.getColor(seriesIndex):color;data[i].tooltip=data[i].tooltip||mpOption.tooltip||{trigger:"item"};data[i].name=null!=data[i].name?data[i].name:"";data[i].value=value;itemShape=this.getSymbolShape(mpOption,seriesIndex,data[i],i,data[i].name,this.parsePercent(data[i].x,zrWidth),this.parsePercent(data[i].y,zrHeight),"pin",color,"rgba(0,0,0,0)","horizontal");itemShape._mark="point";effect=this.deepMerge([data[i],mpOption],"effect");effect.show&&(itemShape.effect=effect);serie.type===ecConfig.CHART_TYPE_MAP&&(itemShape._geo=this.getMarkGeo(data[i]));ecData.pack(itemShape,serie,seriesIndex,data[i],i,data[i].name,value);pList.push(itemShape)}return pList},_markLine:function(){function normalizeOptionValue(mlOption,key){mlOption[key]=mlOption[key]instanceof Array?mlOption[key].length>1?mlOption[key]:[mlOption[key][0],mlOption[key][0]]:[mlOption[key],mlOption[key]]}return function(seriesIndex,mlOption){var serie=this.series[seriesIndex],component=this.component,dataRange=component.dataRange,legend=component.legend;zrUtil.merge(zrUtil.merge(mlOption,zrUtil.clone(this.ecTheme.markLine||{})),zrUtil.clone(ecConfig.markLine));var defaultColor=legend?legend.getColor(serie.name):this.zr.getColor(seriesIndex);normalizeOptionValue(mlOption,"symbol");normalizeOptionValue(mlOption,"symbolSize");normalizeOptionValue(mlOption,"symbolRotate");for(var data=mlOption.data,edges=[],zrWidth=this.zr.getWidth(),zrHeight=this.zr.getHeight(),i=0;i<data.length;i++){var mlData=data[i];if(isCoordAvailable(mlData[0])&&isCoordAvailable(mlData[1])){var mergeData=this.deepMerge(mlData),queryTarget=[mergeData,mlOption],color=defaultColor,value=null!=mergeData.value?mergeData.value:"";if(dataRange){color=isNaN(value)?color:dataRange.getColor(value);var nColor=this.deepQuery(queryTarget,"itemStyle.normal.color")||color,eColor=this.deepQuery(queryTarget,"itemStyle.emphasis.color")||nColor;if(null==nColor&&null==eColor)continue}mlData[0].tooltip=mergeData.tooltip||mlOption.tooltip||{trigger:"item"};mlData[0].name=mlData[0].name||"";mlData[1].name=mlData[1].name||"";mlData[0].value=value;edges.push({points:[[this.parsePercent(mlData[0].x,zrWidth),this.parsePercent(mlData[0].y,zrHeight)],[this.parsePercent(mlData[1].x,zrWidth),this.parsePercent(mlData[1].y,zrHeight)]],rawData:mlData,color:color})}}var enableBundling=this.query(mlOption,"bundling.enable");if(enableBundling){var edgeBundling=new EdgeBundling;edgeBundling.maxTurningAngle=this.query(mlOption,"bundling.maxTurningAngle")/180*Math.PI;edges=edgeBundling.run(edges)}mlOption.name=serie.name;for(var shapeList=[],i=0,l=edges.length;l>i;i++){var edge=edges[i],rawEdge=edge.rawEdge||edge,mlData=rawEdge.rawData,value=null!=mlData.value?mlData.value:"",itemShape=this.getMarkLineShape(mlOption,seriesIndex,mlData,i,edge.points,enableBundling,rawEdge.color);itemShape._mark="line";var effect=this.deepMerge([mlData[0],mlData[1],mlOption],"effect");if(effect.show){itemShape.effect=effect;itemShape.effect.large=mlOption.large}serie.type===ecConfig.CHART_TYPE_MAP&&(itemShape._geo=[this.getMarkGeo(mlData[0]),this.getMarkGeo(mlData[1])]);ecData.pack(itemShape,serie,seriesIndex,mlData[0],i,mlData[0].name+(""!==mlData[1].name?" > "+mlData[1].name:""),value);shapeList.push(itemShape)}return shapeList}}(),getMarkCoord:function(){return[0,0]},getSymbolShape:function(serie,seriesIndex,data,dataIndex,name,x,y,symbol,color,emptyColor,orient){var queryTarget=[data,serie],value=this.getDataFromOption(data,"-");symbol=this.deepQuery(queryTarget,"symbol")||symbol;var symbolSize=this.deepQuery(queryTarget,"symbolSize");symbolSize="function"==typeof symbolSize?symbolSize(value):symbolSize;"number"==typeof symbolSize&&(symbolSize=[symbolSize,symbolSize]);var symbolRotate=this.deepQuery(queryTarget,"symbolRotate"),normal=this.deepMerge(queryTarget,"itemStyle.normal"),emphasis=this.deepMerge(queryTarget,"itemStyle.emphasis"),nBorderWidth=null!=normal.borderWidth?normal.borderWidth:normal.lineStyle&&normal.lineStyle.width;null==nBorderWidth&&(nBorderWidth=symbol.match("empty")?2:0);var eBorderWidth=null!=emphasis.borderWidth?emphasis.borderWidth:emphasis.lineStyle&&emphasis.lineStyle.width;null==eBorderWidth&&(eBorderWidth=nBorderWidth+2);var nColor=this.getItemStyleColor(normal.color,seriesIndex,dataIndex,data),eColor=this.getItemStyleColor(emphasis.color,seriesIndex,dataIndex,data),width=symbolSize[0],height=symbolSize[1],itemShape=new IconShape({style:{iconType:symbol.replace("empty","").toLowerCase(),x:x-width,y:y-height,width:2*width,height:2*height,brushType:"both",color:symbol.match("empty")?emptyColor:nColor||color,strokeColor:normal.borderColor||nColor||color,lineWidth:nBorderWidth},highlightStyle:{color:symbol.match("empty")?emptyColor:eColor||nColor||color,strokeColor:emphasis.borderColor||normal.borderColor||eColor||nColor||color,lineWidth:eBorderWidth},clickable:this.deepQuery(queryTarget,"clickable")});if(symbol.match("image")){itemShape.style.image=symbol.replace(new RegExp("^image:\\/\\/"),"");itemShape=new ImageShape({style:itemShape.style,highlightStyle:itemShape.highlightStyle,clickable:this.deepQuery(queryTarget,"clickable")})}null!=symbolRotate&&(itemShape.rotation=[symbolRotate*Math.PI/180,x,y]);if(symbol.match("star")){itemShape.style.iconType="star";itemShape.style.n=symbol.replace("empty","").replace("star","")-0||5}if("none"===symbol){itemShape.invisible=!0;itemShape.hoverable=!1}itemShape=this.addLabel(itemShape,serie,data,name,orient);if(symbol.match("empty")){null==itemShape.style.textColor&&(itemShape.style.textColor=itemShape.style.strokeColor);null==itemShape.highlightStyle.textColor&&(itemShape.highlightStyle.textColor=itemShape.highlightStyle.strokeColor)}ecData.pack(itemShape,serie,seriesIndex,data,dataIndex,name);itemShape._x=x;itemShape._y=y;itemShape._dataIndex=dataIndex;itemShape._seriesIndex=seriesIndex;return itemShape},getMarkLineShape:function(mlOption,seriesIndex,data,dataIndex,points,bundling,color){var value0=null!=data[0].value?data[0].value:"-",value1=null!=data[1].value?data[1].value:"-",symbol=[data[0].symbol||mlOption.symbol[0],data[1].symbol||mlOption.symbol[1]],symbolSize=[data[0].symbolSize||mlOption.symbolSize[0],data[1].symbolSize||mlOption.symbolSize[1]];symbolSize[0]="function"==typeof symbolSize[0]?symbolSize[0](value0):symbolSize[0];symbolSize[1]="function"==typeof symbolSize[1]?symbolSize[1](value1):symbolSize[1];var symbolRotate=[this.query(data[0],"symbolRotate")||mlOption.symbolRotate[0],this.query(data[1],"symbolRotate")||mlOption.symbolRotate[1]],queryTarget=[data[0],data[1],mlOption],normal=this.deepMerge(queryTarget,"itemStyle.normal");normal.color=this.getItemStyleColor(normal.color,seriesIndex,dataIndex,data);var emphasis=this.deepMerge(queryTarget,"itemStyle.emphasis");emphasis.color=this.getItemStyleColor(emphasis.color,seriesIndex,dataIndex,data);var nlineStyle=normal.lineStyle,elineStyle=emphasis.lineStyle,nBorderWidth=nlineStyle.width;null==nBorderWidth&&(nBorderWidth=normal.borderWidth);var eBorderWidth=elineStyle.width;null==eBorderWidth&&(eBorderWidth=null!=emphasis.borderWidth?emphasis.borderWidth:nBorderWidth+2);var smoothness=this.deepQuery(queryTarget,"smoothness");this.deepQuery(queryTarget,"smooth")||(smoothness=0);var ShapeCtor=bundling?PolylineShape:MarkLineShape,itemShape=new ShapeCtor({style:{symbol:symbol,symbolSize:symbolSize,symbolRotate:symbolRotate,brushType:"both",lineType:nlineStyle.type,shadowColor:nlineStyle.shadowColor||nlineStyle.color||normal.borderColor||normal.color||color,shadowBlur:nlineStyle.shadowBlur,shadowOffsetX:nlineStyle.shadowOffsetX,shadowOffsetY:nlineStyle.shadowOffsetY,color:normal.color||color,strokeColor:nlineStyle.color||normal.borderColor||normal.color||color,lineWidth:nBorderWidth,symbolBorderColor:normal.borderColor||normal.color||color,symbolBorder:normal.borderWidth},highlightStyle:{shadowColor:elineStyle.shadowColor,shadowBlur:elineStyle.shadowBlur,shadowOffsetX:elineStyle.shadowOffsetX,shadowOffsetY:elineStyle.shadowOffsetY,color:emphasis.color||normal.color||color,strokeColor:elineStyle.color||nlineStyle.color||emphasis.borderColor||normal.borderColor||emphasis.color||normal.color||color,lineWidth:eBorderWidth,symbolBorderColor:emphasis.borderColor||normal.borderColor||emphasis.color||normal.color||color,symbolBorder:null==emphasis.borderWidth?normal.borderWidth+2:emphasis.borderWidth},clickable:this.deepQuery(queryTarget,"clickable")}),shapeStyle=itemShape.style;if(bundling){shapeStyle.pointList=points;shapeStyle.smooth=smoothness}else{shapeStyle.xStart=points[0][0];shapeStyle.yStart=points[0][1];shapeStyle.xEnd=points[1][0];shapeStyle.yEnd=points[1][1];shapeStyle.curveness=smoothness;itemShape.updatePoints(itemShape.style)}itemShape=this.addLabel(itemShape,mlOption,data[0],data[0].name+" : "+data[1].name);return itemShape},getLargeMarkPointShape:function(seriesIndex,mpOption){var itemShape,color,value,nColor,eColor,effect,serie=this.series[seriesIndex],component=this.component,data=mpOption.data,dataRange=component.dataRange,legend=component.legend,queryTarget=[data[0],mpOption];legend&&(color=legend.getColor(serie.name));if(dataRange){value=null!=data[0].value?data[0].value:"";color=isNaN(value)?color:dataRange.getColor(value);nColor=this.deepQuery(queryTarget,"itemStyle.normal.color")||color;eColor=this.deepQuery(queryTarget,"itemStyle.emphasis.color")||nColor;if(null==nColor&&null==eColor)return}color=this.deepMerge(queryTarget,"itemStyle.normal").color||color;var symbol=this.deepQuery(queryTarget,"symbol")||"circle";symbol=symbol.replace("empty","").replace(/\d/g,"");effect=this.deepMerge([data[0],mpOption],"effect");var devicePixelRatio=window.devicePixelRatio||1;itemShape=new SymbolShape({style:{pointList:data,color:color,strokeColor:color,shadowColor:effect.shadowColor||color,shadowBlur:(null!=effect.shadowBlur?effect.shadowBlur:8)*devicePixelRatio,size:this.deepQuery(queryTarget,"symbolSize"),iconType:symbol,brushType:"fill",lineWidth:1},draggable:!1,hoverable:!1});effect.show&&(itemShape.effect=effect);return itemShape},backupShapeList:function(){if(this.shapeList&&this.shapeList.length>0){this.lastShapeList=this.shapeList;this.shapeList=[]}else this.lastShapeList=[]},addShapeList:function(){var delay,key,maxLenth=this.option.animationThreshold/(this.canvasSupported?2:4),lastShapeList=this.lastShapeList,shapeList=this.shapeList,isUpdate=lastShapeList.length>0,duration=isUpdate?this.query(this.option,"animationDurationUpdate"):this.query(this.option,"animationDuration"),easing=this.query(this.option,"animationEasing"),oldMap={},newMap={};if(this.option.animation&&!this.option.renderAsImage&&shapeList.length<maxLenth&&!this.motionlessOnce){for(var i=0,l=lastShapeList.length;l>i;i++){key=this._getAnimationKey(lastShapeList[i]);if(key.match("undefined"))this.zr.delShape(lastShapeList[i].id);else{key+=lastShapeList[i].type;oldMap[key]?this.zr.delShape(lastShapeList[i].id):oldMap[key]=lastShapeList[i]}}for(var i=0,l=shapeList.length;l>i;i++){key=this._getAnimationKey(shapeList[i]);if(key.match("undefined"))this.zr.addShape(shapeList[i]);else{key+=shapeList[i].type;newMap[key]=shapeList[i]}}for(key in oldMap)newMap[key]||this.zr.delShape(oldMap[key].id);for(key in newMap)if(oldMap[key]){this.zr.delShape(oldMap[key].id);this._animateMod(oldMap[key],newMap[key],duration,easing,0,isUpdate)}else{delay=this.type!=ecConfig.CHART_TYPE_LINE&&this.type!=ecConfig.CHART_TYPE_RADAR||0===key.indexOf("icon")?0:duration/2;this._animateMod(!1,newMap[key],duration,easing,delay,isUpdate)}this.zr.refresh();this.animationEffect()}else{this.motionlessOnce=!1;this.zr.delShape(lastShapeList);for(var i=0,l=shapeList.length;l>i;i++)this.zr.addShape(shapeList[i])}},_getAnimationKey:function(shape){return this.type!=ecConfig.CHART_TYPE_MAP&&this.type!=ecConfig.CHART_TYPE_TREEMAP&&this.type!=ecConfig.CHART_TYPE_VENN&&this.type!=ecConfig.CHART_TYPE_TREE?ecData.get(shape,"seriesIndex")+"_"+ecData.get(shape,"dataIndex")+(shape._mark?shape._mark:"")+(this.type===ecConfig.CHART_TYPE_RADAR?ecData.get(shape,"special"):""):ecData.get(shape,"seriesIndex")+"_"+ecData.get(shape,"dataIndex")+(shape._mark?shape._mark:"undefined")},_animateMod:function(oldShape,newShape,duration,easing,delay,isUpdate){switch(newShape.type){case"polyline":case"half-smooth-polygon":ecAnimation.pointList(this.zr,oldShape,newShape,duration,easing);break;case"rectangle":ecAnimation.rectangle(this.zr,oldShape,newShape,duration,easing);break;case"image":case"icon":ecAnimation.icon(this.zr,oldShape,newShape,duration,easing,delay);break;case"candle":isUpdate?this.zr.addShape(newShape):ecAnimation.candle(this.zr,oldShape,newShape,duration,easing);break;case"ring":case"sector":case"circle":isUpdate?"sector"===newShape.type?ecAnimation.sector(this.zr,oldShape,newShape,duration,easing):this.zr.addShape(newShape):ecAnimation.ring(this.zr,oldShape,newShape,duration+(ecData.get(newShape,"dataIndex")||0)%20*100,easing);break;case"text":ecAnimation.text(this.zr,oldShape,newShape,duration,easing);break;case"polygon":isUpdate?ecAnimation.pointList(this.zr,oldShape,newShape,duration,easing):ecAnimation.polygon(this.zr,oldShape,newShape,duration,easing);break;case"ribbon":ecAnimation.ribbon(this.zr,oldShape,newShape,duration,easing);break;case"gauge-pointer":ecAnimation.gaugePointer(this.zr,oldShape,newShape,duration,easing);break;case"mark-line":ecAnimation.markline(this.zr,oldShape,newShape,duration,easing);break;case"bezier-curve":case"line":ecAnimation.line(this.zr,oldShape,newShape,duration,easing);break;default:this.zr.addShape(newShape)}},animationMark:function(duration,easing,shapeList){for(var shapeList=shapeList||this.shapeList,i=0,l=shapeList.length;l>i;i++)shapeList[i]._mark&&this._animateMod(!1,shapeList[i],duration,easing,0,!0);this.animationEffect(shapeList)},animationEffect:function(shapeList){!shapeList&&this.clearEffectShape();shapeList=shapeList||this.shapeList;if(null!=shapeList){var zlevel=ecConfig.EFFECT_ZLEVEL;this.canvasSupported&&this.zr.modLayer(zlevel,{motionBlur:!0,lastFrameAlpha:this.option.effectBlendAlpha||ecConfig.effectBlendAlpha});for(var shape,i=0,l=shapeList.length;l>i;i++){shape=shapeList[i];if(shape._mark&&shape.effect&&shape.effect.show&&ecEffect[shape._mark]){ecEffect[shape._mark](this.zr,this.effectList,shape,zlevel);this.effectList[this.effectList.length-1]._mark=shape._mark}}}},clearEffectShape:function(clearMotionBlur){var effectList=this.effectList;if(this.zr&&effectList&&effectList.length>0){clearMotionBlur&&this.zr.modLayer(ecConfig.EFFECT_ZLEVEL,{motionBlur:!1});this.zr.delShape(effectList);for(var i=0;i<effectList.length;i++)effectList[i].effectAnimator&&effectList[i].effectAnimator.stop()}this.effectList=[]},addMark:function(seriesIndex,markData,markType){var serie=this.series[seriesIndex];if(this.selectedMap[serie.name]){var duration=this.query(this.option,"animationDurationUpdate"),easing=this.query(this.option,"animationEasing"),oriMarkData=serie[markType].data,lastLength=this.shapeList.length;serie[markType].data=markData.data;this["_build"+markType.replace("m","M")](seriesIndex);if(this.option.animation&&!this.option.renderAsImage)this.animationMark(duration,easing,this.shapeList.slice(lastLength));else{for(var i=lastLength,l=this.shapeList.length;l>i;i++)this.zr.addShape(this.shapeList[i]);this.zr.refreshNextFrame()}serie[markType].data=oriMarkData}},delMark:function(seriesIndex,markName,markType){markType=markType.replace("mark","").replace("large","").toLowerCase();var serie=this.series[seriesIndex];if(this.selectedMap[serie.name]){for(var needRefresh=!1,shapeList=[this.shapeList,this.effectList],len=2;len--;)for(var i=0,l=shapeList[len].length;l>i;i++)if(shapeList[len][i]._mark==markType&&ecData.get(shapeList[len][i],"seriesIndex")==seriesIndex&&ecData.get(shapeList[len][i],"name")==markName){this.zr.delShape(shapeList[len][i].id);shapeList[len].splice(i,1);needRefresh=!0;break}needRefresh&&this.zr.refreshNextFrame()}}};zrUtil.inherits(Base,ComponentBase);return Base});