define(["require","./base","zrender/shape/Rectangle","../util/shape/Icon","../util/shape/Chain","../config","zrender/tool/util","zrender/tool/area","zrender/tool/event","../component"],function(require){function Timeline(ecTheme,messageCenter,zr,option,myChart){Base.call(this,ecTheme,messageCenter,zr,option,myChart);var self=this;self._onclick=function(param){return self.__onclick(param)};self._ondrift=function(dx,dy){return self.__ondrift(this,dx,dy)};self._ondragend=function(){return self.__ondragend()};self._setCurrentOption=function(){var timelineOption=self.timelineOption;self.currentIndex%=timelineOption.data.length;var curOption=self.options[self.currentIndex]||{};self.myChart._setOption(curOption,timelineOption.notMerge,!0);self.messageCenter.dispatch(ecConfig.EVENT.TIMELINE_CHANGED,null,{currentIndex:self.currentIndex,data:null!=timelineOption.data[self.currentIndex].name?timelineOption.data[self.currentIndex].name:timelineOption.data[self.currentIndex]},self.myChart)};self._onFrame=function(){self._setCurrentOption();self._syncHandleShape();self.timelineOption.autoPlay&&(self.playTicket=setTimeout(function(){self.currentIndex+=1;if(!self.timelineOption.loop&&self.currentIndex>=self.timelineOption.data.length){self.currentIndex=self.timelineOption.data.length-1;self.stop()}else self._onFrame()},self.timelineOption.playInterval))};this.setTheme(!1);this.options=this.option.options;this.currentIndex=this.timelineOption.currentIndex%this.timelineOption.data.length;this.timelineOption.notMerge||0===this.currentIndex||(this.options[this.currentIndex]=zrUtil.merge(this.options[this.currentIndex],this.options[0]));if(this.timelineOption.show){this._buildShape();this._syncHandleShape()}this._setCurrentOption();if(this.timelineOption.autoPlay){var self=this;this.playTicket=setTimeout(function(){self.play()},null!=this.ecTheme.animationDuration?this.ecTheme.animationDuration:ecConfig.animationDuration)}}function timelineControl(ctx,style){var lineWidth=2,x=style.x+lineWidth,y=style.y+lineWidth+2,width=style.width-lineWidth,height=style.height-lineWidth,symbol=style.symbol;if("last"===symbol){ctx.moveTo(x+width-2,y+height/3);ctx.lineTo(x+width-2,y);ctx.lineTo(x+2,y+height/2);ctx.lineTo(x+width-2,y+height);ctx.lineTo(x+width-2,y+height/3*2);ctx.moveTo(x,y);ctx.lineTo(x,y)}else if("next"===symbol){ctx.moveTo(x+2,y+height/3);ctx.lineTo(x+2,y);ctx.lineTo(x+width-2,y+height/2);ctx.lineTo(x+2,y+height);ctx.lineTo(x+2,y+height/3*2);ctx.moveTo(x,y);ctx.lineTo(x,y)}else if("play"===symbol)if("stop"===style.status){ctx.moveTo(x+2,y);ctx.lineTo(x+width-2,y+height/2);ctx.lineTo(x+2,y+height);ctx.lineTo(x+2,y)}else{var delta="both"===style.brushType?2:3;ctx.rect(x+2,y,delta,height);ctx.rect(x+width-delta-2,y,delta,height)}else if(symbol.match("image")){var imageLocation="";imageLocation=symbol.replace(new RegExp("^image:\\/\\/"),"");symbol=IconShape.prototype.iconLibrary.image;symbol(ctx,{x:x,y:y,width:width,height:height,image:imageLocation})}}var Base=require("./base"),RectangleShape=require("zrender/shape/Rectangle"),IconShape=require("../util/shape/Icon"),ChainShape=require("../util/shape/Chain"),ecConfig=require("../config");ecConfig.timeline={zlevel:0,z:4,show:!0,type:"time",notMerge:!1,realtime:!0,x:80,x2:80,y2:0,height:50,backgroundColor:"rgba(0,0,0,0)",borderColor:"#ccc",borderWidth:0,padding:5,controlPosition:"left",autoPlay:!1,loop:!0,playInterval:2e3,lineStyle:{width:1,color:"#666",type:"dashed"},label:{show:!0,interval:"auto",rotate:0,textStyle:{color:"#333"}},checkpointStyle:{symbol:"auto",symbolSize:"auto",color:"auto",borderColor:"auto",borderWidth:"auto",label:{show:!1,textStyle:{color:"auto"}}},controlStyle:{itemSize:15,itemGap:5,normal:{color:"#333"},emphasis:{color:"#1e90ff"}},symbol:"emptyDiamond",symbolSize:4,currentIndex:0};var zrUtil=require("zrender/tool/util"),zrArea=require("zrender/tool/area"),zrEvent=require("zrender/tool/event");Timeline.prototype={type:ecConfig.COMPONENT_TYPE_TIMELINE,_buildShape:function(){this._location=this._getLocation();this._buildBackground();this._buildControl();this._chainPoint=this._getChainPoint();if(this.timelineOption.label.show)for(var interval=this._getInterval(),i=0,len=this._chainPoint.length;len>i;i+=interval)this._chainPoint[i].showLabel=!0;this._buildChain();this._buildHandle();for(var i=0,l=this.shapeList.length;l>i;i++)this.zr.addShape(this.shapeList[i])},_getLocation:function(){var width,timelineOption=this.timelineOption,padding=this.reformCssArray(this.timelineOption.padding),zrWidth=this.zr.getWidth(),x=this.parsePercent(timelineOption.x,zrWidth),x2=this.parsePercent(timelineOption.x2,zrWidth);if(null==timelineOption.width){width=zrWidth-x-x2;x2=zrWidth-x2}else{width=this.parsePercent(timelineOption.width,zrWidth);x2=x+width}var y,y2,zrHeight=this.zr.getHeight(),height=this.parsePercent(timelineOption.height,zrHeight);if(null!=timelineOption.y){y=this.parsePercent(timelineOption.y,zrHeight);y2=y+height}else{y2=zrHeight-this.parsePercent(timelineOption.y2,zrHeight);y=y2-height}return{x:x+padding[3],y:y+padding[0],x2:x2-padding[1],y2:y2-padding[2],width:width-padding[1]-padding[3],height:height-padding[0]-padding[2]}},_getReformedLabel:function(idx){var timelineOption=this.timelineOption,data=null!=timelineOption.data[idx].name?timelineOption.data[idx].name:timelineOption.data[idx],formatter=timelineOption.data[idx].formatter||timelineOption.label.formatter;formatter&&("function"==typeof formatter?data=formatter.call(this.myChart,data):"string"==typeof formatter&&(data=formatter.replace("{value}",data)));return data},_getInterval:function(){var chainPoint=this._chainPoint,timelineOption=this.timelineOption,interval=timelineOption.label.interval;if("auto"===interval){var fontSize=timelineOption.label.textStyle.fontSize,data=timelineOption.data,dataLength=timelineOption.data.length;if(dataLength>3){var labelSpace,labelSize,isEnough=!1;interval=0;for(;!isEnough&&dataLength>interval;){interval++;isEnough=!0;for(var i=interval;dataLength>i;i+=interval){labelSpace=chainPoint[i].x-chainPoint[i-interval].x;if(0!==timelineOption.label.rotate)labelSize=fontSize;else if(data[i].textStyle)labelSize=zrArea.getTextWidth(chainPoint[i].name,chainPoint[i].textFont);else{var label=chainPoint[i].name+"",wLen=(label.match(/\w/g)||"").length,oLen=label.length-wLen;labelSize=wLen*fontSize*2/3+oLen*fontSize}if(labelSize>labelSpace){isEnough=!1;break}}}}else interval=1}else interval=interval-0+1;return interval},_getChainPoint:function(){function _getName(i){return null!=data[i].name?data[i].name:data[i]+""}var dataTextStyle,timelineOption=this.timelineOption,symbol=timelineOption.symbol.toLowerCase(),symbolSize=timelineOption.symbolSize,rotate=timelineOption.label.rotate,textStyle=timelineOption.label.textStyle,textFont=this.getFont(textStyle),data=timelineOption.data,x=this._location.x,y=this._location.y+this._location.height/4*3,width=this._location.x2-this._location.x,len=data.length,xList=[];if(len>1){var boundaryGap=width/len;boundaryGap=boundaryGap>50?50:20>boundaryGap?5:boundaryGap;width-=2*boundaryGap;if("number"===timelineOption.type)for(var i=0;len>i;i++)xList.push(x+boundaryGap+width/(len-1)*i);else{xList[0]=new Date(_getName(0).replace(/-/g,"/"));xList[len-1]=new Date(_getName(len-1).replace(/-/g,"/"))-xList[0];for(var i=1;len>i;i++)xList[i]=x+boundaryGap+width*(new Date(_getName(i).replace(/-/g,"/"))-xList[0])/xList[len-1];xList[0]=x+boundaryGap}}else xList.push(x+width/2);for(var curSymbol,n,isEmpty,textAlign,rotation,list=[],i=0;len>i;i++){x=xList[i];curSymbol=data[i].symbol&&data[i].symbol.toLowerCase()||symbol;if(curSymbol.match("empty")){curSymbol=curSymbol.replace("empty","");isEmpty=!0}else isEmpty=!1;if(curSymbol.match("star")){n=curSymbol.replace("star","")-0||5;curSymbol="star"}dataTextStyle=data[i].textStyle?zrUtil.merge(data[i].textStyle||{},textStyle):textStyle;textAlign=dataTextStyle.align||"center";if(rotate){textAlign=rotate>0?"right":"left";rotation=[rotate*Math.PI/180,x,y-5]}else rotation=!1;list.push({x:x,n:n,isEmpty:isEmpty,symbol:curSymbol,symbolSize:data[i].symbolSize||symbolSize,color:data[i].color,borderColor:data[i].borderColor,borderWidth:data[i].borderWidth,name:this._getReformedLabel(i),textColor:dataTextStyle.color,textAlign:textAlign,textBaseline:dataTextStyle.baseline||"middle",textX:x,textY:y-(rotate?5:0),textFont:data[i].textStyle?this.getFont(dataTextStyle):textFont,rotation:rotation,showLabel:!1})}return list},_buildBackground:function(){var timelineOption=this.timelineOption,padding=this.reformCssArray(this.timelineOption.padding),width=this._location.width,height=this._location.height;(0!==timelineOption.borderWidth||"rgba(0,0,0,0)"!=timelineOption.backgroundColor.replace(/\s/g,""))&&this.shapeList.push(new RectangleShape({zlevel:this.getZlevelBase(),z:this.getZBase(),hoverable:!1,style:{x:this._location.x-padding[3],y:this._location.y-padding[0],width:width+padding[1]+padding[3],height:height+padding[0]+padding[2],brushType:0===timelineOption.borderWidth?"fill":"both",color:timelineOption.backgroundColor,strokeColor:timelineOption.borderColor,lineWidth:timelineOption.borderWidth}}))},_buildControl:function(){var self=this,timelineOption=this.timelineOption,lineStyle=timelineOption.lineStyle,controlStyle=timelineOption.controlStyle;if("none"!==timelineOption.controlPosition){var x,iconSize=controlStyle.itemSize,iconGap=controlStyle.itemGap;if("left"===timelineOption.controlPosition){x=this._location.x;this._location.x+=3*(iconSize+iconGap)}else{x=this._location.x2-(3*(iconSize+iconGap)-iconGap);this._location.x2-=3*(iconSize+iconGap)}var y=this._location.y,iconStyle={zlevel:this.getZlevelBase(),z:this.getZBase()+1,style:{iconType:"timelineControl",symbol:"last",x:x,y:y,width:iconSize,height:iconSize,brushType:"stroke",color:controlStyle.normal.color,strokeColor:controlStyle.normal.color,lineWidth:lineStyle.width},highlightStyle:{color:controlStyle.emphasis.color,strokeColor:controlStyle.emphasis.color,lineWidth:lineStyle.width+1},clickable:!0};this._ctrLastShape=new IconShape(iconStyle);this._ctrLastShape.onclick=function(){self.last()};this.shapeList.push(this._ctrLastShape);x+=iconSize+iconGap;this._ctrPlayShape=new IconShape(zrUtil.clone(iconStyle));this._ctrPlayShape.style.brushType="fill";this._ctrPlayShape.style.symbol="play";this._ctrPlayShape.style.status=this.timelineOption.autoPlay?"playing":"stop";this._ctrPlayShape.style.x=x;this._ctrPlayShape.onclick=function(){"stop"===self._ctrPlayShape.style.status?self.play():self.stop()};this.shapeList.push(this._ctrPlayShape);x+=iconSize+iconGap;this._ctrNextShape=new IconShape(zrUtil.clone(iconStyle));this._ctrNextShape.style.symbol="next";this._ctrNextShape.style.x=x;this._ctrNextShape.onclick=function(){self.next()};this.shapeList.push(this._ctrNextShape)}},_buildChain:function(){var timelineOption=this.timelineOption,lineStyle=timelineOption.lineStyle;this._timelineShae={zlevel:this.getZlevelBase(),z:this.getZBase(),style:{x:this._location.x,y:this.subPixelOptimize(this._location.y,lineStyle.width),width:this._location.x2-this._location.x,height:this._location.height,chainPoint:this._chainPoint,brushType:"both",strokeColor:lineStyle.color,lineWidth:lineStyle.width,lineType:lineStyle.type},hoverable:!1,clickable:!0,onclick:this._onclick};this._timelineShae=new ChainShape(this._timelineShae);this.shapeList.push(this._timelineShae)},_buildHandle:function(){var curPoint=this._chainPoint[this.currentIndex],symbolSize=curPoint.symbolSize+1;symbolSize=5>symbolSize?5:symbolSize;this._handleShape={zlevel:this.getZlevelBase(),z:this.getZBase()+1,hoverable:!1,draggable:!0,style:{iconType:"diamond",n:curPoint.n,x:curPoint.x-symbolSize,y:this._location.y+this._location.height/4-symbolSize,width:2*symbolSize,height:2*symbolSize,brushType:"both",textPosition:"specific",textX:curPoint.x,textY:this._location.y-this._location.height/4,textAlign:"center",textBaseline:"middle"},highlightStyle:{},ondrift:this._ondrift,ondragend:this._ondragend};this._handleShape=new IconShape(this._handleShape);this.shapeList.push(this._handleShape)},_syncHandleShape:function(){if(this.timelineOption.show){var timelineOption=this.timelineOption,cpStyle=timelineOption.checkpointStyle,curPoint=this._chainPoint[this.currentIndex];this._handleShape.style.text=cpStyle.label.show?curPoint.name:"";this._handleShape.style.textFont=curPoint.textFont;this._handleShape.style.n=curPoint.n;if("auto"===cpStyle.symbol)this._handleShape.style.iconType="none"!=curPoint.symbol?curPoint.symbol:"diamond";else{this._handleShape.style.iconType=cpStyle.symbol;if(cpStyle.symbol.match("star")){this._handleShape.style.n=cpStyle.symbol.replace("star","")-0||5;this._handleShape.style.iconType="star"}}var symbolSize;if("auto"===cpStyle.symbolSize){symbolSize=curPoint.symbolSize+2;symbolSize=5>symbolSize?5:symbolSize}else symbolSize=cpStyle.symbolSize-0;this._handleShape.style.color="auto"===cpStyle.color?curPoint.color?curPoint.color:timelineOption.controlStyle.emphasis.color:cpStyle.color;this._handleShape.style.textColor="auto"===cpStyle.label.textStyle.color?this._handleShape.style.color:cpStyle.label.textStyle.color;this._handleShape.highlightStyle.strokeColor=this._handleShape.style.strokeColor="auto"===cpStyle.borderColor?curPoint.borderColor?curPoint.borderColor:"#fff":cpStyle.borderColor;this._handleShape.style.lineWidth="auto"===cpStyle.borderWidth?curPoint.borderWidth?curPoint.borderWidth:0:cpStyle.borderWidth-0;this._handleShape.highlightStyle.lineWidth=this._handleShape.style.lineWidth+1;this.zr.animate(this._handleShape.id,"style").when(500,{x:curPoint.x-symbolSize,textX:curPoint.x,y:this._location.y+this._location.height/4-symbolSize,width:2*symbolSize,height:2*symbolSize}).start("ExponentialOut")}},_findChainIndex:function(x){var chainPoint=this._chainPoint,len=chainPoint.length;if(x<=chainPoint[0].x)return 0;if(x>=chainPoint[len-1].x)return len-1;for(var i=0;len-1>i;i++)if(x>=chainPoint[i].x&&x<=chainPoint[i+1].x)return Math.abs(x-chainPoint[i].x)<Math.abs(x-chainPoint[i+1].x)?i:i+1},__onclick:function(param){var x=zrEvent.getX(param.event),newIndex=this._findChainIndex(x);if(newIndex===this.currentIndex)return!0;this.currentIndex=newIndex;this.timelineOption.autoPlay&&this.stop();clearTimeout(this.playTicket);this._onFrame()},__ondrift:function(shape,dx){this.timelineOption.autoPlay&&this.stop();var newIndex,chainPoint=this._chainPoint,len=chainPoint.length;if(shape.style.x+dx<=chainPoint[0].x-chainPoint[0].symbolSize){shape.style.x=chainPoint[0].x-chainPoint[0].symbolSize;newIndex=0}else if(shape.style.x+dx>=chainPoint[len-1].x-chainPoint[len-1].symbolSize){shape.style.x=chainPoint[len-1].x-chainPoint[len-1].symbolSize;newIndex=len-1}else{shape.style.x+=dx;newIndex=this._findChainIndex(shape.style.x)}var curPoint=chainPoint[newIndex],symbolSize=curPoint.symbolSize+2;shape.style.iconType=curPoint.symbol;shape.style.n=curPoint.n;shape.style.textX=shape.style.x+symbolSize/2;shape.style.y=this._location.y+this._location.height/4-symbolSize;shape.style.width=2*symbolSize;shape.style.height=2*symbolSize;shape.style.text=curPoint.name;if(newIndex===this.currentIndex)return!0;this.currentIndex=newIndex;if(this.timelineOption.realtime){clearTimeout(this.playTicket);var self=this;this.playTicket=setTimeout(function(){self._setCurrentOption()},200)}return!0},__ondragend:function(){this.isDragend=!0},ondragend:function(param,status){if(this.isDragend&&param.target){!this.timelineOption.realtime&&this._setCurrentOption();status.dragOut=!0;status.dragIn=!0;status.needRefresh=!1;this.isDragend=!1;this._syncHandleShape()}},last:function(){this.timelineOption.autoPlay&&this.stop();this.currentIndex-=1;this.currentIndex<0&&(this.currentIndex=this.timelineOption.data.length-1);this._onFrame();return this.currentIndex},next:function(){this.timelineOption.autoPlay&&this.stop();this.currentIndex+=1;this.currentIndex>=this.timelineOption.data.length&&(this.currentIndex=0);this._onFrame();return this.currentIndex},play:function(targetIndex,autoPlay){if(this._ctrPlayShape&&"playing"!=this._ctrPlayShape.style.status){this._ctrPlayShape.style.status="playing";this.zr.modShape(this._ctrPlayShape.id);this.zr.refreshNextFrame()}this.timelineOption.autoPlay=null!=autoPlay?autoPlay:!0;this.timelineOption.autoPlay||clearTimeout(this.playTicket);this.currentIndex=null!=targetIndex?targetIndex:this.currentIndex+1;this.currentIndex>=this.timelineOption.data.length&&(this.currentIndex=0);this._onFrame();return this.currentIndex},stop:function(){if(this._ctrPlayShape&&"stop"!=this._ctrPlayShape.style.status){this._ctrPlayShape.style.status="stop";this.zr.modShape(this._ctrPlayShape.id);this.zr.refreshNextFrame()}this.timelineOption.autoPlay=!1;clearTimeout(this.playTicket);return this.currentIndex},resize:function(){if(this.timelineOption.show){this.clear();this._buildShape();this._syncHandleShape()}},setTheme:function(needRefresh){this.timelineOption=this.reformOption(zrUtil.clone(this.option.timeline));this.timelineOption.label.textStyle=this.getTextStyle(this.timelineOption.label.textStyle);this.timelineOption.checkpointStyle.label.textStyle=this.getTextStyle(this.timelineOption.checkpointStyle.label.textStyle);this.myChart.canvasSupported||(this.timelineOption.realtime=!1);if(this.timelineOption.show&&needRefresh){this.clear();this._buildShape();this._syncHandleShape()}},onbeforDispose:function(){clearTimeout(this.playTicket)}};IconShape.prototype.iconLibrary.timelineControl=timelineControl;zrUtil.inherits(Timeline,Base);require("../component").define("timeline",Timeline);return Timeline});