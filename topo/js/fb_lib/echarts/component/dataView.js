define(["require","./base","../config","zrender/tool/util","../component"],function(require){function DataView(ecTheme,messageCenter,zr,option,myChart){Base.call(this,ecTheme,messageCenter,zr,option,myChart);this.dom=myChart.dom;this._tDom=document.createElement("div");this._textArea=document.createElement("textArea");this._buttonRefresh=document.createElement("button");this._buttonRefresh.setAttribute("type","button");this._buttonClose=document.createElement("button");this._buttonClose.setAttribute("type","button");this._hasShow=!1;this._zrHeight=zr.getHeight();this._zrWidth=zr.getWidth();this._tDom.className="echarts-dataview";this.hide();this.dom.firstChild.appendChild(this._tDom);if(window.addEventListener){this._tDom.addEventListener("click",this._stop);this._tDom.addEventListener("mousewheel",this._stop);this._tDom.addEventListener("mousemove",this._stop);this._tDom.addEventListener("mousedown",this._stop);this._tDom.addEventListener("mouseup",this._stop);this._tDom.addEventListener("touchstart",this._stop);this._tDom.addEventListener("touchmove",this._stop);this._tDom.addEventListener("touchend",this._stop)}else{this._tDom.attachEvent("onclick",this._stop);this._tDom.attachEvent("onmousewheel",this._stop);this._tDom.attachEvent("onmousemove",this._stop);this._tDom.attachEvent("onmousedown",this._stop);this._tDom.attachEvent("onmouseup",this._stop)}}var Base=require("./base"),ecConfig=require("../config"),zrUtil=require("zrender/tool/util");DataView.prototype={type:ecConfig.COMPONENT_TYPE_DATAVIEW,_lang:["Data View","close","refresh"],_gCssText:"position:absolute;display:block;overflow:hidden;transition:height 0.8s,background-color 1s;-moz-transition:height 0.8s,background-color 1s;-webkit-transition:height 0.8s,background-color 1s;-o-transition:height 0.8s,background-color 1s;z-index:1;left:0;top:0;",hide:function(){this._sizeCssText="width:"+this._zrWidth+"px;height:0px;background-color:#f0ffff;";this._tDom.style.cssText=this._gCssText+this._sizeCssText},show:function(newOption){this._hasShow=!0;var lang=this.query(this.option,"toolbox.feature.dataView.lang")||this._lang;this.option=newOption;this._tDom.innerHTML='<p style="padding:8px 0;margin:0 0 10px 0;border-bottom:1px solid #eee">'+(lang[0]||this._lang[0])+"</p>";var customContent=this.query(this.option,"toolbox.feature.dataView.optionToContent");if("function"!=typeof customContent)this._textArea.value=this._optionToContent();else{this._textArea=document.createElement("div");this._textArea.innerHTML=customContent(this.option)}this._textArea.style.cssText="display:block;margin:0 0 8px 0;padding:4px 6px;overflow:auto;width:100%;height:"+(this._zrHeight-100)+"px;";this._tDom.appendChild(this._textArea);this._buttonClose.style.cssText="float:right;padding:1px 6px;";this._buttonClose.innerHTML=lang[1]||this._lang[1];var self=this;this._buttonClose.onclick=function(){self.hide()};this._tDom.appendChild(this._buttonClose);if(this.query(this.option,"toolbox.feature.dataView.readOnly")===!1){this._buttonRefresh.style.cssText="float:right;margin-right:10px;padding:1px 6px;";this._buttonRefresh.innerHTML=lang[2]||this._lang[2];this._buttonRefresh.onclick=function(){self._save()};this._textArea.readOnly=!1;this._textArea.style.cursor="default"}else{this._buttonRefresh.style.cssText="display:none";this._textArea.readOnly=!0;this._textArea.style.cursor="text"}this._tDom.appendChild(this._buttonRefresh);this._sizeCssText="width:"+this._zrWidth+"px;height:"+this._zrHeight+"px;background-color:#fff;";this._tDom.style.cssText=this._gCssText+this._sizeCssText},_optionToContent:function(){var i,j,k,len,data,valueList,axisList=[],content="";if(this.option.xAxis){axisList=this.option.xAxis instanceof Array?this.option.xAxis:[this.option.xAxis];for(i=0,len=axisList.length;len>i;i++)if("category"==(axisList[i].type||"category")){valueList=[];for(j=0,k=axisList[i].data.length;k>j;j++)valueList.push(this.getDataFromOption(axisList[i].data[j]));content+=valueList.join(", ")+"\n\n"}}if(this.option.yAxis){axisList=this.option.yAxis instanceof Array?this.option.yAxis:[this.option.yAxis];for(i=0,len=axisList.length;len>i;i++)if("category"==axisList[i].type){valueList=[];for(j=0,k=axisList[i].data.length;k>j;j++)valueList.push(this.getDataFromOption(axisList[i].data[j]));content+=valueList.join(", ")+"\n\n"}}var itemName,series=this.option.series;for(i=0,len=series.length;len>i;i++){valueList=[];for(j=0,k=series[i].data.length;k>j;j++){data=series[i].data[j];itemName=series[i].type==ecConfig.CHART_TYPE_PIE||series[i].type==ecConfig.CHART_TYPE_MAP?(data.name||"-")+":":"";series[i].type==ecConfig.CHART_TYPE_SCATTER&&(data=this.getDataFromOption(data).join(", "));valueList.push(itemName+this.getDataFromOption(data))}content+=(series[i].name||"-")+" : \n";content+=valueList.join(series[i].type==ecConfig.CHART_TYPE_SCATTER?"\n":", ");content+="\n\n"}return content},_save:function(){var customContent=this.query(this.option,"toolbox.feature.dataView.contentToOption");if("function"!=typeof customContent){for(var text=this._textArea.value.split("\n"),content=[],i=0,l=text.length;l>i;i++){text[i]=this._trim(text[i]);""!==text[i]&&content.push(text[i])}this._contentToOption(content)}else customContent(this._textArea,this.option);this.hide();var self=this;setTimeout(function(){self.messageCenter&&self.messageCenter.dispatch(ecConfig.EVENT.DATA_VIEW_CHANGED,null,{option:self.option},self.myChart)},self.canvasSupported?800:100)},_contentToOption:function(content){var i,j,k,len,data,contentValueList,value,axisList=[],contentIdx=0;if(this.option.xAxis){axisList=this.option.xAxis instanceof Array?this.option.xAxis:[this.option.xAxis];for(i=0,len=axisList.length;len>i;i++)if("category"==(axisList[i].type||"category")){contentValueList=content[contentIdx].split(",");for(j=0,k=axisList[i].data.length;k>j;j++){value=this._trim(contentValueList[j]||"");data=axisList[i].data[j];"undefined"!=typeof axisList[i].data[j].value?axisList[i].data[j].value=value:axisList[i].data[j]=value}contentIdx++}}if(this.option.yAxis){axisList=this.option.yAxis instanceof Array?this.option.yAxis:[this.option.yAxis];for(i=0,len=axisList.length;len>i;i++)if("category"==axisList[i].type){contentValueList=content[contentIdx].split(",");for(j=0,k=axisList[i].data.length;k>j;j++){value=this._trim(contentValueList[j]||"");data=axisList[i].data[j];"undefined"!=typeof axisList[i].data[j].value?axisList[i].data[j].value=value:axisList[i].data[j]=value}contentIdx++}}var series=this.option.series;for(i=0,len=series.length;len>i;i++){contentIdx++;if(series[i].type==ecConfig.CHART_TYPE_SCATTER)for(var j=0,k=series[i].data.length;k>j;j++){contentValueList=content[contentIdx];value=contentValueList.replace(" ","").split(",");"undefined"!=typeof series[i].data[j].value?series[i].data[j].value=value:series[i].data[j]=value;contentIdx++}else{contentValueList=content[contentIdx].split(",");for(var j=0,k=series[i].data.length;k>j;j++){value=(contentValueList[j]||"").replace(/.*:/,"");value=this._trim(value);value="-"!=value&&""!==value?value-0:"-";"undefined"!=typeof series[i].data[j].value?series[i].data[j].value=value:series[i].data[j]=value}contentIdx++}}},_trim:function(str){var trimer=new RegExp("(^[\\s\\t\\xa0\\u3000]+)|([\\u3000\\xa0\\s\\t]+$)","g");return str.replace(trimer,"")},_stop:function(e){e=e||window.event;e.stopPropagation?e.stopPropagation():e.cancelBubble=!0},resize:function(){this._zrHeight=this.zr.getHeight();this._zrWidth=this.zr.getWidth();if(this._tDom.offsetHeight>10){this._sizeCssText="width:"+this._zrWidth+"px;height:"+this._zrHeight+"px;background-color:#fff;";this._tDom.style.cssText=this._gCssText+this._sizeCssText;this._textArea.style.cssText="display:block;margin:0 0 8px 0;padding:4px 6px;overflow:auto;width:100%;height:"+(this._zrHeight-100)+"px;"}},dispose:function(){if(window.removeEventListener){this._tDom.removeEventListener("click",this._stop);this._tDom.removeEventListener("mousewheel",this._stop);this._tDom.removeEventListener("mousemove",this._stop);this._tDom.removeEventListener("mousedown",this._stop);this._tDom.removeEventListener("mouseup",this._stop);this._tDom.removeEventListener("touchstart",this._stop);this._tDom.removeEventListener("touchmove",this._stop);this._tDom.removeEventListener("touchend",this._stop)}else{this._tDom.detachEvent("onclick",this._stop);this._tDom.detachEvent("onmousewheel",this._stop);this._tDom.detachEvent("onmousemove",this._stop);this._tDom.detachEvent("onmousedown",this._stop);this._tDom.detachEvent("onmouseup",this._stop)}this._buttonRefresh.onclick=null;this._buttonClose.onclick=null;if(this._hasShow){this._tDom.removeChild(this._textArea);this._tDom.removeChild(this._buttonRefresh);this._tDom.removeChild(this._buttonClose)}this._textArea=null;this._buttonRefresh=null;this._buttonClose=null;this.dom.firstChild.removeChild(this._tDom);this._tDom=null}};zrUtil.inherits(DataView,Base);require("../component").define("dataView",DataView);return DataView});