define(["require","./base","zrender/shape/Text","zrender/shape/Rectangle","zrender/shape/Sector","../util/shape/Icon","../util/shape/Candle","../config","zrender/tool/util","zrender/tool/area","../component"],function(require){function Legend(ecTheme,messageCenter,zr,option,myChart){if(this.query(option,"legend.data")){Base.call(this,ecTheme,messageCenter,zr,option,myChart);var self=this;self._legendSelected=function(param){self.__legendSelected(param)};self._dispatchHoverLink=function(param){return self.__dispatchHoverLink(param)};this._colorIndex=0;this._colorMap={};this._selectedMap={};this._hasDataMap={};this.refresh(option)}else console.error("option.legend.data has not been defined.")}var Base=require("./base"),TextShape=require("zrender/shape/Text"),RectangleShape=require("zrender/shape/Rectangle"),SectorShape=require("zrender/shape/Sector"),IconShape=require("../util/shape/Icon"),CandleShape=require("../util/shape/Candle"),ecConfig=require("../config");ecConfig.legend={zlevel:0,z:4,show:!0,orient:"horizontal",x:"center",y:"top",backgroundColor:"rgba(0,0,0,0)",borderColor:"#ccc",borderWidth:0,padding:5,itemGap:10,itemWidth:20,itemHeight:14,textStyle:{color:"#333"},selectedMode:!0};var zrUtil=require("zrender/tool/util"),zrArea=require("zrender/tool/area");Legend.prototype={type:ecConfig.COMPONENT_TYPE_LEGEND,_buildShape:function(){if(this.legendOption.show){this._itemGroupLocation=this._getItemGroupLocation();this._buildBackground();this._buildItem();for(var i=0,l=this.shapeList.length;l>i;i++)this.zr.addShape(this.shapeList[i])}},_buildItem:function(){var itemName,itemType,itemShape,textShape,dataTextStyle,dataFont,formattedName,color,data=this.legendOption.data,dataLength=data.length,textStyle=this.legendOption.textStyle,zrWidth=this.zr.getWidth(),zrHeight=this.zr.getHeight(),lastX=this._itemGroupLocation.x,lastY=this._itemGroupLocation.y,itemWidth=this.legendOption.itemWidth,itemHeight=this.legendOption.itemHeight,itemGap=this.legendOption.itemGap;"vertical"===this.legendOption.orient&&"right"===this.legendOption.x&&(lastX=this._itemGroupLocation.x+this._itemGroupLocation.width-itemWidth);for(var i=0;dataLength>i;i++){dataTextStyle=zrUtil.merge(data[i].textStyle||{},textStyle);dataFont=this.getFont(dataTextStyle);itemName=this._getName(data[i]);formattedName=this._getFormatterName(itemName);if(""!==itemName){itemType=data[i].icon||this._getSomethingByName(itemName).type;color=this.getColor(itemName);if("horizontal"===this.legendOption.orient){if(200>zrWidth-lastX&&itemWidth+5+zrArea.getTextWidth(formattedName,dataFont)+(i===dataLength-1||""===data[i+1]?0:itemGap)>=zrWidth-lastX){lastX=this._itemGroupLocation.x;lastY+=itemHeight+itemGap}}else if(200>zrHeight-lastY&&itemHeight+(i===dataLength-1||""===data[i+1]?0:itemGap)>=zrHeight-lastY){"right"===this.legendOption.x?lastX-=this._itemGroupLocation.maxWidth+itemGap:lastX+=this._itemGroupLocation.maxWidth+itemGap;lastY=this._itemGroupLocation.y}itemShape=this._getItemShapeByType(lastX,lastY,itemWidth,itemHeight,this._selectedMap[itemName]&&this._hasDataMap[itemName]?color:"#ccc",itemType,color);itemShape._name=itemName;itemShape=new IconShape(itemShape);textShape={zlevel:this.getZlevelBase(),z:this.getZBase(),style:{x:lastX+itemWidth+5,y:lastY+itemHeight/2,color:this._selectedMap[itemName]?"auto"===dataTextStyle.color?color:dataTextStyle.color:"#ccc",text:formattedName,textFont:dataFont,textBaseline:"middle"},highlightStyle:{color:color,brushType:"fill"},hoverable:!!this.legendOption.selectedMode,clickable:!!this.legendOption.selectedMode};if("vertical"===this.legendOption.orient&&"right"===this.legendOption.x){textShape.style.x-=itemWidth+10;textShape.style.textAlign="right"}textShape._name=itemName;textShape=new TextShape(textShape);if(this.legendOption.selectedMode){itemShape.onclick=textShape.onclick=this._legendSelected;itemShape.onmouseover=textShape.onmouseover=this._dispatchHoverLink;itemShape.hoverConnect=textShape.id;textShape.hoverConnect=itemShape.id}this.shapeList.push(itemShape);this.shapeList.push(textShape);"horizontal"===this.legendOption.orient?lastX+=itemWidth+5+zrArea.getTextWidth(formattedName,dataFont)+itemGap:lastY+=itemHeight+itemGap}else if("horizontal"===this.legendOption.orient){lastX=this._itemGroupLocation.x;lastY+=itemHeight+itemGap}else{"right"===this.legendOption.x?lastX-=this._itemGroupLocation.maxWidth+itemGap:lastX+=this._itemGroupLocation.maxWidth+itemGap;lastY=this._itemGroupLocation.y}}"horizontal"===this.legendOption.orient&&"center"===this.legendOption.x&&lastY!=this._itemGroupLocation.y&&this._mLineOptimize()},_getName:function(data){return"undefined"!=typeof data.name?data.name:data},_getFormatterName:function(itemName){var formattedName,formatter=this.legendOption.formatter;formattedName="function"==typeof formatter?formatter.call(this.myChart,itemName):"string"==typeof formatter?formatter.replace("{name}",itemName):itemName;return formattedName},_getFormatterNameFromData:function(data){var itemName=this._getName(data);return this._getFormatterName(itemName)},_mLineOptimize:function(){for(var lineOffsetArray=[],lastX=this._itemGroupLocation.x,i=2,l=this.shapeList.length;l>i;i++)this.shapeList[i].style.x===lastX?lineOffsetArray.push((this._itemGroupLocation.width-(this.shapeList[i-1].style.x+zrArea.getTextWidth(this.shapeList[i-1].style.text,this.shapeList[i-1].style.textFont)-lastX))/2):i===l-1&&lineOffsetArray.push((this._itemGroupLocation.width-(this.shapeList[i].style.x+zrArea.getTextWidth(this.shapeList[i].style.text,this.shapeList[i].style.textFont)-lastX))/2);for(var curLineIndex=-1,i=1,l=this.shapeList.length;l>i;i++){this.shapeList[i].style.x===lastX&&curLineIndex++;0!==lineOffsetArray[curLineIndex]&&(this.shapeList[i].style.x+=lineOffsetArray[curLineIndex])}},_buildBackground:function(){var padding=this.reformCssArray(this.legendOption.padding);this.shapeList.push(new RectangleShape({zlevel:this.getZlevelBase(),z:this.getZBase(),hoverable:!1,style:{x:this._itemGroupLocation.x-padding[3],y:this._itemGroupLocation.y-padding[0],width:this._itemGroupLocation.width+padding[3]+padding[1],height:this._itemGroupLocation.height+padding[0]+padding[2],brushType:0===this.legendOption.borderWidth?"fill":"both",color:this.legendOption.backgroundColor,strokeColor:this.legendOption.borderColor,lineWidth:this.legendOption.borderWidth}}))},_getItemGroupLocation:function(){var data=this.legendOption.data,dataLength=data.length,itemGap=this.legendOption.itemGap,itemWidth=this.legendOption.itemWidth+5,itemHeight=this.legendOption.itemHeight,textStyle=this.legendOption.textStyle,font=this.getFont(textStyle),totalWidth=0,totalHeight=0,padding=this.reformCssArray(this.legendOption.padding),zrWidth=this.zr.getWidth()-padding[1]-padding[3],zrHeight=this.zr.getHeight()-padding[0]-padding[2],temp=0,maxWidth=0;if("horizontal"===this.legendOption.orient){totalHeight=itemHeight;for(var i=0;dataLength>i;i++)if(""!==this._getName(data[i])){var tempTextWidth=zrArea.getTextWidth(this._getFormatterNameFromData(data[i]),data[i].textStyle?this.getFont(zrUtil.merge(data[i].textStyle||{},textStyle)):font);if(temp+itemWidth+tempTextWidth+itemGap>zrWidth){temp-=itemGap;totalWidth=Math.max(totalWidth,temp);totalHeight+=itemHeight+itemGap;temp=0}else{temp+=itemWidth+tempTextWidth+itemGap;totalWidth=Math.max(totalWidth,temp-itemGap)}}else{temp-=itemGap;totalWidth=Math.max(totalWidth,temp);totalHeight+=itemHeight+itemGap;temp=0}}else{for(var i=0;dataLength>i;i++)maxWidth=Math.max(maxWidth,zrArea.getTextWidth(this._getFormatterNameFromData(data[i]),data[i].textStyle?this.getFont(zrUtil.merge(data[i].textStyle||{},textStyle)):font));maxWidth+=itemWidth;totalWidth=maxWidth;for(var i=0;dataLength>i;i++)if(""!==this._getName(data[i]))if(temp+itemHeight+itemGap>zrHeight){totalWidth+=maxWidth+itemGap;temp-=itemGap;totalHeight=Math.max(totalHeight,temp);temp=0}else{temp+=itemHeight+itemGap;totalHeight=Math.max(totalHeight,temp-itemGap)}else{totalWidth+=maxWidth+itemGap;temp-=itemGap;totalHeight=Math.max(totalHeight,temp);temp=0}}zrWidth=this.zr.getWidth();zrHeight=this.zr.getHeight();var x;switch(this.legendOption.x){case"center":x=Math.floor((zrWidth-totalWidth)/2);break;case"left":x=padding[3]+this.legendOption.borderWidth;break;case"right":x=zrWidth-totalWidth-padding[1]-padding[3]-2*this.legendOption.borderWidth;break;default:x=this.parsePercent(this.legendOption.x,zrWidth)}var y;switch(this.legendOption.y){case"top":y=padding[0]+this.legendOption.borderWidth;break;case"bottom":y=zrHeight-totalHeight-padding[0]-padding[2]-2*this.legendOption.borderWidth;break;case"center":y=Math.floor((zrHeight-totalHeight)/2);break;default:y=this.parsePercent(this.legendOption.y,zrHeight)}return{x:x,y:y,width:totalWidth,height:totalHeight,maxWidth:maxWidth}},_getSomethingByName:function(name){for(var data,series=this.option.series,i=0,l=series.length;l>i;i++){if(series[i].name===name)return{type:series[i].type,series:series[i],seriesIndex:i,data:null,dataIndex:-1};if(series[i].type===ecConfig.CHART_TYPE_PIE||series[i].type===ecConfig.CHART_TYPE_RADAR||series[i].type===ecConfig.CHART_TYPE_CHORD||series[i].type===ecConfig.CHART_TYPE_FORCE||series[i].type===ecConfig.CHART_TYPE_FUNNEL||series[i].type===ecConfig.CHART_TYPE_TREEMAP){data=series[i].categories||series[i].data||series[i].nodes;for(var j=0,k=data.length;k>j;j++)if(data[j].name===name)return{type:series[i].type,series:series[i],seriesIndex:i,data:data[j],dataIndex:j}}}return{type:"bar",series:null,seriesIndex:-1,data:null,dataIndex:-1}},_getItemShapeByType:function(x,y,width,height,color,itemType,defaultColor){var imageLocation,highlightColor="#ccc"===color?defaultColor:color,itemShape={zlevel:this.getZlevelBase(),z:this.getZBase(),style:{iconType:"legendicon"+itemType,x:x,y:y,width:width,height:height,color:color,strokeColor:color,lineWidth:2},highlightStyle:{color:highlightColor,strokeColor:highlightColor,lineWidth:1},hoverable:this.legendOption.selectedMode,clickable:this.legendOption.selectedMode};if(itemType.match("image")){var imageLocation=itemType.replace(new RegExp("^image:\\/\\/"),"");itemType="image"}switch(itemType){case"line":itemShape.style.brushType="stroke";itemShape.highlightStyle.lineWidth=3;break;case"radar":case"venn":case"tree":case"treemap":case"scatter":itemShape.highlightStyle.lineWidth=3;break;case"k":itemShape.style.brushType="both";itemShape.highlightStyle.lineWidth=3;itemShape.highlightStyle.color=itemShape.style.color=this.deepQuery([this.ecTheme,ecConfig],"k.itemStyle.normal.color")||"#fff";itemShape.style.strokeColor="#ccc"!=color?this.deepQuery([this.ecTheme,ecConfig],"k.itemStyle.normal.lineStyle.color")||"#ff3200":color;break;case"image":itemShape.style.iconType="image";itemShape.style.image=imageLocation;"#ccc"===color&&(itemShape.style.opacity=.5)}return itemShape},__legendSelected:function(param){var itemName=param.target._name;if("single"===this.legendOption.selectedMode)for(var k in this._selectedMap)this._selectedMap[k]=!1;this._selectedMap[itemName]=!this._selectedMap[itemName];this.messageCenter.dispatch(ecConfig.EVENT.LEGEND_SELECTED,param.event,{selected:this._selectedMap,target:itemName},this.myChart)},__dispatchHoverLink:function(param){this.messageCenter.dispatch(ecConfig.EVENT.LEGEND_HOVERLINK,param.event,{target:param.target._name},this.myChart)},refresh:function(newOption){if(newOption){this.option=newOption||this.option;this.option.legend=this.reformOption(this.option.legend);this.legendOption=this.option.legend;var itemName,something,color,queryTarget,data=this.legendOption.data||[];if(this.legendOption.selected)for(var k in this.legendOption.selected)this._selectedMap[k]="undefined"!=typeof this._selectedMap[k]?this._selectedMap[k]:this.legendOption.selected[k];for(var i=0,dataLength=data.length;dataLength>i;i++){itemName=this._getName(data[i]);if(""!==itemName){something=this._getSomethingByName(itemName);if(something.series){this._hasDataMap[itemName]=!0;queryTarget=!something.data||something.type!==ecConfig.CHART_TYPE_PIE&&something.type!==ecConfig.CHART_TYPE_FORCE&&something.type!==ecConfig.CHART_TYPE_FUNNEL?[something.series]:[something.data,something.series];color=this.getItemStyleColor(this.deepQuery(queryTarget,"itemStyle.normal.color"),something.seriesIndex,something.dataIndex,something.data);color&&something.type!=ecConfig.CHART_TYPE_K&&this.setColor(itemName,color);this._selectedMap[itemName]=null!=this._selectedMap[itemName]?this._selectedMap[itemName]:!0}else this._hasDataMap[itemName]=!1}}}this.clear();this._buildShape()},getRelatedAmount:function(name){for(var data,amount=0,series=this.option.series,i=0,l=series.length;l>i;i++){series[i].name===name&&amount++;if(series[i].type===ecConfig.CHART_TYPE_PIE||series[i].type===ecConfig.CHART_TYPE_RADAR||series[i].type===ecConfig.CHART_TYPE_CHORD||series[i].type===ecConfig.CHART_TYPE_FORCE||series[i].type===ecConfig.CHART_TYPE_FUNNEL){data=series[i].type!=ecConfig.CHART_TYPE_FORCE?series[i].data:series[i].categories;for(var j=0,k=data.length;k>j;j++)data[j].name===name&&"-"!=data[j].value&&amount++}}return amount},setColor:function(legendName,color){this._colorMap[legendName]=color},getColor:function(legendName){this._colorMap[legendName]||(this._colorMap[legendName]=this.zr.getColor(this._colorIndex++));return this._colorMap[legendName]},hasColor:function(legendName){return this._colorMap[legendName]?this._colorMap[legendName]:!1},add:function(name,color){for(var data=this.legendOption.data,i=0,dataLength=data.length;dataLength>i;i++)if(this._getName(data[i])===name)return;this.legendOption.data.push(name);this.setColor(name,color);this._selectedMap[name]=!0;this._hasDataMap[name]=!0},del:function(name){for(var data=this.legendOption.data,i=0,dataLength=data.length;dataLength>i;i++)if(this._getName(data[i])===name)return this.legendOption.data.splice(i,1)},getItemShape:function(name){if(null!=name)for(var shape,i=0,l=this.shapeList.length;l>i;i++){shape=this.shapeList[i];if(shape._name===name&&"text"!=shape.type)return shape}},setItemShape:function(name,itemShape){for(var shape,i=0,l=this.shapeList.length;l>i;i++){shape=this.shapeList[i];if(shape._name===name&&"text"!=shape.type){if(!this._selectedMap[name]){itemShape.style.color="#ccc";itemShape.style.strokeColor="#ccc"}this.zr.modShape(shape.id,itemShape)}}},isSelected:function(itemName){return"undefined"!=typeof this._selectedMap[itemName]?this._selectedMap[itemName]:!0},getSelectedMap:function(){return this._selectedMap},setSelected:function(itemName,selectStatus){if("single"===this.legendOption.selectedMode)for(var k in this._selectedMap)this._selectedMap[k]=!1;this._selectedMap[itemName]=selectStatus;this.messageCenter.dispatch(ecConfig.EVENT.LEGEND_SELECTED,null,{selected:this._selectedMap,target:itemName},this.myChart)},onlegendSelected:function(param,status){var legendSelected=param.selected;for(var itemName in legendSelected){this._selectedMap[itemName]!=legendSelected[itemName]&&(status.needRefresh=!0);this._selectedMap[itemName]=legendSelected[itemName]}}};var legendIcon={line:function(ctx,style){var dy=style.height/2;ctx.moveTo(style.x,style.y+dy);ctx.lineTo(style.x+style.width,style.y+dy)},pie:function(ctx,style){var x=style.x,y=style.y,width=style.width,height=style.height;SectorShape.prototype.buildPath(ctx,{x:x+width/2,y:y+height+2,r:height,r0:6,startAngle:45,endAngle:135})},eventRiver:function(ctx,style){var x=style.x,y=style.y,width=style.width,height=style.height;ctx.moveTo(x,y+height);ctx.bezierCurveTo(x+width,y+height,x,y+4,x+width,y+4);ctx.lineTo(x+width,y);ctx.bezierCurveTo(x,y,x+width,y+height-4,x,y+height-4);ctx.lineTo(x,y+height)},k:function(ctx,style){var x=style.x,y=style.y,width=style.width,height=style.height;CandleShape.prototype.buildPath(ctx,{x:x+width/2,y:[y+1,y+1,y+height-6,y+height],width:width-6})},bar:function(ctx,style){var x=style.x,y=style.y+1,width=style.width,height=style.height-2,r=3;ctx.moveTo(x+r,y);ctx.lineTo(x+width-r,y);ctx.quadraticCurveTo(x+width,y,x+width,y+r);ctx.lineTo(x+width,y+height-r);ctx.quadraticCurveTo(x+width,y+height,x+width-r,y+height);ctx.lineTo(x+r,y+height);ctx.quadraticCurveTo(x,y+height,x,y+height-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y)},force:function(ctx,style){IconShape.prototype.iconLibrary.circle(ctx,style)},radar:function(ctx,style){var n=6,x=style.x+style.width/2,y=style.y+style.height/2,r=style.height/2,dStep=2*Math.PI/n,deg=-Math.PI/2,xStart=x+r*Math.cos(deg),yStart=y+r*Math.sin(deg);ctx.moveTo(xStart,yStart);deg+=dStep;for(var i=0,end=n-1;end>i;i++){ctx.lineTo(x+r*Math.cos(deg),y+r*Math.sin(deg));deg+=dStep}ctx.lineTo(xStart,yStart)}};legendIcon.chord=legendIcon.pie;legendIcon.map=legendIcon.bar;for(var k in legendIcon)IconShape.prototype.iconLibrary["legendicon"+k]=legendIcon[k];zrUtil.inherits(Legend,Base);require("../component").define("legend",Legend);return Legend});