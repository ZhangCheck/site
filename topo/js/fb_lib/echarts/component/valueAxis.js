define(["require","./base","zrender/shape/Text","zrender/shape/Line","zrender/shape/Rectangle","../config","../util/date","zrender/tool/util","../util/smartSteps","../util/accMath","../util/smartLogSteps","../component"],function(require){function ValueAxis(ecTheme,messageCenter,zr,option,myChart,axisBase,series){if(series&&0!==series.length){Base.call(this,ecTheme,messageCenter,zr,option,myChart);this.series=series;this.grid=this.component.grid;for(var method in axisBase)this[method]=axisBase[method];this.refresh(option,series)}else console.err("option.series.length == 0.")}var Base=require("./base"),TextShape=require("zrender/shape/Text"),LineShape=require("zrender/shape/Line"),RectangleShape=require("zrender/shape/Rectangle"),ecConfig=require("../config");ecConfig.valueAxis={zlevel:0,z:0,show:!0,position:"left",name:"",nameLocation:"end",nameTextStyle:{},boundaryGap:[0,0],axisLine:{show:!0,onZero:!0,lineStyle:{color:"#48b",width:2,type:"solid"}},axisTick:{show:!1,inside:!1,length:5,lineStyle:{color:"#333",width:1}},axisLabel:{show:!0,rotate:0,margin:8,textStyle:{color:"#333"}},splitLine:{show:!0,lineStyle:{color:["#ccc"],width:1,type:"solid"}},splitArea:{show:!1,areaStyle:{color:["rgba(250,250,250,0.3)","rgba(200,200,200,0.3)"]}}};var ecDate=require("../util/date"),zrUtil=require("zrender/tool/util");ValueAxis.prototype={type:ecConfig.COMPONENT_TYPE_AXIS_VALUE,_buildShape:function(){this._hasData=!1;this._calculateValue();if(this._hasData&&this.option.show){this.option.splitArea.show&&this._buildSplitArea();this.option.splitLine.show&&this._buildSplitLine();this.option.axisLine.show&&this._buildAxisLine();this.option.axisTick.show&&this._buildAxisTick();this.option.axisLabel.show&&this._buildAxisLabel();for(var i=0,l=this.shapeList.length;l>i;i++)this.zr.addShape(this.shapeList[i])}},_buildAxisTick:function(){var axShape,data=this._valueList,dataLength=this._valueList.length,tickOption=this.option.axisTick,length=tickOption.length,color=tickOption.lineStyle.color,lineWidth=tickOption.lineStyle.width;if(this.isHorizontal())for(var x,yPosition="bottom"===this.option.position?tickOption.inside?this.grid.getYend()-length-1:this.grid.getYend()+1:tickOption.inside?this.grid.getY()+1:this.grid.getY()-length-1,i=0;dataLength>i;i++){x=this.subPixelOptimize(this.getCoord(data[i]),lineWidth);axShape={_axisShape:"axisTick",zlevel:this.getZlevelBase(),z:this.getZBase(),hoverable:!1,style:{xStart:x,yStart:yPosition,xEnd:x,yEnd:yPosition+length,strokeColor:color,lineWidth:lineWidth}};this.shapeList.push(new LineShape(axShape))}else for(var y,xPosition="left"===this.option.position?tickOption.inside?this.grid.getX()+1:this.grid.getX()-length-1:tickOption.inside?this.grid.getXend()-length-1:this.grid.getXend()+1,i=0;dataLength>i;i++){y=this.subPixelOptimize(this.getCoord(data[i]),lineWidth);axShape={_axisShape:"axisTick",zlevel:this.getZlevelBase(),z:this.getZBase(),hoverable:!1,style:{xStart:xPosition,yStart:y,xEnd:xPosition+length,yEnd:y,strokeColor:color,lineWidth:lineWidth}};this.shapeList.push(new LineShape(axShape))}},_buildAxisLabel:function(){var axShape,data=this._valueList,dataLength=this._valueList.length,rotate=this.option.axisLabel.rotate,margin=this.option.axisLabel.margin,clickable=this.option.axisLabel.clickable,textStyle=this.option.axisLabel.textStyle;if(this.isHorizontal()){var yPosition,baseLine;if("bottom"===this.option.position){yPosition=this.grid.getYend()+margin;baseLine="top"}else{yPosition=this.grid.getY()-margin;baseLine="bottom"}for(var i=0;dataLength>i;i++){axShape={zlevel:this.getZlevelBase(),z:this.getZBase()+3,hoverable:!1,style:{x:this.getCoord(data[i]),y:yPosition,color:"function"==typeof textStyle.color?textStyle.color(data[i]):textStyle.color,text:this._valueLabel[i],textFont:this.getFont(textStyle),textAlign:textStyle.align||"center",textBaseline:textStyle.baseline||baseLine}};if(rotate){axShape.style.textAlign=rotate>0?"bottom"===this.option.position?"right":"left":"bottom"===this.option.position?"left":"right";axShape.rotation=[rotate*Math.PI/180,axShape.style.x,axShape.style.y]}this.shapeList.push(new TextShape(this._axisLabelClickable(clickable,axShape)))}}else{var xPosition,align;if("left"===this.option.position){xPosition=this.grid.getX()-margin;align="right"}else{xPosition=this.grid.getXend()+margin;align="left"}for(var i=0;dataLength>i;i++){axShape={zlevel:this.getZlevelBase(),z:this.getZBase()+3,hoverable:!1,style:{x:xPosition,y:this.getCoord(data[i]),color:"function"==typeof textStyle.color?textStyle.color(data[i]):textStyle.color,text:this._valueLabel[i],textFont:this.getFont(textStyle),textAlign:textStyle.align||align,textBaseline:textStyle.baseline||(0===i&&""!==this.option.name?"bottom":i===dataLength-1&&""!==this.option.name?"top":"middle")}};rotate&&(axShape.rotation=[rotate*Math.PI/180,axShape.style.x,axShape.style.y]);this.shapeList.push(new TextShape(this._axisLabelClickable(clickable,axShape)))}}},_buildSplitLine:function(){var axShape,data=this._valueList,dataLength=this._valueList.length,sLineOption=this.option.splitLine,lineType=sLineOption.lineStyle.type,lineWidth=sLineOption.lineStyle.width,color=sLineOption.lineStyle.color;color=color instanceof Array?color:[color];var colorLength=color.length;if(this.isHorizontal())for(var x,sy=this.grid.getY(),ey=this.grid.getYend(),i=0;dataLength>i;i++){x=this.subPixelOptimize(this.getCoord(data[i]),lineWidth);axShape={zlevel:this.getZlevelBase(),z:this.getZBase(),hoverable:!1,style:{xStart:x,yStart:sy,xEnd:x,yEnd:ey,strokeColor:color[i%colorLength],lineType:lineType,lineWidth:lineWidth}};this.shapeList.push(new LineShape(axShape))}else for(var y,sx=this.grid.getX(),ex=this.grid.getXend(),i=0;dataLength>i;i++){y=this.subPixelOptimize(this.getCoord(data[i]),lineWidth);axShape={zlevel:this.getZlevelBase(),z:this.getZBase(),hoverable:!1,style:{xStart:sx,yStart:y,xEnd:ex,yEnd:y,strokeColor:color[i%colorLength],lineType:lineType,lineWidth:lineWidth}};this.shapeList.push(new LineShape(axShape))}},_buildSplitArea:function(){var axShape,color=this.option.splitArea.areaStyle.color;if(color instanceof Array){var colorLength=color.length,data=this._valueList,dataLength=this._valueList.length;if(this.isHorizontal())for(var curX,y=this.grid.getY(),height=this.grid.getHeight(),lastX=this.grid.getX(),i=0;dataLength>=i;i++){curX=dataLength>i?this.getCoord(data[i]):this.grid.getXend();axShape={zlevel:this.getZlevelBase(),z:this.getZBase(),hoverable:!1,style:{x:lastX,y:y,width:curX-lastX,height:height,color:color[i%colorLength]}};this.shapeList.push(new RectangleShape(axShape));lastX=curX}else for(var curY,x=this.grid.getX(),width=this.grid.getWidth(),lastYend=this.grid.getYend(),i=0;dataLength>=i;i++){curY=dataLength>i?this.getCoord(data[i]):this.grid.getY();axShape={zlevel:this.getZlevelBase(),z:this.getZBase(),hoverable:!1,style:{x:x,y:curY,width:width,height:lastYend-curY,color:color[i%colorLength]}};this.shapeList.push(new RectangleShape(axShape));lastYend=curY}}else{axShape={zlevel:this.getZlevelBase(),z:this.getZBase(),hoverable:!1,style:{x:this.grid.getX(),y:this.grid.getY(),width:this.grid.getWidth(),height:this.grid.getHeight(),color:color}};this.shapeList.push(new RectangleShape(axShape))}},_calculateValue:function(){if(isNaN(this.option.min-0)||isNaN(this.option.max-0)){for(var xIdx,yIdx,data={},legend=this.component.legend,i=0,l=this.series.length;l>i;i++)if((this.series[i].type==ecConfig.CHART_TYPE_LINE||this.series[i].type==ecConfig.CHART_TYPE_BAR||this.series[i].type==ecConfig.CHART_TYPE_SCATTER||this.series[i].type==ecConfig.CHART_TYPE_K||this.series[i].type==ecConfig.CHART_TYPE_EVENTRIVER)&&(!legend||legend.isSelected(this.series[i].name))){xIdx=this.series[i].xAxisIndex||0;yIdx=this.series[i].yAxisIndex||0;(this.option.xAxisIndex==xIdx||this.option.yAxisIndex==yIdx)&&this._calculSum(data,i)}var oriData;for(var i in data){oriData=data[i];for(var j=0,k=oriData.length;k>j;j++)if(!isNaN(oriData[j])){this._hasData=!0;this._min=oriData[j];this._max=oriData[j];break}if(this._hasData)break}for(var i in data){oriData=data[i];for(var j=0,k=oriData.length;k>j;j++)if(!isNaN(oriData[j])){this._min=Math.min(this._min,oriData[j]);this._max=Math.max(this._max,oriData[j])}}var boundaryGap="log"!==this.option.type?this.option.boundaryGap:[0,0],gap=Math.abs(this._max-this._min);this._min=isNaN(this.option.min-0)?this._min-Math.abs(gap*boundaryGap[0]):this.option.min-0;this._max=isNaN(this.option.max-0)?this._max+Math.abs(gap*boundaryGap[1]):this.option.max-0;this._min===this._max&&(0===this._max?this._max=1:this._max>0?this._min=this._max/this.option.splitNumber!=null?this.option.splitNumber:5:this._max=this._max/this.option.splitNumber!=null?this.option.splitNumber:5);"time"===this.option.type?this._reformTimeValue():"log"===this.option.type?this._reformLogValue():this._reformValue(this.option.scale)}else{this._hasData=!0;this._min=this.option.min-0;this._max=this.option.max-0;"time"===this.option.type?this._reformTimeValue():"log"===this.option.type?this._reformLogValue():this._customerValue()}},_calculSum:function(data,i){var value,oriData,key=this.series[i].name||"kener";if(this.series[i].stack){var keyP="__Magic_Key_Positive__"+this.series[i].stack,keyN="__Magic_Key_Negative__"+this.series[i].stack;data[keyP]=data[keyP]||[];data[keyN]=data[keyN]||[];data[key]=data[key]||[];oriData=this.series[i].data;for(var j=0,k=oriData.length;k>j;j++){value=this.getDataFromOption(oriData[j]);if("-"!==value){value-=0;value>=0?null!=data[keyP][j]?data[keyP][j]+=value:data[keyP][j]=value:null!=data[keyN][j]?data[keyN][j]+=value:data[keyN][j]=value;this.option.scale&&data[key].push(value)}}}else{data[key]=data[key]||[];if(this.series[i].type!=ecConfig.CHART_TYPE_EVENTRIVER){oriData=this.series[i].data;for(var j=0,k=oriData.length;k>j;j++){value=this.getDataFromOption(oriData[j]);if(this.series[i].type===ecConfig.CHART_TYPE_K){data[key].push(value[0]);data[key].push(value[1]);data[key].push(value[2]);data[key].push(value[3])}else if(value instanceof Array){-1!=this.option.xAxisIndex&&data[key].push("time"!=this.option.type?value[0]:ecDate.getNewDate(value[0]));-1!=this.option.yAxisIndex&&data[key].push("time"!=this.option.type?value[1]:ecDate.getNewDate(value[1]))}else data[key].push(value)}}else{oriData=this.series[i].data;for(var j=0,k=oriData.length;k>j;j++)for(var evolution=oriData[j].evolution,m=0,n=evolution.length;n>m;m++)data[key].push(ecDate.getNewDate(evolution[m].time))}}},_reformValue:function(scale){var smartSteps=require("../util/smartSteps"),splitNumber=this.option.splitNumber;!scale&&this._min>=0&&this._max>=0&&(this._min=0);!scale&&this._min<=0&&this._max<=0&&(this._max=0);var stepOpt=smartSteps(this._min,this._max,splitNumber);splitNumber=null!=splitNumber?splitNumber:stepOpt.secs;this._min=stepOpt.min;this._max=stepOpt.max;this._valueList=stepOpt.pnts;this._reformLabelData()},_reformTimeValue:function(){var splitNumber=null!=this.option.splitNumber?this.option.splitNumber:5,curValue=ecDate.getAutoFormatter(this._min,this._max,splitNumber),formatter=curValue.formatter,gapValue=curValue.gapValue;this._valueList=[ecDate.getNewDate(this._min)];var startGap;switch(formatter){case"week":startGap=ecDate.nextMonday(this._min);break;case"month":startGap=ecDate.nextNthOnMonth(this._min,1);break;case"quarter":startGap=ecDate.nextNthOnQuarterYear(this._min,1);break;case"half-year":startGap=ecDate.nextNthOnHalfYear(this._min,1);break;case"year":startGap=ecDate.nextNthOnYear(this._min,1);break;default:if(72e5>=gapValue)startGap=(Math.floor(this._min/gapValue)+1)*gapValue;else{startGap=ecDate.getNewDate(this._min- -gapValue);startGap.setHours(6*Math.round(startGap.getHours()/6));startGap.setMinutes(0);startGap.setSeconds(0)}}startGap-this._min<gapValue/2&&(startGap-=-gapValue);curValue=ecDate.getNewDate(startGap);splitNumber*=1.5;for(;splitNumber-- >=0;){("month"==formatter||"quarter"==formatter||"half-year"==formatter||"year"==formatter)&&curValue.setDate(1);if(this._max-curValue<gapValue/2)break;this._valueList.push(curValue);curValue=ecDate.getNewDate(curValue- -gapValue)}this._valueList.push(ecDate.getNewDate(this._max));this._reformLabelData(function(formatterStr){return function(value){return ecDate.format(formatterStr,value)}}(formatter))},_customerValue:function(){var accMath=require("../util/accMath"),splitNumber=null!=this.option.splitNumber?this.option.splitNumber:5,splitGap=(this._max-this._min)/splitNumber;this._valueList=[];for(var i=0;splitNumber>=i;i++)this._valueList.push(accMath.accAdd(this._min,accMath.accMul(splitGap,i)));this._reformLabelData()},_reformLogValue:function(){var thisOption=this.option,result=require("../util/smartLogSteps")({dataMin:this._min,dataMax:this._max,logPositive:thisOption.logPositive,logLabelBase:thisOption.logLabelBase,splitNumber:thisOption.splitNumber});this._min=result.dataMin;this._max=result.dataMax;this._valueList=result.tickList;this._dataMappingMethods=result.dataMappingMethods;this._reformLabelData(result.labelFormatter)},_reformLabelData:function(innerFormatter){this._valueLabel=[];var formatter=this.option.axisLabel.formatter;if(formatter)for(var i=0,l=this._valueList.length;l>i;i++)"function"==typeof formatter?this._valueLabel.push(innerFormatter?formatter.call(this.myChart,this._valueList[i],innerFormatter):formatter.call(this.myChart,this._valueList[i])):"string"==typeof formatter&&this._valueLabel.push(innerFormatter?ecDate.format(formatter,this._valueList[i]):formatter.replace("{value}",this._valueList[i]));else for(var i=0,l=this._valueList.length;l>i;i++)this._valueLabel.push(innerFormatter?innerFormatter(this._valueList[i]):this.numAddCommas(this._valueList[i]))},getExtremum:function(){this._calculateValue();var dataMappingMethods=this._dataMappingMethods;return{min:this._min,max:this._max,dataMappingMethods:dataMappingMethods?zrUtil.merge({},dataMappingMethods):null}},refresh:function(newOption,newSeries){if(newOption){this.option=this.reformOption(newOption);this.option.axisLabel.textStyle=zrUtil.merge(this.option.axisLabel.textStyle||{},this.ecTheme.textStyle);this.series=newSeries}if(this.zr){this.clear();this._buildShape()}},getCoord:function(value){this._dataMappingMethods&&(value=this._dataMappingMethods.value2Coord(value));value=value<this._min?this._min:value;value=value>this._max?this._max:value;var result;result=this.isHorizontal()?this.grid.getX()+(value-this._min)/(this._max-this._min)*this.grid.getWidth():this.grid.getYend()-(value-this._min)/(this._max-this._min)*this.grid.getHeight();return result},getCoordSize:function(value){return this.isHorizontal()?Math.abs(value/(this._max-this._min)*this.grid.getWidth()):Math.abs(value/(this._max-this._min)*this.grid.getHeight())},getValueFromCoord:function(coord){var result;if(this.isHorizontal()){coord=coord<this.grid.getX()?this.grid.getX():coord;coord=coord>this.grid.getXend()?this.grid.getXend():coord;result=this._min+(coord-this.grid.getX())/this.grid.getWidth()*(this._max-this._min)}else{coord=coord<this.grid.getY()?this.grid.getY():coord;coord=coord>this.grid.getYend()?this.grid.getYend():coord;result=this._max-(coord-this.grid.getY())/this.grid.getHeight()*(this._max-this._min)}this._dataMappingMethods&&(result=this._dataMappingMethods.coord2Value(result));return result.toFixed(2)-0},isMaindAxis:function(value){for(var i=0,l=this._valueList.length;l>i;i++)if(this._valueList[i]===value)return!0;return!1}};zrUtil.inherits(ValueAxis,Base);require("../component").define("valueAxis",ValueAxis);return ValueAxis});