define(["require","./base","zrender/shape/Text","zrender/shape/Line","zrender/shape/Polygon","zrender/shape/Circle","zrender/shape/Ring","../config","zrender/tool/util","../util/coordinates","../util/accMath","../util/smartSteps","../component"],function(require){function Polar(ecTheme,messageCenter,zr,option,myChart){Base.call(this,ecTheme,messageCenter,zr,option,myChart);this.refresh(option)}var Base=require("./base"),TextShape=require("zrender/shape/Text"),LineShape=require("zrender/shape/Line"),PolygonShape=require("zrender/shape/Polygon"),Circle=require("zrender/shape/Circle"),Ring=require("zrender/shape/Ring"),ecConfig=require("../config");ecConfig.polar={zlevel:0,z:0,center:["50%","50%"],radius:"75%",startAngle:90,boundaryGap:[0,0],splitNumber:5,name:{show:!0,textStyle:{color:"#333"}},axisLine:{show:!0,lineStyle:{color:"#ccc",width:1,type:"solid"}},axisLabel:{show:!1,textStyle:{color:"#333"}},splitArea:{show:!0,areaStyle:{color:["rgba(250,250,250,0.3)","rgba(200,200,200,0.3)"]}},splitLine:{show:!0,lineStyle:{width:1,color:"#ccc"}},type:"polygon"};var zrUtil=require("zrender/tool/util"),ecCoordinates=require("../util/coordinates");Polar.prototype={type:ecConfig.COMPONENT_TYPE_POLAR,_buildShape:function(){for(var i=0;i<this.polar.length;i++){this._index=i;this.reformOption(this.polar[i]);this._queryTarget=[this.polar[i],this.option];this._createVector(i);this._buildSpiderWeb(i);this._buildText(i);this._adjustIndicatorValue(i);this._addAxisLabel(i)}for(var i=0;i<this.shapeList.length;i++)this.zr.addShape(this.shapeList[i])},_createVector:function(index){for(var vector,item=this.polar[index],indicator=this.deepQuery(this._queryTarget,"indicator"),length=indicator.length,startAngle=item.startAngle,dStep=2*Math.PI/length,radius=this._getRadius(),__ecIndicator=item.__ecIndicator=[],i=0;length>i;i++){vector=ecCoordinates.polar2cartesian(radius,startAngle*Math.PI/180+dStep*i);__ecIndicator.push({vector:[vector[1],-vector[0]]})}},_getRadius:function(){var item=this.polar[this._index];return this.parsePercent(item.radius,Math.min(this.zr.getWidth(),this.zr.getHeight())/2)},_buildSpiderWeb:function(index){var item=this.polar[index],__ecIndicator=item.__ecIndicator,splitArea=item.splitArea,splitLine=item.splitLine,center=this.getCenter(index),splitNumber=item.splitNumber,strokeColor=splitLine.lineStyle.color,lineWidth=splitLine.lineStyle.width,show=splitLine.show,axisLine=this.deepQuery(this._queryTarget,"axisLine");this._addArea(__ecIndicator,splitNumber,center,splitArea,strokeColor,lineWidth,show);axisLine.show&&this._addLine(__ecIndicator,center,axisLine)},_addAxisLabel:function(index){for(var axisLabel,vector,style,newStyle,vector,value,text,theta,offset,interval,accMath=require("../util/accMath"),item=this.polar[index],indicator=this.deepQuery(this._queryTarget,"indicator"),__ecIndicator=item.__ecIndicator,splitNumber=this.deepQuery(this._queryTarget,"splitNumber"),center=this.getCenter(index),i=0;i<indicator.length;i++){axisLabel=this.deepQuery([indicator[i],item,this.option],"axisLabel");if(axisLabel.show){var textStyle=this.deepQuery([axisLabel,item,this.option],"textStyle"),formatter=this.deepQuery([axisLabel,item],"formatter");style={};style.textFont=this.getFont(textStyle);style.color=textStyle.color;style=zrUtil.merge(style,axisLabel);style.lineWidth=style.width;vector=__ecIndicator[i].vector;value=__ecIndicator[i].value;theta=i/indicator.length*2*Math.PI;offset=axisLabel.offset||10;interval=axisLabel.interval||0;if(!value)return;for(var j=1;splitNumber>=j;j+=interval+1){newStyle=zrUtil.merge({},style);text=accMath.accAdd(value.min,accMath.accMul(value.step,j));text="function"==typeof formatter?formatter(text):"string"==typeof formatter?formatter.replace("{a}","{a0}").replace("{a0}",text):this.numAddCommas(text);newStyle.text=text;newStyle.x=j*vector[0]/splitNumber+Math.cos(theta)*offset+center[0];newStyle.y=j*vector[1]/splitNumber+Math.sin(theta)*offset+center[1];this.shapeList.push(new TextShape({zlevel:this.getZlevelBase(),z:this.getZBase(),style:newStyle,draggable:!1,hoverable:!1}))}}}},_buildText:function(index){for(var vector,style,textAlign,name,rotation,margin,textStyle,item=this.polar[index],__ecIndicator=item.__ecIndicator,indicator=this.deepQuery(this._queryTarget,"indicator"),center=this.getCenter(index),x=0,y=0,i=0;i<indicator.length;i++){name=this.deepQuery([indicator[i],item,this.option],"name");if(name.show){textStyle=this.deepQuery([name,item,this.option],"textStyle");style={};style.textFont=this.getFont(textStyle);style.color=textStyle.color;"function"==typeof name.formatter?style.text=name.formatter.call(this.myChart,indicator[i].text,i):"string"==typeof name.formatter?style.text=name.formatter.replace("{value}",indicator[i].text):style.text=indicator[i].text;__ecIndicator[i].text=style.text;vector=__ecIndicator[i].vector;textAlign=Math.round(vector[0])>0?"left":Math.round(vector[0])<0?"right":"center";if(null==name.margin)vector=this._mapVector(vector,center,1.1);else{margin=name.margin;x=vector[0]>0?margin:-margin;y=vector[1]>0?margin:-margin;x=0===vector[0]?0:x;y=0===vector[1]?0:y;vector=this._mapVector(vector,center,1)}style.textAlign=textAlign;style.x=vector[0]+x;style.y=vector[1]+y;rotation=name.rotate?[name.rotate/180*Math.PI,vector[0],vector[1]]:[0,0,0];this.shapeList.push(new TextShape({zlevel:this.getZlevelBase(),z:this.getZBase(),style:style,draggable:!1,hoverable:!1,rotation:rotation}))}}},getIndicatorText:function(polarIndex,indicatorIndex){return this.polar[polarIndex]&&this.polar[polarIndex].__ecIndicator[indicatorIndex]&&this.polar[polarIndex].__ecIndicator[indicatorIndex].text},getDropBox:function(index){var vector,shape,index=index||0,item=this.polar[index],center=this.getCenter(index),__ecIndicator=item.__ecIndicator,len=__ecIndicator.length,pointList=[],type=item.type;if("polygon"==type){for(var i=0;len>i;i++){vector=__ecIndicator[i].vector;pointList.push(this._mapVector(vector,center,1.2))}shape=this._getShape(pointList,"fill","rgba(0,0,0,0)","",1)}else"circle"==type&&(shape=this._getCircle("",1,1.2,center,"fill","rgba(0,0,0,0)"));return shape},_addArea:function(__ecIndicator,splitNumber,center,splitArea,strokeColor,lineWidth,show){for(var shape,scale,scale1,pointList,type=this.deepQuery(this._queryTarget,"type"),i=0;splitNumber>i;i++){scale=(splitNumber-i)/splitNumber;if(show){if("polygon"==type){pointList=this._getPointList(__ecIndicator,scale,center);shape=this._getShape(pointList,"stroke","",strokeColor,lineWidth)}else"circle"==type&&(shape=this._getCircle(strokeColor,lineWidth,scale,center,"stroke"));this.shapeList.push(shape)}if(splitArea.show){scale1=(splitNumber-i-1)/splitNumber;this._addSplitArea(__ecIndicator,splitArea,scale,scale1,center,i)}}},_getCircle:function(strokeColor,lineWidth,scale,center,brushType,color){var radius=this._getRadius();return new Circle({zlevel:this.getZlevelBase(),z:this.getZBase(),style:{x:center[0],y:center[1],r:radius*scale,brushType:brushType,strokeColor:strokeColor,lineWidth:lineWidth,color:color},hoverable:!1,draggable:!1})},_getRing:function(color,scale0,scale1,center){var radius=this._getRadius();return new Ring({zlevel:this.getZlevelBase(),z:this.getZBase(),style:{x:center[0],y:center[1],r:scale0*radius,r0:scale1*radius,color:color,brushType:"fill"},hoverable:!1,draggable:!1})},_getPointList:function(__ecIndicator,scale,center){for(var vector,pointList=[],len=__ecIndicator.length,i=0;len>i;i++){vector=__ecIndicator[i].vector;pointList.push(this._mapVector(vector,center,scale))}return pointList},_getShape:function(pointList,brushType,color,strokeColor,lineWidth){return new PolygonShape({zlevel:this.getZlevelBase(),z:this.getZBase(),style:{pointList:pointList,brushType:brushType,color:color,strokeColor:strokeColor,lineWidth:lineWidth},hoverable:!1,draggable:!1})},_addSplitArea:function(__ecIndicator,splitArea,scale,scale1,center,colorInd){var color,colorLen,vector,vector1,shape,indLen=__ecIndicator.length,colorArr=splitArea.areaStyle.color,pointList=[],indLen=__ecIndicator.length,type=this.deepQuery(this._queryTarget,"type");"string"==typeof colorArr&&(colorArr=[colorArr]);colorLen=colorArr.length;color=colorArr[colorInd%colorLen];if("polygon"==type)for(var i=0;indLen>i;i++){pointList=[];vector=__ecIndicator[i].vector;vector1=__ecIndicator[(i+1)%indLen].vector;pointList.push(this._mapVector(vector,center,scale));pointList.push(this._mapVector(vector,center,scale1));pointList.push(this._mapVector(vector1,center,scale1));pointList.push(this._mapVector(vector1,center,scale));shape=this._getShape(pointList,"fill",color,"",1);this.shapeList.push(shape)}else if("circle"==type){shape=this._getRing(color,scale,scale1,center);this.shapeList.push(shape)}},_mapVector:function(vector,center,scale){return[vector[0]*scale+center[0],vector[1]*scale+center[1]]},getCenter:function(index){var index=index||0;return this.parseCenter(this.zr,this.polar[index].center)},_addLine:function(__ecIndicator,center,axisLine){for(var line,vector,indLen=__ecIndicator.length,lineStyle=axisLine.lineStyle,strokeColor=lineStyle.color,lineWidth=lineStyle.width,lineType=lineStyle.type,i=0;indLen>i;i++){vector=__ecIndicator[i].vector;line=this._getLine(center[0],center[1],vector[0]+center[0],vector[1]+center[1],strokeColor,lineWidth,lineType);this.shapeList.push(line)}},_getLine:function(xStart,yStart,xEnd,yEnd,strokeColor,lineWidth,lineType){return new LineShape({zlevel:this.getZlevelBase(),z:this.getZBase(),style:{xStart:xStart,yStart:yStart,xEnd:xEnd,yEnd:yEnd,strokeColor:strokeColor,lineWidth:lineWidth,lineType:lineType},hoverable:!1})},_adjustIndicatorValue:function(index){for(var max,min,opts,item=this.polar[index],indicator=this.deepQuery(this._queryTarget,"indicator"),len=indicator.length,__ecIndicator=item.__ecIndicator,data=this._getSeriesData(index),boundaryGap=item.boundaryGap,splitNumber=item.splitNumber,scale=item.scale,smartSteps=require("../util/smartSteps"),i=0;len>i;i++){if("number"==typeof indicator[i].max){max=indicator[i].max;min=indicator[i].min||0;opts={max:max,min:min}}else{var value=this._findValue(data,i,splitNumber,boundaryGap);min=value.min;max=value.max}!scale&&min>=0&&max>=0&&(min=0);!scale&&0>=min&&0>=max&&(max=0);var stepOpt=smartSteps(min,max,splitNumber,opts);__ecIndicator[i].value={min:stepOpt.min,max:stepOpt.max,step:stepOpt.step}}},_getSeriesData:function(index){for(var serie,serieData,polarIndex,data=[],legend=this.component.legend,i=0;i<this.series.length;i++){serie=this.series[i];if(serie.type==ecConfig.CHART_TYPE_RADAR){serieData=serie.data||[];for(var j=0;j<serieData.length;j++){polarIndex=this.deepQuery([serieData[j],serie,this.option],"polarIndex")||0;polarIndex!=index||legend&&!legend.isSelected(serieData[j].name)||data.push(serieData[j])}}}return data},_findValue:function(data,index,splitNumber,boundaryGap){function _compare(item){(item>max||void 0===max)&&(max=item);(min>item||void 0===min)&&(min=item)}var max,min,one;if(data&&0!==data.length){1==data.length&&(min=0);if(1!=data.length)for(var i=0;i<data.length;i++)_compare(this.getDataFromOption(data[i].value[index]));else{one=data[0];for(var i=0;i<one.value.length;i++)_compare(this.getDataFromOption(one.value[i]))}var gap=Math.abs(max-min);min-=Math.abs(gap*boundaryGap[0]);max+=Math.abs(gap*boundaryGap[1]);min===max&&(0===max?max=1:max>0?min=max/splitNumber:max/=splitNumber);return{max:max,min:min}}},getVector:function(polarIndex,indicatorIndex,value){polarIndex=polarIndex||0;indicatorIndex=indicatorIndex||0;var __ecIndicator=this.polar[polarIndex].__ecIndicator;if(!(indicatorIndex>=__ecIndicator.length)){var alpha,indicator=this.polar[polarIndex].__ecIndicator[indicatorIndex],center=this.getCenter(polarIndex),vector=indicator.vector,max=indicator.value.max,min=indicator.value.min;if("undefined"==typeof value)return center;switch(value){case"min":value=min;break;case"max":value=max;break;case"center":value=(max+min)/2}alpha=max!=min?(value-min)/(max-min):.5;return this._mapVector(vector,center,alpha)}},isInside:function(vector){var polar=this.getNearestIndex(vector);return polar?polar.polarIndex:-1},getNearestIndex:function(vector){for(var item,center,radius,polarVector,startAngle,indicator,len,angle,finalAngle,i=0;i<this.polar.length;i++){item=this.polar[i];center=this.getCenter(i);if(vector[0]==center[0]&&vector[1]==center[1])return{polarIndex:i,valueIndex:0};radius=this._getRadius();startAngle=item.startAngle;indicator=item.indicator;len=indicator.length;angle=2*Math.PI/len;polarVector=ecCoordinates.cartesian2polar(vector[0]-center[0],center[1]-vector[1]);vector[0]-center[0]<0&&(polarVector[1]+=Math.PI);polarVector[1]<0&&(polarVector[1]+=2*Math.PI);finalAngle=polarVector[1]-startAngle/180*Math.PI+2*Math.PI;if(Math.abs(Math.cos(finalAngle%(angle/2)))*radius>polarVector[0])return{polarIndex:i,valueIndex:Math.floor((finalAngle+angle/2)/angle)%len}}},getIndicator:function(index){var index=index||0;return this.polar[index].indicator},refresh:function(newOption){if(newOption){this.option=newOption;this.polar=this.option.polar;this.series=this.option.series}this.clear();this._buildShape()}};zrUtil.inherits(Polar,Base);require("../component").define("polar",Polar);return Polar});